{"ast":null,"code":"import _asyncToGenerator from \"/Users/dev/Documents/Projects/Schlosswochen-Inscription/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _awaitAsyncGenerator from \"/Users/dev/Documents/Projects/Schlosswochen-Inscription/node_modules/@babel/runtime/helpers/esm/awaitAsyncGenerator.js\";\nimport _wrapAsyncGenerator from \"/Users/dev/Documents/Projects/Schlosswochen-Inscription/node_modules/@babel/runtime/helpers/esm/wrapAsyncGenerator.js\";\nimport _asyncIterator from \"/Users/dev/Documents/Projects/Schlosswochen-Inscription/node_modules/@babel/runtime/helpers/esm/asyncIterator.js\";\nimport { EJSON, ObjectId } from 'bson';\nimport * as bson from 'bson';\nexport { bson as BSON };\n\nvar __spreadArray = undefined && undefined.__spreadArray || function (to, from, pack) {\n  if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\n    if (ar || !(i in from)) {\n      if (!ar) ar = Array.prototype.slice.call(from, 0, i);\n      ar[i] = from[i];\n    }\n  }\n  return to.concat(ar || Array.prototype.slice.call(from));\n};\n\nvar BrowserInfo =\n/** @class */\nfunction () {\n  function BrowserInfo(name, version, os) {\n    this.name = name;\n    this.version = version;\n    this.os = os;\n    this.type = 'browser';\n  }\n\n  return BrowserInfo;\n}();\n\nvar NodeInfo =\n/** @class */\nfunction () {\n  function NodeInfo(version) {\n    this.version = version;\n    this.type = 'node';\n    this.name = 'node';\n    this.os = process.platform;\n  }\n\n  return NodeInfo;\n}();\n\nvar SearchBotDeviceInfo =\n/** @class */\nfunction () {\n  function SearchBotDeviceInfo(name, version, os, bot) {\n    this.name = name;\n    this.version = version;\n    this.os = os;\n    this.bot = bot;\n    this.type = 'bot-device';\n  }\n\n  return SearchBotDeviceInfo;\n}();\n\nvar BotInfo =\n/** @class */\nfunction () {\n  function BotInfo() {\n    this.type = 'bot';\n    this.bot = true; // NOTE: deprecated test name instead\n\n    this.name = 'bot';\n    this.version = null;\n    this.os = null;\n  }\n\n  return BotInfo;\n}();\n\nvar ReactNativeInfo =\n/** @class */\nfunction () {\n  function ReactNativeInfo() {\n    this.type = 'react-native';\n    this.name = 'react-native';\n    this.version = null;\n    this.os = null;\n  }\n\n  return ReactNativeInfo;\n}(); // tslint:disable-next-line:max-line-length\n\n\nvar SEARCHBOX_UA_REGEX = /alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/;\nvar SEARCHBOT_OS_REGEX = /(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\\ Jeeves\\/Teoma|ia_archiver)/;\nvar REQUIRED_VERSION_PARTS = 3;\nvar userAgentRules = [['aol', /AOLShield\\/([0-9\\._]+)/], ['edge', /Edge\\/([0-9\\._]+)/], ['edge-ios', /EdgiOS\\/([0-9\\._]+)/], ['yandexbrowser', /YaBrowser\\/([0-9\\._]+)/], ['kakaotalk', /KAKAOTALK\\s([0-9\\.]+)/], ['samsung', /SamsungBrowser\\/([0-9\\.]+)/], ['silk', /\\bSilk\\/([0-9._-]+)\\b/], ['miui', /MiuiBrowser\\/([0-9\\.]+)$/], ['beaker', /BeakerBrowser\\/([0-9\\.]+)/], ['edge-chromium', /EdgA?\\/([0-9\\.]+)/], ['chromium-webview', /(?!Chrom.*OPR)wv\\).*Chrom(?:e|ium)\\/([0-9\\.]+)(:?\\s|$)/], ['chrome', /(?!Chrom.*OPR)Chrom(?:e|ium)\\/([0-9\\.]+)(:?\\s|$)/], ['phantomjs', /PhantomJS\\/([0-9\\.]+)(:?\\s|$)/], ['crios', /CriOS\\/([0-9\\.]+)(:?\\s|$)/], ['firefox', /Firefox\\/([0-9\\.]+)(?:\\s|$)/], ['fxios', /FxiOS\\/([0-9\\.]+)/], ['opera-mini', /Opera Mini.*Version\\/([0-9\\.]+)/], ['opera', /Opera\\/([0-9\\.]+)(?:\\s|$)/], ['opera', /OPR\\/([0-9\\.]+)(:?\\s|$)/], ['ie', /Trident\\/7\\.0.*rv\\:([0-9\\.]+).*\\).*Gecko$/], ['ie', /MSIE\\s([0-9\\.]+);.*Trident\\/[4-7].0/], ['ie', /MSIE\\s(7\\.0)/], ['bb10', /BB10;\\sTouch.*Version\\/([0-9\\.]+)/], ['android', /Android\\s([0-9\\.]+)/], ['ios', /Version\\/([0-9\\._]+).*Mobile.*Safari.*/], ['safari', /Version\\/([0-9\\._]+).*Safari/], ['facebook', /FB[AS]V\\/([0-9\\.]+)/], ['instagram', /Instagram\\s([0-9\\.]+)/], ['ios-webview', /AppleWebKit\\/([0-9\\.]+).*Mobile/], ['ios-webview', /AppleWebKit\\/([0-9\\.]+).*Gecko\\)$/], ['curl', /^curl\\/([0-9\\.]+)$/], ['searchbot', SEARCHBOX_UA_REGEX]];\nvar operatingSystemRules = [['iOS', /iP(hone|od|ad)/], ['Android OS', /Android/], ['BlackBerry OS', /BlackBerry|BB10/], ['Windows Mobile', /IEMobile/], ['Amazon OS', /Kindle/], ['Windows 3.11', /Win16/], ['Windows 95', /(Windows 95)|(Win95)|(Windows_95)/], ['Windows 98', /(Windows 98)|(Win98)/], ['Windows 2000', /(Windows NT 5.0)|(Windows 2000)/], ['Windows XP', /(Windows NT 5.1)|(Windows XP)/], ['Windows Server 2003', /(Windows NT 5.2)/], ['Windows Vista', /(Windows NT 6.0)/], ['Windows 7', /(Windows NT 6.1)/], ['Windows 8', /(Windows NT 6.2)/], ['Windows 8.1', /(Windows NT 6.3)/], ['Windows 10', /(Windows NT 10.0)/], ['Windows ME', /Windows ME/], ['Open BSD', /OpenBSD/], ['Sun OS', /SunOS/], ['Chrome OS', /CrOS/], ['Linux', /(Linux)|(X11)/], ['Mac OS', /(Mac_PowerPC)|(Macintosh)/], ['QNX', /QNX/], ['BeOS', /BeOS/], ['OS/2', /OS\\/2/]];\n\nfunction detect(userAgent) {\n  if (!!userAgent) {\n    return parseUserAgent(userAgent);\n  }\n\n  if (typeof document === 'undefined' && typeof navigator !== 'undefined' && navigator.product === 'ReactNative') {\n    return new ReactNativeInfo();\n  }\n\n  if (typeof navigator !== 'undefined') {\n    return parseUserAgent(navigator.userAgent);\n  }\n\n  return getNodeVersion();\n}\n\nfunction matchUserAgent(ua) {\n  // opted for using reduce here rather than Array#first with a regex.test call\n  // this is primarily because using the reduce we only perform the regex\n  // execution once rather than once for the test and for the exec again below\n  // probably something that needs to be benchmarked though\n  return ua !== '' && userAgentRules.reduce(function (matched, _a) {\n    var browser = _a[0],\n        regex = _a[1];\n\n    if (matched) {\n      return matched;\n    }\n\n    var uaMatch = regex.exec(ua);\n    return !!uaMatch && [browser, uaMatch];\n  }, false);\n}\n\nfunction parseUserAgent(ua) {\n  var matchedRule = matchUserAgent(ua);\n\n  if (!matchedRule) {\n    return null;\n  }\n\n  var name = matchedRule[0],\n      match = matchedRule[1];\n\n  if (name === 'searchbot') {\n    return new BotInfo();\n  } // Do not use RegExp for split operation as some browser do not support it (See: http://blog.stevenlevithan.com/archives/cross-browser-split)\n\n\n  var versionParts = match[1] && match[1].split('.').join('_').split('_').slice(0, 3);\n\n  if (versionParts) {\n    if (versionParts.length < REQUIRED_VERSION_PARTS) {\n      versionParts = __spreadArray(__spreadArray([], versionParts, true), createVersionParts(REQUIRED_VERSION_PARTS - versionParts.length), true);\n    }\n  } else {\n    versionParts = [];\n  }\n\n  var version = versionParts.join('.');\n  var os = detectOS(ua);\n  var searchBotMatch = SEARCHBOT_OS_REGEX.exec(ua);\n\n  if (searchBotMatch && searchBotMatch[1]) {\n    return new SearchBotDeviceInfo(name, version, os, searchBotMatch[1]);\n  }\n\n  return new BrowserInfo(name, version, os);\n}\n\nfunction detectOS(ua) {\n  for (var ii = 0, count = operatingSystemRules.length; ii < count; ii++) {\n    var _a = operatingSystemRules[ii],\n        os = _a[0],\n        regex = _a[1];\n    var match = regex.exec(ua);\n\n    if (match) {\n      return os;\n    }\n  }\n\n  return null;\n}\n\nfunction getNodeVersion() {\n  var isNode = typeof process !== 'undefined' && process.version;\n  return isNode ? new NodeInfo(process.version.slice(1)) : null;\n}\n\nfunction createVersionParts(count) {\n  var output = [];\n\n  for (var ii = 0; ii < count; ii++) {\n    output.push('0');\n  }\n\n  return output;\n} ////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n\n\nclass DefaultNetworkTransport {\n  constructor() {\n    if (!DefaultNetworkTransport.fetch) {\n      throw new Error(\"DefaultNetworkTransport.fetch must be set before it's used\");\n    }\n\n    if (!DefaultNetworkTransport.AbortController) {\n      throw new Error(\"DefaultNetworkTransport.AbortController must be set before it's used\");\n    }\n  }\n\n  fetchWithCallbacks(request, handler) {\n    // tslint:disable-next-line: no-console\n    this.fetch(request).then( /*#__PURE__*/function () {\n      var _ref = _asyncToGenerator(function* (response) {\n        const decodedBody = yield response.text(); // Pull out the headers of the response\n\n        const responseHeaders = {};\n        response.headers.forEach((value, key) => {\n          responseHeaders[key] = value;\n        });\n        return {\n          statusCode: response.status,\n          headers: responseHeaders,\n          body: decodedBody\n        };\n      });\n\n      return function (_x) {\n        return _ref.apply(this, arguments);\n      };\n    }()).then(r => handler.onSuccess(r)).catch(e => handler.onError(e));\n  }\n\n  fetch(request) {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      const {\n        timeoutMs,\n        url,\n        ...rest\n      } = request;\n\n      const {\n        signal,\n        cancelTimeout\n      } = _this2.createTimeoutSignal(timeoutMs);\n\n      try {\n        // We'll await the response to catch throw our own error\n        return yield DefaultNetworkTransport.fetch(url, {\n          signal,\n          ...rest\n        });\n      } finally {\n        // Whatever happens, cancel any timeout\n        cancelTimeout();\n      }\n    })();\n  }\n\n  createTimeoutSignal(timeoutMs) {\n    if (typeof timeoutMs === \"number\") {\n      const controller = new DefaultNetworkTransport.AbortController(); // Call abort after a specific number of milliseconds\n\n      const timeout = setTimeout(() => {\n        controller.abort();\n      }, timeoutMs);\n      return {\n        signal: controller.signal,\n        cancelTimeout: () => {\n          clearTimeout(timeout);\n        }\n      };\n    } else {\n      return {\n        signal: undefined,\n        cancelTimeout: () => {\n          /* No-op */\n        }\n      };\n    }\n  }\n\n}\n\nDefaultNetworkTransport.DEFAULT_HEADERS = {\n  \"Content-Type\": \"application/json\"\n}; ////////////////////////////////////////////////////////////////////////////\n\nDefaultNetworkTransport.fetch = globalThis.fetch.bind(globalThis);\nDefaultNetworkTransport.AbortController = globalThis.AbortController;\n/**\n *  base64.ts\n *\n *  Licensed under the BSD 3-Clause License.\n *    http://opensource.org/licenses/BSD-3-Clause\n *\n *  References:\n *    http://en.wikipedia.org/wiki/Base64\n *\n * @author Dan Kogai (https://github.com/dankogai)\n */\n\nconst version = '3.7.2';\n/**\n * @deprecated use lowercase `version`.\n */\n\nconst VERSION = version;\n\nconst _hasatob = typeof atob === 'function';\n\nconst _hasbtoa = typeof btoa === 'function';\n\nconst _hasBuffer = typeof Buffer === 'function';\n\nconst _TD = typeof TextDecoder === 'function' ? new TextDecoder() : undefined;\n\nconst _TE = typeof TextEncoder === 'function' ? new TextEncoder() : undefined;\n\nconst b64ch = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';\nconst b64chs = Array.prototype.slice.call(b64ch);\n\nconst b64tab = (a => {\n  let tab = {};\n  a.forEach((c, i) => tab[c] = i);\n  return tab;\n})(b64chs);\n\nconst b64re = /^(?:[A-Za-z\\d+\\/]{4})*?(?:[A-Za-z\\d+\\/]{2}(?:==)?|[A-Za-z\\d+\\/]{3}=?)?$/;\n\nconst _fromCC = String.fromCharCode.bind(String);\n\nconst _U8Afrom = typeof Uint8Array.from === 'function' ? Uint8Array.from.bind(Uint8Array) : (it, fn = x => x) => new Uint8Array(Array.prototype.slice.call(it, 0).map(fn));\n\nconst _mkUriSafe = src => src.replace(/=/g, '').replace(/[+\\/]/g, m0 => m0 == '+' ? '-' : '_');\n\nconst _tidyB64 = s => s.replace(/[^A-Za-z0-9\\+\\/]/g, '');\n/**\n * polyfill version of `btoa`\n */\n\n\nconst btoaPolyfill = bin => {\n  // console.log('polyfilled');\n  let u32,\n      c0,\n      c1,\n      c2,\n      asc = '';\n  const pad = bin.length % 3;\n\n  for (let i = 0; i < bin.length;) {\n    if ((c0 = bin.charCodeAt(i++)) > 255 || (c1 = bin.charCodeAt(i++)) > 255 || (c2 = bin.charCodeAt(i++)) > 255) throw new TypeError('invalid character found');\n    u32 = c0 << 16 | c1 << 8 | c2;\n    asc += b64chs[u32 >> 18 & 63] + b64chs[u32 >> 12 & 63] + b64chs[u32 >> 6 & 63] + b64chs[u32 & 63];\n  }\n\n  return pad ? asc.slice(0, pad - 3) + \"===\".substring(pad) : asc;\n};\n/**\n * does what `window.btoa` of web browsers do.\n * @param {String} bin binary string\n * @returns {string} Base64-encoded string\n */\n\n\nconst _btoa = _hasbtoa ? bin => btoa(bin) : _hasBuffer ? bin => Buffer.from(bin, 'binary').toString('base64') : btoaPolyfill;\n\nconst _fromUint8Array = _hasBuffer ? u8a => Buffer.from(u8a).toString('base64') : u8a => {\n  // cf. https://stackoverflow.com/questions/12710001/how-to-convert-uint8-array-to-base64-encoded-string/12713326#12713326\n  const maxargs = 0x1000;\n  let strs = [];\n\n  for (let i = 0, l = u8a.length; i < l; i += maxargs) {\n    strs.push(_fromCC.apply(null, u8a.subarray(i, i + maxargs)));\n  }\n\n  return _btoa(strs.join(''));\n};\n/**\n * converts a Uint8Array to a Base64 string.\n * @param {boolean} [urlsafe] URL-and-filename-safe a la RFC4648 ยง5\n * @returns {string} Base64 string\n */\n\n\nconst fromUint8Array = (u8a, urlsafe = false) => urlsafe ? _mkUriSafe(_fromUint8Array(u8a)) : _fromUint8Array(u8a); // This trick is found broken https://github.com/dankogai/js-base64/issues/130\n// const utob = (src: string) => unescape(encodeURIComponent(src));\n// reverting good old fationed regexp\n\n\nconst cb_utob = c => {\n  if (c.length < 2) {\n    var cc = c.charCodeAt(0);\n    return cc < 0x80 ? c : cc < 0x800 ? _fromCC(0xc0 | cc >>> 6) + _fromCC(0x80 | cc & 0x3f) : _fromCC(0xe0 | cc >>> 12 & 0x0f) + _fromCC(0x80 | cc >>> 6 & 0x3f) + _fromCC(0x80 | cc & 0x3f);\n  } else {\n    var cc = 0x10000 + (c.charCodeAt(0) - 0xD800) * 0x400 + (c.charCodeAt(1) - 0xDC00);\n    return _fromCC(0xf0 | cc >>> 18 & 0x07) + _fromCC(0x80 | cc >>> 12 & 0x3f) + _fromCC(0x80 | cc >>> 6 & 0x3f) + _fromCC(0x80 | cc & 0x3f);\n  }\n};\n\nconst re_utob = /[\\uD800-\\uDBFF][\\uDC00-\\uDFFFF]|[^\\x00-\\x7F]/g;\n/**\n * @deprecated should have been internal use only.\n * @param {string} src UTF-8 string\n * @returns {string} UTF-16 string\n */\n\nconst utob = u => u.replace(re_utob, cb_utob); //\n\n\nconst _encode = _hasBuffer ? s => Buffer.from(s, 'utf8').toString('base64') : _TE ? s => _fromUint8Array(_TE.encode(s)) : s => _btoa(utob(s));\n/**\n * converts a UTF-8-encoded string to a Base64 string.\n * @param {boolean} [urlsafe] if `true` make the result URL-safe\n * @returns {string} Base64 string\n */\n\n\nconst encode = (src, urlsafe = false) => urlsafe ? _mkUriSafe(_encode(src)) : _encode(src);\n/**\n * converts a UTF-8-encoded string to URL-safe Base64 RFC4648 ยง5.\n * @returns {string} Base64 string\n */\n\n\nconst encodeURI = src => encode(src, true); // This trick is found broken https://github.com/dankogai/js-base64/issues/130\n// const btou = (src: string) => decodeURIComponent(escape(src));\n// reverting good old fationed regexp\n\n\nconst re_btou = /[\\xC0-\\xDF][\\x80-\\xBF]|[\\xE0-\\xEF][\\x80-\\xBF]{2}|[\\xF0-\\xF7][\\x80-\\xBF]{3}/g;\n\nconst cb_btou = cccc => {\n  switch (cccc.length) {\n    case 4:\n      var cp = (0x07 & cccc.charCodeAt(0)) << 18 | (0x3f & cccc.charCodeAt(1)) << 12 | (0x3f & cccc.charCodeAt(2)) << 6 | 0x3f & cccc.charCodeAt(3),\n          offset = cp - 0x10000;\n      return _fromCC((offset >>> 10) + 0xD800) + _fromCC((offset & 0x3FF) + 0xDC00);\n\n    case 3:\n      return _fromCC((0x0f & cccc.charCodeAt(0)) << 12 | (0x3f & cccc.charCodeAt(1)) << 6 | 0x3f & cccc.charCodeAt(2));\n\n    default:\n      return _fromCC((0x1f & cccc.charCodeAt(0)) << 6 | 0x3f & cccc.charCodeAt(1));\n  }\n};\n/**\n * @deprecated should have been internal use only.\n * @param {string} src UTF-16 string\n * @returns {string} UTF-8 string\n */\n\n\nconst btou = b => b.replace(re_btou, cb_btou);\n/**\n * polyfill version of `atob`\n */\n\n\nconst atobPolyfill = asc => {\n  // console.log('polyfilled');\n  asc = asc.replace(/\\s+/g, '');\n  if (!b64re.test(asc)) throw new TypeError('malformed base64.');\n  asc += '=='.slice(2 - (asc.length & 3));\n  let u24,\n      bin = '',\n      r1,\n      r2;\n\n  for (let i = 0; i < asc.length;) {\n    u24 = b64tab[asc.charAt(i++)] << 18 | b64tab[asc.charAt(i++)] << 12 | (r1 = b64tab[asc.charAt(i++)]) << 6 | (r2 = b64tab[asc.charAt(i++)]);\n    bin += r1 === 64 ? _fromCC(u24 >> 16 & 255) : r2 === 64 ? _fromCC(u24 >> 16 & 255, u24 >> 8 & 255) : _fromCC(u24 >> 16 & 255, u24 >> 8 & 255, u24 & 255);\n  }\n\n  return bin;\n};\n/**\n * does what `window.atob` of web browsers do.\n * @param {String} asc Base64-encoded string\n * @returns {string} binary string\n */\n\n\nconst _atob = _hasatob ? asc => atob(_tidyB64(asc)) : _hasBuffer ? asc => Buffer.from(asc, 'base64').toString('binary') : atobPolyfill; //\n\n\nconst _toUint8Array = _hasBuffer ? a => _U8Afrom(Buffer.from(a, 'base64')) : a => _U8Afrom(_atob(a), c => c.charCodeAt(0));\n/**\n * converts a Base64 string to a Uint8Array.\n */\n\n\nconst toUint8Array = a => _toUint8Array(_unURI(a)); //\n\n\nconst _decode = _hasBuffer ? a => Buffer.from(a, 'base64').toString('utf8') : _TD ? a => _TD.decode(_toUint8Array(a)) : a => btou(_atob(a));\n\nconst _unURI = a => _tidyB64(a.replace(/[-_]/g, m0 => m0 == '-' ? '+' : '/'));\n/**\n * converts a Base64 string to a UTF-8 string.\n * @param {String} src Base64 string.  Both normal and URL-safe are supported\n * @returns {string} UTF-8 string\n */\n\n\nconst decode = src => _decode(_unURI(src));\n/**\n * check if a value is a valid Base64 string\n * @param {String} src a value to check\n  */\n\n\nconst isValid = src => {\n  if (typeof src !== 'string') return false;\n  const s = src.replace(/\\s+/g, '').replace(/={0,2}$/, '');\n  return !/[^\\s0-9a-zA-Z\\+/]/.test(s) || !/[^\\s0-9a-zA-Z\\-_]/.test(s);\n}; //\n\n\nconst _noEnum = v => {\n  return {\n    value: v,\n    enumerable: false,\n    writable: true,\n    configurable: true\n  };\n};\n/**\n * extend String.prototype with relevant methods\n */\n\n\nconst extendString = function () {\n  const _add = (name, body) => Object.defineProperty(String.prototype, name, _noEnum(body));\n\n  _add('fromBase64', function () {\n    return decode(this);\n  });\n\n  _add('toBase64', function (urlsafe) {\n    return encode(this, urlsafe);\n  });\n\n  _add('toBase64URI', function () {\n    return encode(this, true);\n  });\n\n  _add('toBase64URL', function () {\n    return encode(this, true);\n  });\n\n  _add('toUint8Array', function () {\n    return toUint8Array(this);\n  });\n};\n/**\n * extend Uint8Array.prototype with relevant methods\n */\n\n\nconst extendUint8Array = function () {\n  const _add = (name, body) => Object.defineProperty(Uint8Array.prototype, name, _noEnum(body));\n\n  _add('toBase64', function (urlsafe) {\n    return fromUint8Array(this, urlsafe);\n  });\n\n  _add('toBase64URI', function () {\n    return fromUint8Array(this, true);\n  });\n\n  _add('toBase64URL', function () {\n    return fromUint8Array(this, true);\n  });\n};\n/**\n * extend Builtin prototypes with relevant methods\n */\n\n\nconst extendBuiltins = () => {\n  extendString();\n  extendUint8Array();\n};\n\nconst gBase64 = {\n  version: version,\n  VERSION: VERSION,\n  atob: _atob,\n  atobPolyfill: atobPolyfill,\n  btoa: _btoa,\n  btoaPolyfill: btoaPolyfill,\n  fromBase64: decode,\n  toBase64: encode,\n  encode: encode,\n  encodeURI: encodeURI,\n  encodeURL: encodeURI,\n  utob: utob,\n  btou: btou,\n  decode: decode,\n  isValid: isValid,\n  fromUint8Array: fromUint8Array,\n  toUint8Array: toUint8Array,\n  extendString: extendString,\n  extendUint8Array: extendUint8Array,\n  extendBuiltins: extendBuiltins\n}; ////////////////////////////////////////////////////////////////////////////\n\nconst SERIALIZATION_OPTIONS = {\n  relaxed: false // Ensure Canonical mode\n\n};\n/**\n * Serialize an object containing BSON types into extended-JSON.\n *\n * @param obj The object containing BSON types.\n * @returns The document in extended-JSON format.\n */\n\nfunction serialize(obj) {\n  return EJSON.serialize(obj, SERIALIZATION_OPTIONS);\n}\n/**\n * De-serialize an object or an array of object from extended-JSON into an object or an array of object with BSON types.\n *\n * @param obj The object or array of objects in extended-JSON format.\n * @returns The object or array of objects with inflated BSON types.\n */\n\n\nfunction deserialize(obj) {\n  if (Array.isArray(obj)) {\n    return obj.map(doc => EJSON.deserialize(doc));\n  } else {\n    return EJSON.deserialize(obj);\n  }\n} ////////////////////////////////////////////////////////////////////////////\n\n/**\n * The type of a user.\n */\n\n\nvar UserType;\n\n(function (UserType) {\n  /**\n   * A normal end-user created this user.\n   */\n  UserType[\"Normal\"] = \"normal\";\n  /**\n   * The user was created by the server.\n   */\n\n  UserType[\"Server\"] = \"server\";\n})(UserType || (UserType = {}));\n/** @ignore */\n\n\nvar DataKey;\n\n(function (DataKey) {\n  /** @ignore */\n  DataKey[\"NAME\"] = \"name\";\n  /** @ignore */\n\n  DataKey[\"EMAIL\"] = \"email\";\n  /** @ignore */\n\n  DataKey[\"PICTURE\"] = \"picture\";\n  /** @ignore */\n\n  DataKey[\"FIRST_NAME\"] = \"first_name\";\n  /** @ignore */\n\n  DataKey[\"LAST_NAME\"] = \"last_name\";\n  /** @ignore */\n\n  DataKey[\"GENDER\"] = \"gender\";\n  /** @ignore */\n\n  DataKey[\"BIRTHDAY\"] = \"birthday\";\n  /** @ignore */\n\n  DataKey[\"MIN_AGE\"] = \"min_age\";\n  /** @ignore */\n\n  DataKey[\"MAX_AGE\"] = \"max_age\";\n})(DataKey || (DataKey = {}));\n\nconst DATA_MAPPING = {\n  [DataKey.NAME]: \"name\",\n  [DataKey.EMAIL]: \"email\",\n  [DataKey.PICTURE]: \"pictureUrl\",\n  [DataKey.FIRST_NAME]: \"firstName\",\n  [DataKey.LAST_NAME]: \"lastName\",\n  [DataKey.GENDER]: \"gender\",\n  [DataKey.BIRTHDAY]: \"birthday\",\n  [DataKey.MIN_AGE]: \"minAge\",\n  [DataKey.MAX_AGE]: \"maxAge\"\n};\n/** @inheritdoc */\n\nclass UserProfile {\n  /**\n   * @param response The response of a call fetching the users profile.\n   */\n  constructor(response) {\n    /** @ignore */\n    this.type = UserType.Normal;\n    /** @ignore */\n\n    this.identities = [];\n\n    if (typeof response === \"object\" && response !== null) {\n      const {\n        type,\n        identities,\n        data\n      } = response;\n\n      if (typeof type === \"string\") {\n        this.type = type;\n      } else {\n        throw new Error(\"Expected 'type' in the response body\");\n      }\n\n      if (Array.isArray(identities)) {\n        this.identities = identities.map(identity => {\n          const {\n            id,\n            provider_type: providerType\n          } = identity;\n          return {\n            id,\n            providerType\n          };\n        });\n      } else {\n        throw new Error(\"Expected 'identities' in the response body\");\n      }\n\n      if (typeof data === \"object\" && data !== null) {\n        const mappedData = Object.fromEntries(Object.entries(data).map(([key, value]) => {\n          if (key in DATA_MAPPING) {\n            // Translate any known data field to its JS idiomatic alias\n            return [DATA_MAPPING[key], value];\n          } else {\n            // Pass through any other values\n            return [key, value];\n          }\n        })); // We can use `any` since we trust the user supplies the correct type\n\n        this.data = deserialize(mappedData);\n      } else {\n        throw new Error(\"Expected 'data' in the response body\");\n      }\n    } else {\n      this.data = {};\n    }\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n\n/**\n * A `Storage` which will prefix a key part to every operation.\n */\n\n\nclass PrefixedStorage {\n  /**\n   * Construct a `Storage` which will prefix a key part to every operation.\n   *\n   * @param storage The underlying storage to use for operations.\n   * @param keyPart The part of the key to prefix when performing operations.\n   */\n  constructor(storage, keyPart) {\n    this.storage = storage;\n    this.keyPart = keyPart;\n  }\n  /** @inheritdoc */\n\n\n  get(key) {\n    return this.storage.get(this.keyPart + PrefixedStorage.PART_SEPARATOR + key);\n  }\n  /** @inheritdoc */\n\n\n  set(key, value) {\n    return this.storage.set(this.keyPart + PrefixedStorage.PART_SEPARATOR + key, value);\n  }\n  /** @inheritdoc */\n\n\n  remove(key) {\n    return this.storage.remove(this.keyPart + PrefixedStorage.PART_SEPARATOR + key);\n  }\n  /** @inheritdoc */\n\n\n  prefix(keyPart) {\n    return new PrefixedStorage(this, keyPart);\n  }\n  /** @inheritdoc */\n\n\n  clear(prefix = \"\") {\n    return this.storage.clear(this.keyPart + PrefixedStorage.PART_SEPARATOR + prefix);\n  }\n  /** @inheritdoc */\n\n\n  addListener(listener) {\n    return this.storage.addListener(listener);\n  }\n  /** @inheritdoc */\n\n\n  removeListener(listener) {\n    return this.storage.addListener(listener);\n  }\n\n}\n/**\n * The string separating two parts.\n */\n\n\nPrefixedStorage.PART_SEPARATOR = \":\"; ////////////////////////////////////////////////////////////////////////////\n\n/**\n * In-memory storage that will not be persisted.\n */\n\nclass MemoryStorage {\n  constructor() {\n    /**\n     * Internal state of the storage.\n     */\n    this.storage = {};\n    /**\n     * A set of listners.\n     */\n\n    this.listeners = new Set();\n  }\n  /** @inheritdoc */\n\n\n  get(key) {\n    if (key in this.storage) {\n      return this.storage[key];\n    } else {\n      return null;\n    }\n  }\n  /** @inheritdoc */\n\n\n  set(key, value) {\n    this.storage[key] = value; // Fire the listeners\n\n    this.fireListeners();\n  }\n  /** @inheritdoc */\n\n\n  remove(key) {\n    delete this.storage[key]; // Fire the listeners\n\n    this.fireListeners();\n  }\n  /** @inheritdoc */\n\n\n  prefix(keyPart) {\n    return new PrefixedStorage(this, keyPart);\n  }\n  /** @inheritdoc */\n\n\n  clear(prefix) {\n    // Iterate all keys and delete their values if they have a matching prefix\n    for (const key of Object.keys(this.storage)) {\n      if (!prefix || key.startsWith(prefix)) {\n        delete this.storage[key];\n      }\n    } // Fire the listeners\n\n\n    this.fireListeners();\n  }\n  /** @inheritdoc */\n\n\n  addListener(listener) {\n    this.listeners.add(listener);\n  }\n  /** @inheritdoc */\n\n\n  removeListener(listener) {\n    this.listeners.delete(listener);\n  }\n  /**\n   * Tell the listeners that a change occurred.\n   */\n\n\n  fireListeners() {\n    this.listeners.forEach(listener => listener());\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n\n\nconst ACCESS_TOKEN_STORAGE_KEY = \"accessToken\";\nconst REFRESH_TOKEN_STORAGE_KEY = \"refreshToken\";\nconst PROFILE_STORAGE_KEY = \"profile\";\nconst PROVIDER_TYPE_STORAGE_KEY = \"providerType\";\n/**\n * Storage specific to the app.\n */\n\nclass UserStorage extends PrefixedStorage {\n  /**\n   * Construct a storage for a `User`.\n   *\n   * @param storage The underlying storage to wrap.\n   * @param userId The id of the user.\n   */\n  constructor(storage, userId) {\n    super(storage, `user(${userId})`);\n  }\n  /**\n   * Get the access token from storage.\n   *\n   * @returns Access token (null if unknown).\n   */\n\n\n  get accessToken() {\n    return this.get(ACCESS_TOKEN_STORAGE_KEY);\n  }\n  /**\n   * Set the access token in storage.\n   *\n   * @param value Access token (null if unknown).\n   */\n\n\n  set accessToken(value) {\n    if (value === null) {\n      this.remove(ACCESS_TOKEN_STORAGE_KEY);\n    } else {\n      this.set(ACCESS_TOKEN_STORAGE_KEY, value);\n    }\n  }\n  /**\n   * Get the refresh token from storage.\n   *\n   * @returns Refresh token (null if unknown and user is logged out).\n   */\n\n\n  get refreshToken() {\n    return this.get(REFRESH_TOKEN_STORAGE_KEY);\n  }\n  /**\n   * Set the refresh token in storage.\n   *\n   * @param value Refresh token (null if unknown and user is logged out).\n   */\n\n\n  set refreshToken(value) {\n    if (value === null) {\n      this.remove(REFRESH_TOKEN_STORAGE_KEY);\n    } else {\n      this.set(REFRESH_TOKEN_STORAGE_KEY, value);\n    }\n  }\n  /**\n   * Get the user profile from storage.\n   *\n   * @returns User profile (undefined if its unknown).\n   */\n\n\n  get profile() {\n    const value = this.get(PROFILE_STORAGE_KEY);\n\n    if (value) {\n      const profile = new UserProfile(); // Patch in the values\n\n      Object.assign(profile, JSON.parse(value));\n      return profile;\n    }\n  }\n  /**\n   * Set the user profile in storage.\n   *\n   * @param value User profile (undefined if its unknown).\n   */\n\n\n  set profile(value) {\n    if (value) {\n      this.set(PROFILE_STORAGE_KEY, JSON.stringify(value));\n    } else {\n      this.remove(PROFILE_STORAGE_KEY);\n    }\n  }\n  /**\n   * Get the type of authentication provider used to authenticate\n   *\n   * @returns User profile (undefined if its unknown).\n   */\n\n\n  get providerType() {\n    const value = this.get(PROVIDER_TYPE_STORAGE_KEY);\n\n    if (value) {\n      return value;\n    }\n  }\n  /**\n   * Set the type of authentication provider used to authenticate\n   *\n   * @param value Type of authentication provider.\n   */\n\n\n  set providerType(value) {\n    if (value) {\n      this.set(PROVIDER_TYPE_STORAGE_KEY, value);\n    } else {\n      this.remove(PROVIDER_TYPE_STORAGE_KEY);\n    }\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n\n/**\n * @param obj The object to remove keys (and undefined values from)\n * @returns A new object without the keys where the value is undefined.\n */\n\n\nfunction removeKeysWithUndefinedValues(obj) {\n  return Object.fromEntries(Object.entries(obj).filter(entry => typeof entry[1] !== \"undefined\"));\n} ////////////////////////////////////////////////////////////////////////////\n\n/**\n * Generate a random sequence of characters.\n *\n * @param length The length of the string.\n * @param alphabet The alphabet of characters to pick from.\n * @returns A string of characters picked randomly from `alphabet`.\n */\n\n\nfunction generateRandomString(length, alphabet) {\n  let result = \"\";\n\n  for (let i = 0; i < length; i++) {\n    result += alphabet[Math.floor(Math.random() * alphabet.length)];\n  }\n\n  return result;\n}\n/**\n * Encode an object mapping from string to string, into a query string to be appended a URL.\n *\n * @param params The parameters to include in the string.\n * @param prefixed Should the \"?\" prefix be added if values exists?\n * @returns A URL encoded representation of the parameters (omitting a \"?\" prefix).\n */\n\n\nfunction encodeQueryString(params, prefixed = true) {\n  // Filter out undefined values\n  const cleanedParams = removeKeysWithUndefinedValues(params); // Determine if a prefixed \"?\" is appropreate\n\n  const prefix = prefixed && Object.keys(cleanedParams).length > 0 ? \"?\" : \"\"; // Transform keys and values to a query string\n\n  return prefix + Object.entries(cleanedParams).map(([k, v]) => `${k}=${encodeURIComponent(v)}`).join(\"&\");\n}\n/**\n * Decodes a query string into an object.\n *\n * @param str The query string to decode.\n * @returns The decoded query string.\n */\n\n\nfunction decodeQueryString(str) {\n  const cleanStr = str[0] === \"?\" ? str.substr(1) : str;\n  return Object.fromEntries(cleanStr.split(\"&\").filter(s => s.length > 0).map(kvp => kvp.split(\"=\")).map(([k, v]) => [k, decodeURIComponent(v)]));\n} ////////////////////////////////////////////////////////////////////////////\n\n/**\n * A list of names that functions cannot have to be callable through the functions proxy.\n */\n\n\nconst RESERVED_NAMES = [\"inspect\", \"callFunction\", \"callFunctionStreaming\", // Methods defined on the Object.prototype might be \"typeof probed\" and called by libraries and runtime environments.\n...Object.getOwnPropertyNames(Object.prototype)];\n/**\n * Remove the key for any fields with undefined values.\n *\n * @param args The arguments to clean.\n * @returns The cleaned arguments.\n */\n\nfunction cleanArgs(args) {\n  for (const arg of args) {\n    if (typeof arg === \"object\" && arg) {\n      for (const [key, value] of Object.entries(arg)) {\n        if (value === undefined) {\n          delete arg[key];\n        }\n      }\n    }\n  }\n\n  return args;\n}\n/**\n * Remove keys for any undefined values and serialize to EJSON.\n *\n * @param args The arguments to clean and serialize.\n * @returns The cleaned and serialized arguments.\n */\n\n\nfunction cleanArgsAndSerialize(args) {\n  const cleaned = cleanArgs(args);\n  return cleaned.map(arg => typeof arg === \"object\" ? serialize(arg) : arg);\n}\n/**\n * Defines how functions are called.\n */\n\n\nclass FunctionsFactory {\n  /**\n   * @param fetcher The underlying fetcher to use when sending requests.\n   * @param config Additional configuration parameters.\n   */\n  constructor(fetcher, config = {}) {\n    this.fetcher = fetcher;\n    this.serviceName = config.serviceName;\n    this.argsTransformation = config.argsTransformation || cleanArgsAndSerialize;\n  }\n  /**\n   * Create a factory of functions, wrapped in a Proxy that returns bound copies of `callFunction` on any property.\n   *\n   * @param fetcher The underlying fetcher to use when requesting.\n   * @param config Additional configuration parameters.\n   * @returns The newly created factory of functions.\n   */\n\n\n  static create(fetcher, config = {}) {\n    // Create a proxy, wrapping a simple object returning methods that calls functions\n    // TODO: Lazily fetch available functions and return these from the ownKeys() trap\n    const factory = new FunctionsFactory(fetcher, config); // Wrap the factory in a proxy that calls the internal call method\n\n    return new Proxy(factory, {\n      get(target, p, receiver) {\n        if (typeof p === \"string\" && RESERVED_NAMES.indexOf(p) === -1) {\n          return target.callFunction.bind(target, p);\n        } else {\n          const prop = Reflect.get(target, p, receiver);\n          return typeof prop === \"function\" ? prop.bind(target) : prop;\n        }\n      }\n\n    });\n  }\n  /**\n   * Call a remote function by it's name.\n   *\n   * @param name Name of the remote function.\n   * @param args Arguments to pass to the remote function.\n   * @returns A promise of the value returned when executing the remote function.\n   */\n\n\n  callFunction(name, ...args) {\n    var _this3 = this;\n\n    return _asyncToGenerator(function* () {\n      // See https://github.com/mongodb/stitch-js-sdk/blob/master/packages/core/sdk/src/services/internal/CoreStitchServiceClientImpl.ts\n      const body = {\n        name,\n        arguments: _this3.argsTransformation ? _this3.argsTransformation(args) : args\n      };\n\n      if (_this3.serviceName) {\n        body.service = _this3.serviceName;\n      }\n\n      const appRoute = _this3.fetcher.appRoute;\n      return _this3.fetcher.fetchJSON({\n        method: \"POST\",\n        path: appRoute.functionsCall().path,\n        body\n      });\n    })();\n  }\n  /**\n   * Call a remote function by it's name.\n   *\n   * @param name Name of the remote function.\n   * @param args Arguments to pass to the remote function.\n   * @returns A promise of the value returned when executing the remote function.\n   */\n\n\n  callFunctionStreaming(name, ...args) {\n    const body = {\n      name,\n      arguments: this.argsTransformation ? this.argsTransformation(args) : args\n    };\n\n    if (this.serviceName) {\n      body.service = this.serviceName;\n    }\n\n    const appRoute = this.fetcher.appRoute;\n    const qs = encodeQueryString({\n      [\"baas_request\"]: gBase64.encode(JSON.stringify(body))\n    });\n    return this.fetcher.fetchStream({\n      method: \"GET\",\n      path: appRoute.functionsCall().path + qs\n    });\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2021 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n\n/**\n * Check whether the user's app is running in \"development mode\" (e.g. `npm run dev`\n * for a React app, or `NODE_ENV=development` for a Node app). Each platform's entry\n * point should define the value of this using `setIsDevelopmentMode`.\n * The default behaviour is to always return `false`.\n *\n * @returns true if the user's app is running in development mode, false otherwise\n */\n\n\nlet isDevelopmentMode = false;\n/**\n * Set the value of `isDevelopmentMode`. This allows each entry point (node vs DOM)\n * to use its own method for determining whether we are in development mode.\n *\n * @param state A boolean indicating whether the user's app is running in\n * development mode or not.\n */\n\nconst setIsDevelopmentMode = state => {\n  isDevelopmentMode = state;\n}; ////////////////////////////////////////////////////////////////////////////\n\n/**\n * Display a deprecation warning for features being removed in the next major version\n * to users in development mode (as best as we can detect this, see `isDevelopmentMode`)\n *\n * @param deprecatedItem The method signature or name of the deprecated item\n * @param suggestedReplacement The method signature or name of the suggested replacement\n */\n\n\nconst deprecationWarning = (deprecatedItem, suggestedReplacement) => {\n  if (!isDevelopmentMode) return;\n  console.warn(`Deprecation warning from Realm: ${deprecatedItem} is deprecated and will be removed in a future major release. Consider switching to ${suggestedReplacement}.`);\n};\n/**\n * Helper function for migrating from positional arguments to a single dictionary argument.\n * Check the arguments passed to a function, if the first argument is not an object (i.e. it\n * is presumed to be a deprecated positional-style call), shows a deprecation warning and\n * converts the positional arguments into an object matching the expected \"new\" shape.\n *\n * @param args Array of arguments passed to the function (captured with `...args`).\n * @param methodName The name of the method, used to show the deprecation warning.\n * @param argNames The list of positional argument names, used to covert them into\n * an object if a deprecated call is made and to show the deprecation warning.\n * @param hasRestArgs Optional flag indicating that the function's final argument is\n * `...args` (to capture any extra arguments), in which case we capture them and return\n * as the second element of the return array.\n *\n * @returns An object containing:\n *\n * argsObject: a dictionary of function arguments, either passed through from args[0] if\n * args[0] is an object, or created from `args` and `argNames` if the args are a\n * deprecated positional argument call.\n *\n * restArgs: an array of the \"...args\" passed to the function if `hasRestArgs` is true;\n * otherwise it is `undefined`.\n */\n// Allow use of `object` type\n// eslint-disable-next-line @typescript-eslint/ban-types\n\n\nconst handleDeprecatedPositionalArgs = (args, methodName, argNames, hasRestArgs) => {\n  if (typeof args[0] !== \"object\") {\n    const restArgsText = hasRestArgs ? \", ...args\" : \"\";\n    deprecationWarning(`${methodName}(${argNames.join(\", \")}${restArgsText})`, `${methodName}({ ${argNames.join(\", \")} }${restArgsText})`); // Convert the array of arguments into a dictionary keyed by the relevant argName\n\n    const argsObject = argNames.reduce((prev, argName, index) => {\n      return { ...prev,\n        [argName]: args[index]\n      };\n    }, {});\n    const restArgs = hasRestArgs ? args.slice(argNames.length) : undefined;\n    return {\n      argsObject,\n      restArgs\n    };\n  }\n\n  return {\n    argsObject: args[0],\n    restArgs: hasRestArgs ? args.slice(1) : undefined\n  };\n}; ////////////////////////////////////////////////////////////////////////////\n// React/React Native set a global __DEV__ variable when running in dev mode\n\n\nsetIsDevelopmentMode(typeof __DEV__ !== \"undefined\" && __DEV__); ////////////////////////////////////////////////////////////////////////////\n\n/** @inheritdoc */\n\nclass EmailPasswordAuth {\n  /**\n   * Construct an interface to the email / password authentication provider.\n   *\n   * @param fetcher The underlying fetcher used to request the services.\n   * @param providerName Optional custom name of the authentication provider.\n   */\n  constructor(fetcher, providerName = \"local-userpass\") {\n    this.fetcher = fetcher;\n    this.providerName = providerName;\n  }\n\n  registerUser(...args) {\n    var _this4 = this;\n\n    return _asyncToGenerator(function* () {\n      const {\n        argsObject: userDetails\n      } = handleDeprecatedPositionalArgs(args, \"registerUser\", [\"email\", \"password\"]);\n      const appRoute = _this4.fetcher.appRoute;\n      yield _this4.fetcher.fetchJSON({\n        method: \"POST\",\n        path: appRoute.emailPasswordAuth(_this4.providerName).register().path,\n        body: userDetails\n      });\n    })();\n  }\n\n  confirmUser(...args) {\n    var _this5 = this;\n\n    return _asyncToGenerator(function* () {\n      const {\n        argsObject: tokenDetails\n      } = handleDeprecatedPositionalArgs(args, \"confirmUser\", [\"token\", \"tokenId\"]);\n      const appRoute = _this5.fetcher.appRoute;\n      yield _this5.fetcher.fetchJSON({\n        method: \"POST\",\n        path: appRoute.emailPasswordAuth(_this5.providerName).confirm().path,\n        body: tokenDetails\n      });\n    })();\n  }\n\n  resendConfirmationEmail(...args) {\n    var _this6 = this;\n\n    return _asyncToGenerator(function* () {\n      const {\n        argsObject: emailDetails\n      } = handleDeprecatedPositionalArgs(args, \"resendConfirmationEmail\", [\"email\"]);\n      const appRoute = _this6.fetcher.appRoute;\n      yield _this6.fetcher.fetchJSON({\n        method: \"POST\",\n        path: appRoute.emailPasswordAuth(_this6.providerName).confirmSend().path,\n        body: emailDetails\n      });\n    })();\n  }\n\n  retryCustomConfirmation(...args) {\n    var _this7 = this;\n\n    return _asyncToGenerator(function* () {\n      const {\n        argsObject: emailDetails\n      } = handleDeprecatedPositionalArgs(args, \"retryCustomConfirmation\", [\"email\"]);\n      const appRoute = _this7.fetcher.appRoute;\n      yield _this7.fetcher.fetchJSON({\n        method: \"POST\",\n        path: appRoute.emailPasswordAuth(_this7.providerName).confirmCall().path,\n        body: emailDetails\n      });\n    })();\n  }\n\n  resetPassword(...args) {\n    var _this8 = this;\n\n    return _asyncToGenerator(function* () {\n      const {\n        argsObject: resetDetails\n      } = handleDeprecatedPositionalArgs(args, \"resetPassword\", [\"token\", \"tokenId\", \"password\"]);\n      const appRoute = _this8.fetcher.appRoute;\n      yield _this8.fetcher.fetchJSON({\n        method: \"POST\",\n        path: appRoute.emailPasswordAuth(_this8.providerName).reset().path,\n        body: resetDetails\n      });\n    })();\n  }\n\n  sendResetPasswordEmail(...args) {\n    var _this9 = this;\n\n    return _asyncToGenerator(function* () {\n      const {\n        argsObject: emailDetails\n      } = handleDeprecatedPositionalArgs(args, \"sendResetPasswordEmail\", [\"email\"]);\n      const appRoute = _this9.fetcher.appRoute;\n      yield _this9.fetcher.fetchJSON({\n        method: \"POST\",\n        path: appRoute.emailPasswordAuth(_this9.providerName).resetSend().path,\n        body: emailDetails\n      });\n    })();\n  }\n\n  callResetPasswordFunction(...args) {\n    var _this10 = this;\n\n    return _asyncToGenerator(function* () {\n      const {\n        argsObject: resetDetails,\n        restArgs\n      } = handleDeprecatedPositionalArgs(args, \"callResetPasswordFunction\", [\"email\", \"password\"], true);\n      const appRoute = _this10.fetcher.appRoute;\n      yield _this10.fetcher.fetchJSON({\n        method: \"POST\",\n        path: appRoute.emailPasswordAuth(_this10.providerName).resetCall().path,\n        body: { ...resetDetails,\n          arguments: restArgs\n        }\n      });\n    })();\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n\n/**\n * @returns The base api route.\n */\n\n\nfunction api() {\n  return {\n    path: \"/api/client/v2.0\",\n\n    /**\n     * @param appId The id of the app.\n     * @returns The URL of the app endpoint.\n     */\n    app(appId) {\n      return {\n        path: this.path + `/app/${appId}`,\n\n        /**\n         * @returns The URL of the app location endpoint.\n         */\n        location() {\n          return {\n            path: this.path + \"/location\"\n          };\n        },\n\n        /**\n         * @param providerName The name of the provider.\n         * @returns The app url concatinated with the /auth/providers/{providerName}\n         */\n        authProvider(providerName) {\n          return {\n            path: this.path + `/auth/providers/${providerName}`,\n\n            /**\n             * @returns Get the URL of an authentication provider.\n             */\n            login() {\n              return {\n                path: this.path + \"/login\"\n              };\n            }\n\n          };\n        },\n\n        /**\n         * @param providerName The name of the provider.\n         * @returns The app url concatinated with the /auth/providers/{providerName}\n         */\n        emailPasswordAuth(providerName) {\n          const authProviderRoutes = this.authProvider(providerName);\n          return { ...authProviderRoutes,\n\n            register() {\n              return {\n                path: this.path + \"/register\"\n              };\n            },\n\n            confirm() {\n              return {\n                path: this.path + \"/confirm\"\n              };\n            },\n\n            confirmSend() {\n              return {\n                path: this.path + \"/confirm/send\"\n              };\n            },\n\n            confirmCall() {\n              return {\n                path: this.path + \"/confirm/call\"\n              };\n            },\n\n            reset() {\n              return {\n                path: this.path + \"/reset\"\n              };\n            },\n\n            resetSend() {\n              return {\n                path: this.path + \"/reset/send\"\n              };\n            },\n\n            resetCall() {\n              return {\n                path: this.path + \"/reset/call\"\n              };\n            }\n\n          };\n        },\n\n        functionsCall() {\n          return {\n            path: this.path + \"/functions/call\"\n          };\n        }\n\n      };\n    },\n\n    auth() {\n      return {\n        path: this.path + \"/auth\",\n\n        apiKeys() {\n          return {\n            path: this.path + \"/api_keys\",\n\n            key(id) {\n              return {\n                path: this.path + `/${id}`,\n\n                enable() {\n                  return {\n                    path: this.path + \"/enable\"\n                  };\n                },\n\n                disable() {\n                  return {\n                    path: this.path + \"/disable\"\n                  };\n                }\n\n              };\n            }\n\n          };\n        },\n\n        profile() {\n          return {\n            path: this.path + \"/profile\"\n          };\n        },\n\n        session() {\n          return {\n            path: this.path + \"/session\"\n          };\n        }\n\n      };\n    }\n\n  };\n}\n\nvar routes = {\n  api\n}; ////////////////////////////////////////////////////////////////////////////\n\n/** @inheritdoc */\n\nclass ApiKeyAuth {\n  /**\n   * Construct an interface to the API-key authentication provider.\n   *\n   * @param fetcher The fetcher used to send requests to services.\n   */\n  constructor(fetcher) {\n    this.fetcher = fetcher;\n  }\n  /** @inheritdoc */\n\n\n  create(name) {\n    return this.fetcher.fetchJSON({\n      method: \"POST\",\n      body: {\n        name\n      },\n      path: routes.api().auth().apiKeys().path,\n      tokenType: \"refresh\"\n    });\n  }\n  /** @inheritdoc */\n\n\n  fetch(keyId) {\n    return this.fetcher.fetchJSON({\n      method: \"GET\",\n      path: routes.api().auth().apiKeys().key(keyId).path,\n      tokenType: \"refresh\"\n    });\n  }\n  /** @inheritdoc */\n\n\n  fetchAll() {\n    return this.fetcher.fetchJSON({\n      method: \"GET\",\n      tokenType: \"refresh\",\n      path: routes.api().auth().apiKeys().path\n    });\n  }\n  /** @inheritdoc */\n\n\n  delete(keyId) {\n    var _this11 = this;\n\n    return _asyncToGenerator(function* () {\n      yield _this11.fetcher.fetchJSON({\n        method: \"DELETE\",\n        path: routes.api().auth().apiKeys().key(keyId).path,\n        tokenType: \"refresh\"\n      });\n    })();\n  }\n  /** @inheritdoc */\n\n\n  enable(keyId) {\n    var _this12 = this;\n\n    return _asyncToGenerator(function* () {\n      yield _this12.fetcher.fetchJSON({\n        method: \"PUT\",\n        path: routes.api().auth().apiKeys().key(keyId).enable().path,\n        tokenType: \"refresh\"\n      });\n    })();\n  }\n  /** @inheritdoc */\n\n\n  disable(keyId) {\n    var _this13 = this;\n\n    return _asyncToGenerator(function* () {\n      yield _this13.fetcher.fetchJSON({\n        method: \"PUT\",\n        path: routes.api().auth().apiKeys().key(keyId).disable().path,\n        tokenType: \"refresh\"\n      });\n    })();\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n\n\nlet environment = null;\n/**\n * Set the environment of execution.\n * Note: This should be called as the first thing before executing any code which calls getEnvironment()\n *\n * @param e An object containing environment specific implementations.\n */\n\nfunction setEnvironment(e) {\n  environment = e;\n}\n/**\n * Get the environment of execution.\n *\n * @returns An object containing environment specific implementations.\n */\n\n\nfunction getEnvironment() {\n  if (environment) {\n    return environment;\n  } else {\n    throw new Error(\"Cannot get environment before it's set\");\n  }\n} ////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n\n/**\n * An error occured during the parsing of a watch stream.\n */\n\n\nclass WatchError extends Error {\n  constructor({\n    message,\n    code\n  }) {\n    super(message);\n    /**\n     * The name of this type of error\n     */\n\n    this.name = \"WatchError\";\n    this.code = code;\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n// NOTE: this is a fully processed event, not a single \"data: foo\" line!\n\n/**\n * The state of a WatchStream.\n */\n\n\nvar WatchStreamState;\n\n(function (WatchStreamState) {\n  /**\n   * Need to call one of the feed functions.\n   */\n  WatchStreamState[\"NEED_DATA\"] = \"NEED_DATA\";\n  /**\n   * Call nextEvent() to consume an event.\n   */\n\n  WatchStreamState[\"HAVE_EVENT\"] = \"HAVE_EVENT\";\n  /**\n   * Call error().\n   */\n\n  WatchStreamState[\"HAVE_ERROR\"] = \"HAVE_ERROR\";\n})(WatchStreamState || (WatchStreamState = {}));\n/**\n * Represents a stream of events\n */\n\n\nclass WatchStream {\n  constructor() {\n    this._state = WatchStreamState.NEED_DATA;\n    this._error = null; // Used by feedBuffer to construct lines\n\n    this._textDecoder = new (getEnvironment().TextDecoder)();\n    this._buffer = \"\";\n    this._bufferOffset = 0; // Used by feedLine for building the next SSE\n\n    this._eventType = \"\";\n    this._dataBuffer = \"\";\n  } // Call these when you have data, in whatever shape is easiest for your SDK to get.\n  // Pick one, mixing and matching on a single instance isn't supported.\n  // These can only be called in NEED_DATA state, which is the initial state.\n\n\n  feedBuffer(buffer) {\n    this.assertState(WatchStreamState.NEED_DATA);\n    this._buffer += this._textDecoder.decode(buffer, {\n      stream: true\n    });\n    this.advanceBufferState();\n  }\n\n  feedLine(line) {\n    this.assertState(WatchStreamState.NEED_DATA); // This is an implementation of the algorithm described at\n    // https://html.spec.whatwg.org/multipage/server-sent-events.html#event-stream-interpretation.\n    // Currently the server does not use id or retry lines, so that processing isn't implemented.\n    // ignore trailing LF if not removed by SDK.\n\n    if (line.endsWith(\"\\n\")) line = line.substr(0, line.length - 1); // ignore trailing CR from CRLF\n\n    if (line.endsWith(\"\\r\")) line = line.substr(0, line.length - 1);\n\n    if (line.length === 0) {\n      // This is the \"dispatch the event\" portion of the algorithm.\n      if (this._dataBuffer.length === 0) {\n        this._eventType = \"\";\n        return;\n      }\n\n      if (this._dataBuffer.endsWith(\"\\n\")) this._dataBuffer = this._dataBuffer.substr(0, this._dataBuffer.length - 1);\n      this.feedSse({\n        data: this._dataBuffer,\n        eventType: this._eventType\n      });\n      this._dataBuffer = \"\";\n      this._eventType = \"\";\n    }\n\n    if (line[0] === \":\") return;\n    const colon = line.indexOf(\":\");\n    const field = line.substr(0, colon);\n    let value = colon === -1 ? \"\" : line.substr(colon + 1);\n    if (value.startsWith(\" \")) value = value.substr(1);\n\n    if (field === \"event\") {\n      this._eventType = value;\n    } else if (field === \"data\") {\n      this._dataBuffer += value;\n      this._dataBuffer += \"\\n\";\n    } else ;\n  }\n\n  feedSse(sse) {\n    this.assertState(WatchStreamState.NEED_DATA);\n    const firstPercentIndex = sse.data.indexOf(\"%\");\n\n    if (firstPercentIndex !== -1) {\n      // For some reason, the stich server decided to add percent-encoding for '%', '\\n', and '\\r' to its\n      // event-stream replies. But it isn't real urlencoding, since most characters pass through, so we can't use\n      // uri_percent_decode() here.\n      let buffer = \"\";\n      let start = 0;\n\n      for (let percentIndex = firstPercentIndex; percentIndex !== -1; percentIndex = sse.data.indexOf(\"%\", start)) {\n        buffer += sse.data.substr(start, percentIndex - start);\n        const encoded = sse.data.substr(percentIndex, 3); // may be smaller than 3 if string ends with %\n\n        if (encoded === \"%25\") {\n          buffer += \"%\";\n        } else if (encoded === \"%0A\") {\n          buffer += \"\\x0A\"; // '\\n'\n        } else if (encoded === \"%0D\") {\n          buffer += \"\\x0D\"; // '\\r'\n        } else {\n          buffer += encoded; // propagate as-is\n        }\n\n        start = percentIndex + encoded.length;\n      } // Advance the buffer with the last part\n\n\n      buffer += sse.data.substr(start);\n      sse.data = buffer;\n    }\n\n    if (!sse.eventType || sse.eventType === \"message\") {\n      try {\n        const parsed = EJSON.parse(sse.data);\n\n        if (typeof parsed === \"object\") {\n          // ???\n          this._nextEvent = parsed;\n          this._state = WatchStreamState.HAVE_EVENT;\n          return;\n        }\n      } catch {// fallthrough to same handling as for non-document value.\n      }\n\n      this._state = WatchStreamState.HAVE_ERROR;\n      this._error = new WatchError({\n        message: \"server returned malformed event: \" + sse.data,\n        code: \"bad bson parse\"\n      });\n    } else if (sse.eventType === \"error\") {\n      this._state = WatchStreamState.HAVE_ERROR; // default error message if we have issues parsing the reply.\n\n      this._error = new WatchError({\n        message: sse.data,\n        code: \"unknown\"\n      });\n\n      try {\n        const {\n          error_code: errorCode,\n          error\n        } = EJSON.parse(sse.data);\n        if (typeof errorCode !== \"string\") return;\n        if (typeof error !== \"string\") return; // XXX in realm-js, object-store will error if the error_code is not one of the known\n        // error code enum values.\n\n        this._error = new WatchError({\n          message: error,\n          code: errorCode\n        });\n      } catch {\n        return; // Use the default state.\n      }\n    } else ;\n  }\n\n  get state() {\n    return this._state;\n  } // Consumes the returned event. If you used feedBuffer(), there may be another event or error after this one,\n  // so you need to call state() again to see what to do next.\n\n\n  nextEvent() {\n    this.assertState(WatchStreamState.HAVE_EVENT); // We can use \"as ChangeEvent<T>\" since we just asserted the state.\n\n    const out = this._nextEvent;\n    this._state = WatchStreamState.NEED_DATA;\n    this.advanceBufferState();\n    return out;\n  } // Once this enters the error state, it stays that way. You should not feed any more data.\n\n\n  get error() {\n    return this._error;\n  } ////////////////////////////////////////////\n\n\n  advanceBufferState() {\n    this.assertState(WatchStreamState.NEED_DATA);\n\n    while (this.state === WatchStreamState.NEED_DATA) {\n      if (this._bufferOffset === this._buffer.length) {\n        this._buffer = \"\";\n        this._bufferOffset = 0;\n        return;\n      } // NOTE not supporting CR-only newlines, just LF and CRLF.\n\n\n      const nextNewlineIndex = this._buffer.indexOf(\"\\n\", this._bufferOffset);\n\n      if (nextNewlineIndex === -1) {\n        // We have a partial line.\n        if (this._bufferOffset !== 0) {\n          // Slide the partial line down to the front of the buffer.\n          this._buffer = this._buffer.substr(this._bufferOffset, this._buffer.length - this._bufferOffset);\n          this._bufferOffset = 0;\n        }\n\n        return;\n      }\n\n      this.feedLine(this._buffer.substr(this._bufferOffset, nextNewlineIndex - this._bufferOffset));\n      this._bufferOffset = nextNewlineIndex + 1; // Advance past this line, including its newline.\n    }\n  }\n\n  assertState(state) {\n    if (this._state !== state) {\n      throw Error(`Expected WatchStream to be in state ${state}, but in state ${this._state}`);\n    }\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n\n/**\n * A remote collection of documents.\n */\n\n\nclass MongoDBCollection {\n  /**\n   * Construct a remote collection of documents.\n   *\n   * @param fetcher The fetcher to use when requesting the service.\n   * @param serviceName The name of the remote service.\n   * @param databaseName The name of the database.\n   * @param collectionName The name of the remote collection.\n   */\n  constructor(fetcher, serviceName, databaseName, collectionName) {\n    this.functions = FunctionsFactory.create(fetcher, {\n      serviceName\n    });\n    this.databaseName = databaseName;\n    this.collectionName = collectionName;\n    this.serviceName = serviceName;\n    this.fetcher = fetcher;\n  }\n  /** @inheritdoc */\n\n\n  find(filter = {}, options = {}) {\n    return this.functions.find({\n      database: this.databaseName,\n      collection: this.collectionName,\n      query: filter,\n      project: options.projection,\n      sort: options.sort,\n      limit: options.limit\n    });\n  }\n  /** @inheritdoc */\n\n\n  findOne(filter = {}, options = {}) {\n    return this.functions.findOne({\n      database: this.databaseName,\n      collection: this.collectionName,\n      query: filter,\n      project: options.projection,\n      sort: options.sort\n    });\n  }\n  /** @inheritdoc */\n\n\n  findOneAndUpdate(filter = {}, update, options = {}) {\n    return this.functions.findOneAndUpdate({\n      database: this.databaseName,\n      collection: this.collectionName,\n      filter,\n      update,\n      sort: options.sort,\n      projection: options.projection,\n      upsert: options.upsert,\n      returnNewDocument: options.returnNewDocument\n    });\n  }\n  /** @inheritdoc */\n\n\n  findOneAndReplace(filter = {}, replacement, options = {}) {\n    return this.functions.findOneAndReplace({\n      database: this.databaseName,\n      collection: this.collectionName,\n      filter: filter,\n      update: replacement,\n      sort: options.sort,\n      projection: options.projection,\n      upsert: options.upsert,\n      returnNewDocument: options.returnNewDocument\n    });\n  }\n  /** @inheritdoc */\n\n\n  findOneAndDelete(filter = {}, options = {}) {\n    return this.functions.findOneAndReplace({\n      database: this.databaseName,\n      collection: this.collectionName,\n      filter,\n      sort: options.sort,\n      projection: options.projection\n    });\n  }\n  /** @inheritdoc */\n\n\n  aggregate(pipeline) {\n    return this.functions.aggregate({\n      database: this.databaseName,\n      collection: this.collectionName,\n      pipeline\n    });\n  }\n  /** @inheritdoc */\n\n\n  count(filter = {}, options = {}) {\n    return this.functions.count({\n      database: this.databaseName,\n      collection: this.collectionName,\n      query: filter,\n      limit: options.limit\n    });\n  }\n  /** @inheritdoc */\n\n\n  insertOne(document) {\n    return this.functions.insertOne({\n      database: this.databaseName,\n      collection: this.collectionName,\n      document\n    });\n  }\n  /** @inheritdoc */\n\n\n  insertMany(documents) {\n    return this.functions.insertMany({\n      database: this.databaseName,\n      collection: this.collectionName,\n      documents\n    });\n  }\n  /** @inheritdoc */\n\n\n  deleteOne(filter = {}) {\n    return this.functions.deleteOne({\n      database: this.databaseName,\n      collection: this.collectionName,\n      query: filter\n    });\n  }\n  /** @inheritdoc */\n\n\n  deleteMany(filter = {}) {\n    return this.functions.deleteMany({\n      database: this.databaseName,\n      collection: this.collectionName,\n      query: filter\n    });\n  }\n  /** @inheritdoc */\n\n\n  updateOne(filter, update, options = {}) {\n    return this.functions.updateOne({\n      database: this.databaseName,\n      collection: this.collectionName,\n      query: filter,\n      update,\n      upsert: options.upsert\n    });\n  }\n  /** @inheritdoc */\n\n\n  updateMany(filter, update, options = {}) {\n    return this.functions.updateMany({\n      database: this.databaseName,\n      collection: this.collectionName,\n      query: filter,\n      update,\n      upsert: options.upsert\n    });\n  }\n\n  watch({\n    ids,\n    filter\n  } = {}) {\n    var _this = this;\n\n    return _wrapAsyncGenerator(function* () {\n      const iterator = yield _awaitAsyncGenerator(_this.functions.callFunctionStreaming(\"watch\", {\n        database: _this.databaseName,\n        collection: _this.collectionName,\n        ids,\n        filter\n      }));\n      const watchStream = new WatchStream();\n      var _iteratorAbruptCompletion = false;\n      var _didIteratorError = false;\n\n      var _iteratorError;\n\n      try {\n        for (var _iterator = _asyncIterator(iterator), _step; _iteratorAbruptCompletion = !(_step = yield _awaitAsyncGenerator(_iterator.next())).done; _iteratorAbruptCompletion = false) {\n          const chunk = _step.value;\n          if (!chunk) continue;\n          watchStream.feedBuffer(chunk);\n\n          while (watchStream.state == WatchStreamState.HAVE_EVENT) {\n            yield watchStream.nextEvent();\n          }\n\n          if (watchStream.state == WatchStreamState.HAVE_ERROR) // XXX this is just throwing an error like {error_code: \"BadRequest, error: \"message\"},\n            // which matches realm-js, but is different from how errors are handled in realm-web\n            throw watchStream.error;\n        }\n      } catch (err) {\n        _didIteratorError = true;\n        _iteratorError = err;\n      } finally {\n        try {\n          if (_iteratorAbruptCompletion && _iterator.return != null) {\n            yield _awaitAsyncGenerator(_iterator.return());\n          }\n        } finally {\n          if (_didIteratorError) {\n            throw _iteratorError;\n          }\n        }\n      }\n    })();\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n\n/**\n * Creates an Remote MongoDB Collection.\n * Note: This method exists to enable function binding.\n *\n * @param fetcher The underlying fetcher.\n * @param serviceName A service name.\n * @param databaseName A database name.\n * @param collectionName A collection name.\n * @returns The collection.\n */\n\n\nfunction createCollection(fetcher, serviceName, databaseName, collectionName) {\n  return new MongoDBCollection(fetcher, serviceName, databaseName, collectionName);\n}\n/**\n * Creates a Remote MongoDB Database.\n * Note: This method exists to enable function binding.\n *\n * @param fetcher The underlying fetcher\n * @param serviceName A service name\n * @param databaseName A database name\n * @returns The database.\n */\n\n\nfunction createDatabase(fetcher, serviceName, databaseName) {\n  return {\n    collection: createCollection.bind(null, fetcher, serviceName, databaseName)\n  };\n}\n/**\n * Creates a Remote MongoDB Service.\n * Note: This method exists to enable function binding.\n *\n * @param fetcher The underlying fetcher.\n * @param serviceName An optional service name.\n * @returns The service.\n */\n\n\nfunction createService(fetcher, serviceName = \"mongo-db\") {\n  return {\n    db: createDatabase.bind(null, fetcher, serviceName)\n  };\n} ////////////////////////////////////////////////////////////////////////////\n\n\nconst DEFAULT_DEVICE_ID = \"000000000000000000000000\";\n/** The state of a user within the app */\n\nvar UserState;\n\n(function (UserState) {\n  /** Active, with both access and refresh tokens */\n  UserState[\"Active\"] = \"active\";\n  /** Logged out, but there might still be data persisted about the user, in the browser. */\n\n  UserState[\"LoggedOut\"] = \"logged-out\";\n  /** Logged out and all data about the user has been removed. */\n\n  UserState[\"Removed\"] = \"removed\";\n})(UserState || (UserState = {}));\n/** The type of a user. */\n\n\nvar UserType$1;\n\n(function (UserType) {\n  /** Created by the user itself. */\n  UserType[\"Normal\"] = \"normal\";\n  /** Created by an administrator of the app. */\n\n  UserType[\"Server\"] = \"server\";\n})(UserType$1 || (UserType$1 = {}));\n/**\n * Representation of an authenticated user of an app.\n */\n\n\nclass User {\n  /**\n   * @param parameters Parameters of the user.\n   */\n  constructor(parameters) {\n    this.app = parameters.app;\n    this.id = parameters.id;\n    this.storage = new UserStorage(this.app.storage, this.id);\n\n    if (\"accessToken\" in parameters && \"refreshToken\" in parameters && \"providerType\" in parameters) {\n      this._accessToken = parameters.accessToken;\n      this._refreshToken = parameters.refreshToken;\n      this.providerType = parameters.providerType; // Save the parameters to storage, for future instances to be hydrated from\n\n      this.storage.accessToken = parameters.accessToken;\n      this.storage.refreshToken = parameters.refreshToken;\n      this.storage.providerType = parameters.providerType;\n    } else {\n      // Hydrate the rest of the parameters from storage\n      this._accessToken = this.storage.accessToken;\n      this._refreshToken = this.storage.refreshToken;\n      const providerType = this.storage.providerType;\n      this._profile = this.storage.profile;\n\n      if (providerType) {\n        this.providerType = providerType;\n      } else {\n        throw new Error(\"Storage is missing a provider type\");\n      }\n    }\n\n    this.fetcher = this.app.fetcher.clone({\n      userContext: {\n        currentUser: this\n      }\n    });\n    this.apiKeys = new ApiKeyAuth(this.fetcher);\n    this.functions = FunctionsFactory.create(this.fetcher);\n  }\n  /**\n   * @returns The access token used to authenticate the user towards MongoDB Realm.\n   */\n\n\n  get accessToken() {\n    return this._accessToken;\n  }\n  /**\n   * @param token The new access token.\n   */\n\n\n  set accessToken(token) {\n    this._accessToken = token;\n    this.storage.accessToken = token;\n  }\n  /**\n   * @returns The refresh token used to issue new access tokens.\n   */\n\n\n  get refreshToken() {\n    return this._refreshToken;\n  }\n  /**\n   * @param token The new refresh token.\n   */\n\n\n  set refreshToken(token) {\n    this._refreshToken = token;\n    this.storage.refreshToken = token;\n  }\n  /**\n   * @returns The current state of the user.\n   */\n\n\n  get state() {\n    if (this.id in this.app.allUsers) {\n      return this.refreshToken === null ? UserState.LoggedOut : UserState.Active;\n    } else {\n      return UserState.Removed;\n    }\n  }\n  /**\n   * @returns The logged in state of the user.\n   */\n\n\n  get isLoggedIn() {\n    return this.state === UserState.Active;\n  }\n\n  get customData() {\n    if (this.accessToken) {\n      const decodedToken = this.decodeAccessToken();\n      return decodedToken.userData;\n    } else {\n      throw new Error(\"Cannot read custom data without an access token\");\n    }\n  }\n  /**\n   * @returns Profile containing detailed information about the user.\n   */\n\n\n  get profile() {\n    if (this._profile) {\n      return this._profile.data;\n    } else {\n      throw new Error(\"A profile was never fetched for this user\");\n    }\n  }\n\n  get identities() {\n    if (this._profile) {\n      return this._profile.identities;\n    } else {\n      throw new Error(\"A profile was never fetched for this user\");\n    }\n  }\n\n  get deviceId() {\n    if (this.accessToken) {\n      const payload = this.accessToken.split(\".\")[1];\n\n      if (payload) {\n        const parsedPayload = JSON.parse(gBase64.decode(payload));\n        const deviceId = parsedPayload[\"baas_device_id\"];\n\n        if (typeof deviceId === \"string\" && deviceId !== DEFAULT_DEVICE_ID) {\n          return deviceId;\n        }\n      }\n    }\n\n    return null;\n  }\n  /**\n   * Refresh the users profile data.\n   */\n\n\n  refreshProfile() {\n    var _this14 = this;\n\n    return _asyncToGenerator(function* () {\n      // Fetch the latest profile\n      const response = yield _this14.fetcher.fetchJSON({\n        method: \"GET\",\n        path: routes.api().auth().profile().path\n      }); // Create a profile instance\n\n      _this14._profile = new UserProfile(response); // Store this for later hydration\n\n      _this14.storage.profile = _this14._profile;\n    })();\n  }\n  /**\n   * Log out the user, invalidating the session (and its refresh token).\n   */\n\n\n  logOut() {\n    var _this15 = this;\n\n    return _asyncToGenerator(function* () {\n      // Invalidate the refresh token\n      try {\n        if (_this15._refreshToken !== null) {\n          yield _this15.fetcher.fetchJSON({\n            method: \"DELETE\",\n            path: routes.api().auth().session().path,\n            tokenType: \"refresh\"\n          });\n        }\n      } finally {\n        // Forget the access and refresh token\n        _this15.accessToken = null;\n        _this15.refreshToken = null;\n      }\n    })();\n  }\n  /** @inheritdoc */\n\n\n  linkCredentials(credentials) {\n    var _this16 = this;\n\n    return _asyncToGenerator(function* () {\n      const response = yield _this16.app.authenticator.authenticate(credentials, _this16); // Sanity check the response\n\n      if (_this16.id !== response.userId) {\n        const details = `got user id ${response.userId} expected ${_this16.id}`;\n        throw new Error(`Link response ment for another user (${details})`);\n      } // Update the access token\n\n\n      _this16.accessToken = response.accessToken; // Refresh the profile to include the new identity\n\n      yield _this16.refreshProfile();\n    })();\n  }\n  /**\n   * Request a new access token, using the refresh token.\n   */\n\n\n  refreshAccessToken() {\n    var _this17 = this;\n\n    return _asyncToGenerator(function* () {\n      const response = yield _this17.fetcher.fetchJSON({\n        method: \"POST\",\n        path: routes.api().auth().session().path,\n        tokenType: \"refresh\"\n      });\n      const {\n        access_token: accessToken\n      } = response;\n\n      if (typeof accessToken === \"string\") {\n        _this17.accessToken = accessToken;\n      } else {\n        throw new Error(\"Expected an 'access_token' in the response\");\n      }\n    })();\n  }\n  /** @inheritdoc */\n\n\n  refreshCustomData() {\n    var _this18 = this;\n\n    return _asyncToGenerator(function* () {\n      yield _this18.refreshAccessToken();\n      return _this18.customData;\n    })();\n  }\n  /** @inheritdoc */\n\n\n  callFunction(name, ...args) {\n    return this.functions.callFunction(name, ...args);\n  }\n  /**\n   * @returns A plain ol' JavaScript object representation of the user.\n   */\n\n\n  toJSON() {\n    return {\n      id: this.id,\n      accessToken: this.accessToken,\n      refreshToken: this.refreshToken,\n      profile: this._profile,\n      state: this.state,\n      customData: this.customData\n    };\n  }\n  /** @inheritdoc */\n\n\n  push() {\n    throw new Error(\"Not yet implemented\");\n  }\n  /** @inheritdoc */\n\n\n  mongoClient(serviceName) {\n    return createService(this.fetcher, serviceName);\n  }\n\n  decodeAccessToken() {\n    if (this.accessToken) {\n      // Decode and spread the token\n      const parts = this.accessToken.split(\".\");\n\n      if (parts.length !== 3) {\n        throw new Error(\"Expected an access token with three parts\");\n      } // Decode the payload\n\n\n      const encodedPayload = parts[1];\n      const decodedPayload = gBase64.decode(encodedPayload);\n      const parsedPayload = JSON.parse(decodedPayload);\n      const {\n        exp: expires,\n        iat: issuedAt,\n        sub: subject,\n        user_data: userData = {}\n      } = parsedPayload; // Validate the types\n\n      if (typeof expires !== \"number\") {\n        throw new Error(\"Failed to decode access token 'exp'\");\n      } else if (typeof issuedAt !== \"number\") {\n        throw new Error(\"Failed to decode access token 'iat'\");\n      }\n\n      return {\n        expires,\n        issuedAt,\n        subject,\n        userData\n      };\n    } else {\n      throw new Error(\"Missing an access token\");\n    }\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n// TODO: Ensure the static interface of the Credentials class implements the static interface of Realm.Credentials\n// See https://stackoverflow.com/a/43484801\n\n/**\n * Instances of this class can be passed to the `app.logIn` method to authenticate an end-user.\n */\n\n\nclass Credentials {\n  /**\n   * Constructs an instance of credentials.\n   *\n   * @param providerName The name of the authentication provider used when authenticating.\n   * @param providerType The type of the authentication provider used when authenticating.\n   * @param payload The data being sent to the service when authenticating.\n   */\n  constructor(providerName, providerType, payload) {\n    this.providerName = providerName;\n    this.providerType = providerType;\n    this.payload = payload;\n  }\n  /**\n   * Creates credentials that logs in using the [Anonymous Provider](https://docs.mongodb.com/realm/authentication/anonymous/).\n   *\n   * @returns The credentials instance, which can be passed to `app.logIn`.\n   */\n\n\n  static anonymous() {\n    return new Credentials(\"anon-user\", \"anon-user\", {});\n  }\n  /**\n   * Creates credentials that logs in using the [API Key Provider](https://docs.mongodb.com/realm/authentication/api-key/).\n   *\n   * @deprecated Use `Credentials.apiKey`.\n   * @param key The secret content of the API key.\n   * @returns The credentials instance, which can be passed to `app.logIn`.\n   */\n\n\n  static userApiKey(key) {\n    return new Credentials(\"api-key\", \"api-key\", {\n      key\n    });\n  }\n  /**\n   * Creates credentials that logs in using the [API Key Provider](https://docs.mongodb.com/realm/authentication/api-key/).\n   *\n   * @deprecated Use `Credentials.apiKey`.\n   * @param key The secret content of the API key.\n   * @returns The credentials instance, which can be passed to `app.logIn`.\n   */\n\n\n  static serverApiKey(key) {\n    return new Credentials(\"api-key\", \"api-key\", {\n      key\n    });\n  }\n  /**\n   * Creates credentials that logs in using the [API Key Provider](https://docs.mongodb.com/realm/authentication/api-key/).\n   *\n   * @param key The secret content of the API key.\n   * @returns The credentials instance, which can be passed to `app.logIn`.\n   */\n\n\n  static apiKey(key) {\n    return new Credentials(\"api-key\", \"api-key\", {\n      key\n    });\n  }\n  /**\n   * Creates credentials that logs in using the [Email/Password Provider](https://docs.mongodb.com/realm/authentication/email-password/).\n   * Note: This was formerly known as the \"Username/Password\" provider.\n   *\n   * @param email The end-users email address.\n   * @param password The end-users password.\n   * @returns The credentials instance, which can be passed to `app.logIn`.\n   */\n\n\n  static emailPassword(email, password) {\n    return new Credentials(\"local-userpass\", \"local-userpass\", {\n      username: email,\n      password\n    });\n  }\n  /**\n   * Creates credentials that logs in using the [Custom Function Provider](https://docs.mongodb.com/realm/authentication/custom-function/).\n   *\n   * @param payload The custom payload as expected by the server.\n   * @returns The credentials instance, which can be passed to `app.logIn`.\n   */\n\n\n  static function(payload) {\n    return new Credentials(\"custom-function\", \"custom-function\", payload);\n  }\n  /**\n   * Creates credentials that logs in using the [Custom JWT Provider](https://docs.mongodb.com/realm/authentication/custom-jwt/).\n   *\n   * @param token The JSON Web Token (JWT).\n   * @returns The credentials instance, which can be passed to `app.logIn`.\n   */\n\n\n  static jwt(token) {\n    return new Credentials(\"custom-token\", \"custom-token\", {\n      token\n    });\n  }\n  /**\n   * Creates credentials that logs in using the [Google Provider](https://docs.mongodb.com/realm/authentication/google/).\n   *\n   * @param payload The URL that users should be redirected to, the auth code or id token from Google.\n   * @returns The credentials instance, which can be passed to `app.logIn`.\n   */\n\n\n  static google(payload) {\n    return new Credentials(\"oauth2-google\", \"oauth2-google\", Credentials.derivePayload(payload));\n  }\n  /**\n   * @param payload The payload string.\n   * @returns A payload object based on the string.\n   */\n\n\n  static derivePayload(payload) {\n    if (typeof payload === \"string\") {\n      if (payload.includes(\"://\")) {\n        return this.derivePayload({\n          redirectUrl: payload\n        });\n      } else if (payload.startsWith(\"4/\")) {\n        return this.derivePayload({\n          authCode: payload\n        });\n      } else if (payload.startsWith(\"ey\")) {\n        return this.derivePayload({\n          idToken: payload\n        });\n      } else {\n        throw new Error(`Unexpected payload: ${payload}`);\n      }\n    } else if (Object.keys(payload).length === 1) {\n      if (\"authCode\" in payload || \"redirectUrl\" in payload) {\n        return payload;\n      } else if (\"idToken\" in payload) {\n        return {\n          id_token: payload.idToken\n        };\n      } else {\n        throw new Error(\"Unexpected payload: \" + JSON.stringify(payload));\n      }\n    } else {\n      throw new Error(\"Expected only one property in payload, got \" + JSON.stringify(payload));\n    }\n  }\n  /**\n   * Creates credentials that logs in using the [Facebook Provider](https://docs.mongodb.com/realm/authentication/facebook/).\n   *\n   * @param redirectUrlOrAccessToken The URL that users should be redirected to or the auth code returned from Facebook.\n   * @returns The credentials instance, which can be passed to `app.logIn`.\n   */\n\n\n  static facebook(redirectUrlOrAccessToken) {\n    return new Credentials(\"oauth2-facebook\", \"oauth2-facebook\", redirectUrlOrAccessToken.includes(\"://\") ? {\n      redirectUrl: redirectUrlOrAccessToken\n    } : {\n      accessToken: redirectUrlOrAccessToken\n    });\n  }\n  /**\n   * Creates credentials that logs in using the [Apple ID Provider](https://docs.mongodb.com/realm/authentication/apple/).\n   *\n   * @param redirectUrlOrIdToken The URL that users should be redirected to or the id_token returned from Apple.\n   * @returns The credentials instance, which can be passed to `app.logIn`.\n   */\n\n\n  static apple(redirectUrlOrIdToken) {\n    return new Credentials(\"oauth2-apple\", \"oauth2-apple\", redirectUrlOrIdToken.includes(\"://\") ? {\n      redirectUrl: redirectUrlOrIdToken\n    } : {\n      id_token: redirectUrlOrIdToken\n    });\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n\n\nconst USER_IDS_STORAGE_KEY = \"userIds\";\nconst DEVICE_ID_STORAGE_KEY = \"deviceId\";\n/**\n * Storage specific to the app.\n */\n\nclass AppStorage extends PrefixedStorage {\n  /**\n   * @param storage The underlying storage to wrap.\n   * @param appId The id of the app.\n   */\n  constructor(storage, appId) {\n    super(storage, `app(${appId})`);\n  }\n  /**\n   * Reads out the list of user ids from storage.\n   *\n   * @returns A list of user ids.\n   */\n\n\n  getUserIds() {\n    const userIdsString = this.get(USER_IDS_STORAGE_KEY);\n    const userIds = userIdsString ? JSON.parse(userIdsString) : [];\n\n    if (Array.isArray(userIds)) {\n      // Remove any duplicates that might have been added\n      // The Set preserves insertion order\n      return [...new Set(userIds)];\n    } else {\n      throw new Error(\"Expected the user ids to be an array\");\n    }\n  }\n  /**\n   * Sets the list of ids in storage.\n   * Optionally merging with existing ids stored in the storage, by prepending these while voiding duplicates.\n   *\n   * @param userIds The list of ids to store.\n   * @param mergeWithExisting Prepend existing ids to avoid data-races with other apps using this storage.\n   */\n\n\n  setUserIds(userIds, mergeWithExisting) {\n    if (mergeWithExisting) {\n      // Add any existing user id to the end of this list, avoiding duplicates\n      const existingIds = this.getUserIds();\n\n      for (const id of existingIds) {\n        if (userIds.indexOf(id) === -1) {\n          userIds.push(id);\n        }\n      }\n    } // Store the list of ids\n\n\n    this.set(USER_IDS_STORAGE_KEY, JSON.stringify(userIds));\n  }\n  /**\n   * Remove an id from the list of ids.\n   *\n   * @param userId The id of a User to be removed.\n   */\n\n\n  removeUserId(userId) {\n    const existingIds = this.getUserIds();\n    const userIds = existingIds.filter(id => id !== userId); // Store the list of ids\n\n    this.setUserIds(userIds, false);\n  }\n  /**\n   * @returns id of this device (if any exists)\n   */\n\n\n  getDeviceId() {\n    return this.get(DEVICE_ID_STORAGE_KEY);\n  }\n  /**\n   * @param deviceId The id of this device, to send on subsequent authentication requests.\n   */\n\n\n  setDeviceId(deviceId) {\n    this.set(DEVICE_ID_STORAGE_KEY, deviceId);\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n\n\nconst LOWERCASE_LETTERS = \"abcdefghijklmnopqrstuvwxyz\";\nconst CLOSE_CHECK_INTERVAL = 100; // 10 times per second\n\nconst REDIRECT_HASH_TO_RESULT = {\n  _stitch_client_app_id: \"appId\",\n  _baas_client_app_id: \"appId\",\n  _stitch_ua: \"userAuth\",\n  _baas_ua: \"userAuth\",\n  _stitch_link: \"link\",\n  _baas_link: \"link\",\n  _stitch_error: \"error\",\n  _baas_error: \"error\",\n  _stitch_state: \"state\",\n  _baas_state: \"state\"\n};\n/**\n * A collection of methods helping implement the OAuth2 flow.\n */\n\nclass OAuth2Helper {\n  /**\n   * @param storage The underlying storage to use when storing and retriving secrets.\n   * @param openWindow An optional function called when a browser window needs to open.\n   */\n  constructor(storage, openWindow = getEnvironment().openWindow) {\n    this.storage = storage.prefix(\"oauth2\");\n    this.openWindow = openWindow;\n  }\n  /**\n   * Parses the query string from the final step of the OAuth flow.\n   *\n   * @param queryString The query string passed through in location.hash.\n   * @returns The result of the OAuth flow.\n   */\n\n\n  static parseRedirectLocation(queryString) {\n    const params = decodeQueryString(queryString);\n    const result = {};\n\n    for (const [p, r] of Object.entries(REDIRECT_HASH_TO_RESULT)) {\n      const value = params[p];\n\n      if (value) {\n        result[r] = value;\n      }\n    }\n\n    return result;\n  }\n  /**\n   * Handle the redirect querystring by parsing it and storing it for others to consume.\n   *\n   * @param queryString The query string containing the encoded result from the OAuth provider.\n   * @param storage The underlying storage used to persist the result.\n   */\n\n\n  static handleRedirect(queryString, storage = getEnvironment().defaultStorage) {\n    const result = OAuth2Helper.parseRedirectLocation(queryString);\n    const {\n      state,\n      error\n    } = result;\n\n    if (typeof state === \"string\") {\n      const oauth2Storage = storage.prefix(\"oauth2\");\n      const stateStorage = OAuth2Helper.getStateStorage(oauth2Storage, state);\n      stateStorage.set(\"result\", JSON.stringify(result));\n    } else if (error) {\n      throw new Error(`Failed to handle OAuth 2.0 redirect: ${error}`);\n    } else {\n      throw new Error(\"Failed to handle OAuth 2.0 redirect.\");\n    }\n  }\n  /**\n   * Decodes the authInfo string into its seperate parts.\n   *\n   * @param authInfo An authInfo string returned from the server.\n   * @returns An object containing the separate parts of the authInfo string.\n   */\n\n\n  static decodeAuthInfo(authInfo) {\n    const parts = (authInfo || \"\").split(\"$\");\n\n    if (parts.length === 4) {\n      const [accessToken, refreshToken, userId, deviceId] = parts;\n      return {\n        accessToken,\n        refreshToken,\n        userId,\n        deviceId\n      };\n    } else {\n      throw new Error(\"Failed to decode 'authInfo' into ids and tokens\");\n    }\n  }\n  /**\n   * Get the storage key associated of an secret associated with a state.\n   *\n   * @param storage The root storage used to derive a \"state namespaced\" storage.\n   * @param state The random state.\n   * @returns The storage associated with a particular state.\n   */\n\n\n  static getStateStorage(storage, state) {\n    return storage.prefix(`state(${state})`);\n  }\n  /**\n   * Open a window and wait for the redirect to be handled.\n   *\n   * @param url The URL to open.\n   * @param state The state which will be used to listen for storage updates.\n   * @returns The result passed through the redirect.\n   */\n\n\n  openWindowAndWaitForRedirect(url, state) {\n    const stateStorage = OAuth2Helper.getStateStorage(this.storage, state); // Return a promise that resolves when the  gets known\n\n    return new Promise((resolve, reject) => {\n      let redirectWindow = null; // We're declaring the interval now to enable referencing before its initialized\n\n      let windowClosedInterval; // eslint-disable-line prefer-const\n\n      const handleStorageUpdate = () => {\n        // Trying to get the secret from storage\n        const result = stateStorage.get(\"result\");\n\n        if (result) {\n          const parsedResult = JSON.parse(result); // The secret got updated!\n\n          stateStorage.removeListener(handleStorageUpdate); // Clear the storage to prevent others from reading this\n\n          stateStorage.clear(); // Try closing the newly created window\n\n          try {\n            if (redirectWindow) {\n              // Stop checking if the window closed\n              clearInterval(windowClosedInterval);\n              redirectWindow.close();\n            }\n          } catch (err) {\n            console.warn(`Failed closing redirect window: ${err}`);\n          } finally {\n            resolve(parsedResult);\n          }\n        }\n      }; // Add a listener to the state storage, awaiting an update to the secret\n\n\n      stateStorage.addListener(handleStorageUpdate); // Open up a window\n\n      redirectWindow = this.openWindow(url); // Not using a const, because we need the two listeners to reference each other when removing the other.\n\n      windowClosedInterval = setInterval(() => {\n        // Polling \"closed\" because registering listeners on the window violates cross-origin policies\n        if (!redirectWindow) {\n          // No need to keep polling for a window that we can't check\n          clearInterval(windowClosedInterval);\n        } else if (redirectWindow.closed) {\n          // Stop polling the window state\n          clearInterval(windowClosedInterval); // Stop listening for changes to the storage\n\n          stateStorage.removeListener(handleStorageUpdate); // Reject the promise\n\n          const err = new Error(\"Window closed\");\n          reject(err);\n        }\n      }, CLOSE_CHECK_INTERVAL);\n    });\n  }\n  /**\n   * Generate a random state string.\n   *\n   * @returns The random state string.\n   */\n\n\n  generateState() {\n    return generateRandomString(12, LOWERCASE_LETTERS);\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n\n\nconst REDIRECT_LOCATION_HEADER = \"x-baas-location\";\n/**\n * Handles authentication and linking of users.\n */\n\nclass Authenticator {\n  /**\n   * @param fetcher The fetcher used to fetch responses from the server.\n   * @param storage The storage used when completing OAuth 2.0 flows (should not be scoped to a specific app).\n   * @param getDeviceInformation Called to get device information to be sent to the server.\n   */\n  constructor(fetcher, storage, getDeviceInformation) {\n    this.fetcher = fetcher;\n    this.oauth2 = new OAuth2Helper(storage);\n    this.getDeviceInformation = getDeviceInformation;\n  }\n  /**\n   * @param credentials Credentials to use when logging in.\n   * @param linkingUser A user requesting to link.\n   * @returns A promise resolving to the response from the server.\n   */\n\n\n  authenticate(credentials, linkingUser) {\n    var _this19 = this;\n\n    return _asyncToGenerator(function* () {\n      const deviceInformation = _this19.getDeviceInformation();\n\n      const isLinking = typeof linkingUser === \"object\";\n\n      if (credentials.providerType.startsWith(\"oauth2\") && typeof credentials.payload.redirectUrl === \"string\") {\n        // Initiate the OAuth2 flow by generating a state and fetch a redirect URL\n        const state = _this19.oauth2.generateState();\n\n        const url = yield _this19.getLogInUrl(credentials, isLinking, {\n          state,\n          redirect: credentials.payload.redirectUrl,\n          // Ensure redirects are communicated in a header different from \"Location\" and status remains 200 OK\n          providerRedirectHeader: isLinking ? true : undefined,\n          // Add the device information, only if we're not linking - since that request won't have a body of its own.\n          device: !isLinking ? deviceInformation.encode() : undefined\n        }); // If we're linking, we need to send the users access token in the request\n\n        if (isLinking) {\n          const response = yield _this19.fetcher.fetch({\n            method: \"GET\",\n            url,\n            tokenType: isLinking ? \"access\" : \"none\",\n            user: linkingUser,\n            // The response will set a cookie that we need to tell the browser to store\n            mode: \"cors\",\n            credentials: \"include\"\n          }); // If a response header contains a redirect URL: Open a window and wait for the redirect to be handled\n\n          const redirectUrl = response.headers.get(REDIRECT_LOCATION_HEADER);\n\n          if (redirectUrl) {\n            return _this19.openWindowAndWaitForAuthResponse(redirectUrl, state);\n          } else {\n            throw new Error(`Missing ${REDIRECT_LOCATION_HEADER} header`);\n          }\n        } else {\n          // Otherwise we can open a window and let the server redirect the user right away\n          // This gives lower latency (as we don't need the client to receive and execute the redirect in code)\n          // This also has less dependency on cookies and doesn't sent any tokens.\n          return _this19.openWindowAndWaitForAuthResponse(url, state);\n        }\n      } else {\n        const logInUrl = yield _this19.getLogInUrl(credentials, isLinking);\n        const response = yield _this19.fetcher.fetchJSON({\n          method: \"POST\",\n          url: logInUrl,\n          body: { ...credentials.payload,\n            options: {\n              device: deviceInformation.toJSON()\n            }\n          },\n          tokenType: isLinking ? \"access\" : \"none\",\n          user: linkingUser\n        }); // Spread out values from the response and ensure they're valid\n\n        const {\n          user_id: userId,\n          access_token: accessToken,\n          refresh_token: refreshToken = null,\n          device_id: deviceId\n        } = response;\n\n        if (typeof userId !== \"string\") {\n          throw new Error(\"Expected a user id in the response\");\n        }\n\n        if (typeof accessToken !== \"string\") {\n          throw new Error(\"Expected an access token in the response\");\n        }\n\n        if (typeof refreshToken !== \"string\" && refreshToken !== null) {\n          throw new Error(\"Expected refresh token to be a string or null\");\n        }\n\n        if (typeof deviceId !== \"string\") {\n          throw new Error(\"Expected device id to be a string\");\n        }\n\n        return {\n          userId,\n          accessToken,\n          refreshToken,\n          deviceId\n        };\n      }\n    })();\n  }\n  /**\n   * @param credentials Credentials to use when logging in.\n   * @param link Should the request link with the current user?\n   * @param extraQueryParams Any extra parameters to include in the query string\n   * @returns A promise resolving to the url to be used when logging in.\n   */\n\n\n  getLogInUrl(credentials, link = false, extraQueryParams = {}) {\n    var _this20 = this;\n\n    return _asyncToGenerator(function* () {\n      // See https://github.com/mongodb/stitch-js-sdk/blob/310f0bd5af80f818cdfbc3caf1ae29ffa8e9c7cf/packages/core/sdk/src/auth/internal/CoreStitchAuth.ts#L746-L780\n      const appRoute = _this20.fetcher.appRoute;\n      const loginRoute = appRoute.authProvider(credentials.providerName).login();\n      const qs = encodeQueryString({\n        link: link ? \"true\" : undefined,\n        ...extraQueryParams\n      });\n      const locationUrl = yield _this20.fetcher.locationUrl;\n      return locationUrl + loginRoute.path + qs;\n    })();\n  }\n\n  openWindowAndWaitForAuthResponse(redirectUrl, state) {\n    var _this21 = this;\n\n    return _asyncToGenerator(function* () {\n      const redirectResult = yield _this21.oauth2.openWindowAndWaitForRedirect(redirectUrl, state); // Decode the auth info (id, tokens, etc.) from the result of the redirect\n\n      return OAuth2Helper.decodeAuthInfo(redirectResult.userAuth);\n    })();\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n// TODO: Determine if the shape of an error response is specific to each service or widely used.\n\n/**\n * An error produced while communicating with the MongoDB Realm server.\n */\n\n\nclass MongoDBRealmError extends Error {\n  constructor(method, url, statusCode, statusText, error, errorCode, link) {\n    const summary = statusText ? `status ${statusCode} ${statusText}` : `status ${statusCode}`;\n\n    if (typeof error === \"string\") {\n      super(`Request failed (${method} ${url}): ${error} (${summary})`);\n    } else {\n      super(`Request failed (${method} ${url}): (${summary})`);\n    }\n\n    this.method = method;\n    this.url = url;\n    this.statusText = statusText;\n    this.statusCode = statusCode;\n    this.error = error;\n    this.errorCode = errorCode;\n    this.link = link;\n  }\n  /**\n   * Constructs and returns an error from a request and a response.\n   * Note: The caller must throw this error themselves.\n   *\n   * @param request The request sent to the server.\n   * @param response A raw response, as returned from the server.\n   * @returns An error from a request and a response.\n   */\n\n\n  static fromRequestAndResponse(request, response) {\n    return _asyncToGenerator(function* () {\n      var _a;\n\n      const {\n        url,\n        method\n      } = request;\n      const {\n        status,\n        statusText\n      } = response;\n\n      if ((_a = response.headers.get(\"content-type\")) === null || _a === void 0 ? void 0 : _a.startsWith(\"application/json\")) {\n        const body = yield response.json();\n\n        if (typeof body === \"object\" && body) {\n          const {\n            error,\n            error_code: errorCode,\n            link\n          } = body;\n          return new MongoDBRealmError(method, url, status, statusText, typeof error === \"string\" ? error : undefined, typeof errorCode === \"string\" ? errorCode : undefined, typeof link === \"string\" ? link : undefined);\n        }\n      }\n\n      return new MongoDBRealmError(method, url, status, statusText);\n    })();\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n\n/**\n * @param body A possible resonse body.\n * @returns An async iterator.\n */\n\n\nfunction asyncIteratorFromResponseBody(body) {\n  if (typeof body !== \"object\" || body === null) {\n    throw new Error(\"Expected a non-null object\");\n  } else if (Symbol.asyncIterator in body) {\n    return body;\n  } else if (\"getReader\" in body) {\n    const stream = body;\n    return {\n      [Symbol.asyncIterator]() {\n        const reader = stream.getReader();\n        return {\n          next() {\n            return reader.read();\n          },\n\n          return() {\n            return _asyncToGenerator(function* () {\n              yield reader.cancel();\n              return {\n                done: true,\n                value: null\n              };\n            })();\n          }\n\n        };\n      }\n\n    };\n  } else {\n    throw new Error(\"Expected an AsyncIterable or a ReadableStream\");\n  }\n}\n/**\n * Wraps a NetworkTransport from the \"realm-network-transport\" package.\n * Extracts error messages and throws `MongoDBRealmError` objects upon failures.\n * Injects access or refresh tokens for a current or specific user.\n * Refreshes access tokens if requests fails due to a 401 error.\n * Optionally parses response as JSON before returning it.\n * Fetches and exposes an app's location url.\n */\n\n\nclass Fetcher {\n  /**\n   * @param config A configuration of the fetcher.\n   * @param config.appId The application id.\n   * @param config.transport The transport used when fetching.\n   * @param config.userContext An object used to determine the requesting user.\n   * @param config.locationUrlContext An object used to determine the location / base URL.\n   */\n  constructor({\n    appId,\n    transport,\n    userContext,\n    locationUrlContext\n  }) {\n    this.appId = appId;\n    this.transport = transport;\n    this.userContext = userContext;\n    this.locationUrlContext = locationUrlContext;\n  }\n  /**\n   * @param user An optional user to generate the header for.\n   * @param tokenType The type of token (access or refresh).\n   * @returns An object containing the user's token as \"Authorization\" header or undefined if no user is given.\n   */\n\n\n  static buildAuthorizationHeader(user, tokenType) {\n    if (!user || tokenType === \"none\") {\n      return {};\n    } else if (tokenType === \"access\") {\n      return {\n        Authorization: `Bearer ${user.accessToken}`\n      };\n    } else if (tokenType === \"refresh\") {\n      return {\n        Authorization: `Bearer ${user.refreshToken}`\n      };\n    } else {\n      throw new Error(`Unexpected token type (${tokenType})`);\n    }\n  }\n  /**\n   * @param body The body string or object passed from a request.\n   * @returns An object optionally specifying the \"Content-Type\" header.\n   */\n\n\n  static buildBody(body) {\n    if (!body) {\n      return;\n    } else if (typeof body === \"object\" && body !== null) {\n      return JSON.stringify(serialize(body));\n    } else if (typeof body === \"string\") {\n      return body;\n    } else {\n      console.log(\"body is\", body);\n      throw new Error(\"Unexpected type of body\");\n    }\n  }\n  /**\n   * @param body The body string or object passed from a request.\n   * @returns An object optionally specifying the \"Content-Type\" header.\n   */\n\n\n  static buildJsonHeader(body) {\n    if (body && body.length > 0) {\n      return {\n        \"Content-Type\": \"application/json\"\n      };\n    } else {\n      return {};\n    }\n  }\n\n  clone(config) {\n    return new Fetcher({\n      appId: this.appId,\n      transport: this.transport,\n      userContext: this.userContext,\n      locationUrlContext: this.locationUrlContext,\n      ...config\n    });\n  }\n  /**\n   * Fetch a network resource as an authenticated user.\n   *\n   * @param request The request which should be sent to the server.\n   * @returns The response from the server.\n   */\n\n\n  fetch(request) {\n    var _this22 = this;\n\n    return _asyncToGenerator(function* () {\n      const {\n        path,\n        url,\n        tokenType = \"access\",\n        user = _this22.userContext.currentUser,\n        ...restOfRequest\n      } = request;\n\n      if (typeof path === \"string\" && typeof url === \"string\") {\n        throw new Error(\"Use of 'url' and 'path' mutually exclusive\");\n      } else if (typeof path === \"string\") {\n        // Derive the URL\n        const url = (yield _this22.locationUrlContext.locationUrl) + path;\n        return _this22.fetch({ ...request,\n          path: undefined,\n          url\n        });\n      } else if (typeof url === \"string\") {\n        const response = yield _this22.transport.fetch({ ...restOfRequest,\n          url,\n          headers: { ...Fetcher.buildAuthorizationHeader(user, tokenType),\n            ...request.headers\n          }\n        });\n\n        if (response.ok) {\n          return response;\n        } else if (user && response.status === 401 && tokenType === \"access\") {\n          // If the access token has expired, it would help refreshing it\n          yield user.refreshAccessToken(); // Retry with the specific user, since the currentUser might have changed.\n\n          return _this22.fetch({ ...request,\n            user\n          });\n        } else {\n          if (user && response.status === 401 && tokenType === \"refresh\") {\n            // A 401 error while using the refresh token indicates the token has an issue.\n            // Reset the tokens to prevent a lock.\n            user.accessToken = null;\n            user.refreshToken = null;\n          } // Throw an error with a message extracted from the body\n\n\n          throw yield MongoDBRealmError.fromRequestAndResponse(request, response);\n        }\n      } else {\n        throw new Error(\"Expected either 'url' or 'path'\");\n      }\n    })();\n  }\n  /**\n   * Fetch a network resource as an authenticated user and parse the result as extended JSON.\n   *\n   * @param request The request which should be sent to the server.\n   * @returns The response from the server, parsed as extended JSON.\n   */\n\n\n  fetchJSON(request) {\n    var _this23 = this;\n\n    return _asyncToGenerator(function* () {\n      const {\n        body\n      } = request;\n      const serializedBody = Fetcher.buildBody(body);\n      const contentTypeHeaders = Fetcher.buildJsonHeader(serializedBody);\n      const response = yield _this23.fetch({ ...request,\n        body: serializedBody,\n        headers: {\n          Accept: \"application/json\",\n          ...contentTypeHeaders,\n          ...request.headers\n        }\n      });\n      const contentType = response.headers.get(\"content-type\");\n\n      if (contentType === null || contentType === void 0 ? void 0 : contentType.startsWith(\"application/json\")) {\n        const responseBody = yield response.json();\n        return deserialize(responseBody);\n      } else if (contentType === null) {\n        return null;\n      } else {\n        throw new Error(`Expected JSON response, got \"${contentType}\"`);\n      }\n    })();\n  }\n  /**\n   * Fetch an \"event-stream\" resource as an authenticated user.\n   *\n   * @param request The request which should be sent to the server.\n   * @returns An async iterator over the response body.\n   */\n\n\n  fetchStream(request) {\n    var _this24 = this;\n\n    return _asyncToGenerator(function* () {\n      const {\n        body\n      } = yield _this24.fetch({ ...request,\n        headers: {\n          Accept: \"text/event-stream\",\n          ...request.headers\n        }\n      });\n      return asyncIteratorFromResponseBody(body);\n    })();\n  }\n  /**\n   * @returns The path of the app route.\n   */\n\n\n  get appRoute() {\n    return routes.api().app(this.appId);\n  }\n  /**\n   * @returns A promise of the location URL of the app.\n   */\n\n\n  get locationUrl() {\n    return this.locationUrlContext.locationUrl;\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n\n/**\n * The key in a storage on which the device id is stored.\n */\n\n\nconst DEVICE_ID_STORAGE_KEY$1 = \"deviceId\";\nvar DeviceFields;\n\n(function (DeviceFields) {\n  DeviceFields[\"DEVICE_ID\"] = \"deviceId\";\n  DeviceFields[\"APP_ID\"] = \"appId\";\n  DeviceFields[\"APP_VERSION\"] = \"appVersion\";\n  DeviceFields[\"PLATFORM\"] = \"platform\";\n  DeviceFields[\"PLATFORM_VERSION\"] = \"platformVersion\";\n  DeviceFields[\"SDK_VERSION\"] = \"sdkVersion\";\n})(DeviceFields || (DeviceFields = {}));\n/**\n * Information describing the device, app and SDK.\n */\n\n\nclass DeviceInformation {\n  /**\n   * @param params Construct the device information from these parameters.\n   * @param params.appId A user-defined application id.\n   * @param params.appVersion A user-defined application version.\n   * @param params.deviceId An unique id for the end-users device.\n   */\n  constructor({\n    appId,\n    appVersion,\n    deviceId\n  }) {\n    /**\n     * The version of the Realm Web SDK (constant provided by Rollup).\n     */\n    this.sdkVersion = \"1.5.1\";\n    const environment = getEnvironment();\n    this.platform = environment.platform;\n    this.platformVersion = environment.platformVersion;\n    this.appId = appId;\n    this.appVersion = appVersion;\n    this.deviceId = deviceId;\n  }\n  /**\n   * @returns An base64 URI encoded representation of the device information.\n   */\n\n\n  encode() {\n    const obj = removeKeysWithUndefinedValues(this);\n    return gBase64.encode(JSON.stringify(obj));\n  }\n  /**\n   * @returns The defaults\n   */\n\n\n  toJSON() {\n    return removeKeysWithUndefinedValues(this);\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n\n/**\n * Default base url to prefix all requests if no baseUrl is specified in the configuration.\n */\n\n\nconst DEFAULT_BASE_URL = \"https://stitch.mongodb.com\";\n/**\n * MongoDB Realm App\n */\n\nclass App {\n  /**\n   * Construct a Realm App, either from the Realm App id visible from the MongoDB Realm UI or a configuration.\n   *\n   * @param idOrConfiguration The Realm App id or a configuration to use for this app.\n   */\n  constructor(idOrConfiguration) {\n    /**\n     * An array of active and logged-out users.\n     * Elements in the beginning of the array is considered more recent than the later elements.\n     */\n    this.users = [];\n    /**\n     * A promise resolving to the App's location url.\n     */\n\n    this._locationUrl = null; // If the argument is a string, convert it to a simple configuration object.\n\n    const configuration = typeof idOrConfiguration === \"string\" ? {\n      id: idOrConfiguration\n    } : idOrConfiguration; // Initialize properties from the configuration\n\n    if (typeof configuration === \"object\" && typeof configuration.id === \"string\") {\n      this.id = configuration.id;\n    } else {\n      throw new Error(\"Missing a MongoDB Realm app-id\");\n    }\n\n    this.baseUrl = configuration.baseUrl || DEFAULT_BASE_URL;\n\n    if (configuration.skipLocationRequest) {\n      // Use the base url directly, instead of requesting a location URL from the server\n      this._locationUrl = Promise.resolve(this.baseUrl);\n    }\n\n    this.localApp = configuration.app;\n    const {\n      storage,\n      transport = new DefaultNetworkTransport()\n    } = configuration; // Construct a fetcher wrapping the network transport\n\n    this.fetcher = new Fetcher({\n      appId: this.id,\n      userContext: this,\n      locationUrlContext: this,\n      transport\n    }); // Construct the auth providers\n\n    this.emailPasswordAuth = new EmailPasswordAuth(this.fetcher); // Construct the storage\n\n    const baseStorage = storage || getEnvironment().defaultStorage;\n    this.storage = new AppStorage(baseStorage, this.id);\n    this.authenticator = new Authenticator(this.fetcher, baseStorage, () => this.deviceInformation); // Hydrate the app state from storage\n\n    try {\n      this.hydrate();\n    } catch (err) {\n      // The storage was corrupted\n      this.storage.clear(); // A failed hydration shouldn't throw and break the app experience\n      // Since this is \"just\" persisted state that unfortunately got corrupted or partially lost\n\n      console.warn(\"Realm app hydration failed:\", err.message);\n    }\n  }\n  /**\n   * Get or create a singleton Realm App from an id.\n   * Calling this function multiple times with the same id will return the same instance.\n   *\n   * @param id The Realm App id visible from the MongoDB Realm UI or a configuration.\n   * @returns The Realm App instance.\n   */\n\n\n  static getApp(id) {\n    if (id in App.appCache) {\n      return App.appCache[id];\n    } else {\n      const instance = new App(id);\n      App.appCache[id] = instance;\n      return instance;\n    }\n  }\n  /**\n   * Switch user.\n   *\n   * @param nextUser The user or id of the user to switch to.\n   */\n\n\n  switchUser(nextUser) {\n    const index = this.users.findIndex(u => u === nextUser);\n\n    if (index === -1) {\n      throw new Error(\"The user was never logged into this app\");\n    } // Remove the user from the stack\n\n\n    const [user] = this.users.splice(index, 1); // Insert the user in the beginning of the stack\n\n    this.users.unshift(user);\n  }\n  /**\n   * Log in a user.\n   *\n   * @param credentials Credentials to use when logging in.\n   * @param fetchProfile Should the users profile be fetched? (default: true)\n   * @returns A promise resolving to the newly logged in user.\n   */\n\n\n  logIn(credentials, fetchProfile = true) {\n    var _this25 = this;\n\n    return _asyncToGenerator(function* () {\n      const response = yield _this25.authenticator.authenticate(credentials);\n\n      const user = _this25.createOrUpdateUser(response, credentials.providerType); // Let's ensure this will be the current user, in case the user object was reused.\n\n\n      _this25.switchUser(user); // If neeeded, fetch and set the profile on the user\n\n\n      if (fetchProfile) {\n        yield user.refreshProfile();\n      } // Persist the user id in the storage,\n      // merging to avoid overriding logins from other apps using the same underlying storage\n\n\n      _this25.storage.setUserIds(_this25.users.map(u => u.id), true); // Read out and store the device id from the server\n\n\n      const deviceId = response.deviceId;\n\n      if (deviceId && deviceId !== \"000000000000000000000000\") {\n        _this25.storage.set(DEVICE_ID_STORAGE_KEY$1, deviceId);\n      } // Return the user\n\n\n      return user;\n    })();\n  }\n  /**\n   * @inheritdoc\n   */\n\n\n  removeUser(user) {\n    var _this26 = this;\n\n    return _asyncToGenerator(function* () {\n      // Remove the user from the list of users\n      const index = _this26.users.findIndex(u => u === user);\n\n      if (index === -1) {\n        throw new Error(\"The user was never logged into this app\");\n      }\n\n      _this26.users.splice(index, 1); // Log out the user - this removes access and refresh tokens from storage\n\n\n      yield user.logOut(); // Remove the users profile from storage\n\n      _this26.storage.remove(`user(${user.id}):profile`); // Remove the user from the storage\n\n\n      _this26.storage.removeUserId(user.id);\n    })();\n  }\n  /**\n   * The currently active user (or null if no active users exists).\n   *\n   * @returns the currently active user or null.\n   */\n\n\n  get currentUser() {\n    const activeUsers = this.users.filter(user => user.state === UserState.Active);\n\n    if (activeUsers.length === 0) {\n      return null;\n    } else {\n      // Current user is the top of the stack\n      return activeUsers[0];\n    }\n  }\n  /**\n   * All active and logged-out users:\n   *  - First in the list are active users (ordered by most recent call to switchUser or login)\n   *  - Followed by logged out users (also ordered by most recent call to switchUser or login).\n   *\n   * @returns An array of users active or loggedout users (current user being the first).\n   */\n\n\n  get allUsers() {\n    // Returning a freezed copy of the list of users to prevent outside changes\n    return Object.fromEntries(this.users.map(user => [user.id, user]));\n  }\n  /**\n   * @returns A promise of the app URL, with the app location resolved.\n   */\n\n\n  get locationUrl() {\n    if (!this._locationUrl) {\n      const path = routes.api().app(this.id).location().path;\n      this._locationUrl = this.fetcher.fetchJSON({\n        method: \"GET\",\n        url: this.baseUrl + path,\n        tokenType: \"none\"\n      }).then(body => {\n        if (typeof body !== \"object\") {\n          throw new Error(\"Expected response body be an object\");\n        } else {\n          return body;\n        }\n      }).then(({\n        hostname\n      }) => {\n        if (typeof hostname !== \"string\") {\n          throw new Error(\"Expected response to contain a 'hostname'\");\n        } else {\n          return hostname;\n        }\n      }).catch(err => {\n        // Reset the location to allow another request to fetch again.\n        this._locationUrl = null;\n        throw err;\n      });\n    }\n\n    return this._locationUrl;\n  }\n  /**\n   * @returns Information about the current device, sent to the server when authenticating.\n   */\n\n\n  get deviceInformation() {\n    const deviceIdStr = this.storage.getDeviceId();\n    const deviceId = typeof deviceIdStr === \"string\" && deviceIdStr !== \"000000000000000000000000\" ? new ObjectId(deviceIdStr) : undefined;\n    return new DeviceInformation({\n      appId: this.localApp ? this.localApp.name : undefined,\n      appVersion: this.localApp ? this.localApp.version : undefined,\n      deviceId\n    });\n  }\n  /**\n   * Create (and store) a new user or update an existing user's access and refresh tokens.\n   * This helps de-duplicating users in the list of users known to the app.\n   *\n   * @param response A response from the Authenticator.\n   * @param providerType The type of the authentication provider used.\n   * @returns A new or an existing user.\n   */\n\n\n  createOrUpdateUser(response, providerType) {\n    const existingUser = this.users.find(u => u.id === response.userId);\n\n    if (existingUser) {\n      // Update the users access and refresh tokens\n      existingUser.accessToken = response.accessToken;\n      existingUser.refreshToken = response.refreshToken;\n      return existingUser;\n    } else {\n      // Create and store a new user\n      if (!response.refreshToken) {\n        throw new Error(\"No refresh token in response from server\");\n      }\n\n      const user = new User({\n        app: this,\n        id: response.userId,\n        accessToken: response.accessToken,\n        refreshToken: response.refreshToken,\n        providerType\n      });\n      this.users.unshift(user);\n      return user;\n    }\n  }\n  /**\n   * Restores the state of the app (active and logged-out users) from the storage\n   */\n\n\n  hydrate() {\n    const userIds = this.storage.getUserIds();\n    this.users = userIds.map(id => new User({\n      app: this,\n      id\n    }));\n  }\n\n}\n/**\n * A map of app instances returned from calling getApp.\n */\n\n\nApp.appCache = {};\n/**\n * Instances of this class can be passed to the `app.logIn` method to authenticate an end-user.\n */\n\nApp.Credentials = Credentials; ////////////////////////////////////////////////////////////////////////////\n\n/**\n * Get or create a singleton Realm App from an id.\n * Calling this function multiple times with the same id will return the same instance.\n *\n * @param id The Realm App id visible from the MongoDB Realm UI or a configuration.\n * @returns The Realm App instance.\n */\n\nfunction getApp(id) {\n  return App.getApp(id);\n} ////////////////////////////////////////////////////////////////////////////\n\n/**\n * In-memory storage that will not be persisted.\n */\n\n\nclass LocalStorage {\n  /**\n   * Constructs a LocalStorage using the global window.\n   */\n  constructor() {\n    if (typeof globalThis.localStorage === \"object\") {\n      this.global = globalThis;\n    } else {\n      throw new Error(\"Cannot use LocalStorage without a global localStorage object\");\n    }\n  }\n  /** @inheritdoc */\n\n\n  get(key) {\n    return this.global.localStorage.getItem(key);\n  }\n  /** @inheritdoc */\n\n\n  set(key, value) {\n    return this.global.localStorage.setItem(key, value);\n  }\n  /** @inheritdoc */\n\n\n  remove(key) {\n    return this.global.localStorage.removeItem(key);\n  }\n  /** @inheritdoc */\n\n\n  prefix(keyPart) {\n    return new PrefixedStorage(this, keyPart);\n  }\n  /** @inheritdoc */\n\n\n  clear(prefix) {\n    const keys = []; // Iterate all keys to find the once have a matching prefix.\n\n    for (let i = 0; i < this.global.localStorage.length; i++) {\n      const key = this.global.localStorage.key(i);\n\n      if (key && (!prefix || key.startsWith(prefix))) {\n        keys.push(key);\n      }\n    } // Remove the items in a seperate loop to avoid updating while iterating.\n\n\n    for (const key of keys) {\n      this.global.localStorage.removeItem(key);\n    }\n  }\n  /** @inheritdoc */\n\n\n  addListener(listener) {\n    return this.global.addEventListener(\"storage\", listener);\n  }\n  /** @inheritdoc */\n\n\n  removeListener(listener) {\n    return this.global.removeEventListener(\"storage\", listener);\n  }\n\n} ////////////////////////////////////////////////////////////////////////////\n\n\nconst browser = detect();\nconst DefaultStorage = \"localStorage\" in globalThis ? LocalStorage : MemoryStorage;\n/**\n * Attempt to use the browser to open a window\n *\n * @param url The url to open a window to.\n * @returns Then newly create window.\n */\n\nfunction openWindow(url) {\n  if (typeof globalThis.open === \"function\") {\n    return globalThis.open(url);\n  } else {\n    console.log(`Please open ${url}`);\n    return null;\n  }\n}\n\nconst environment$1 = {\n  defaultStorage: new DefaultStorage().prefix(\"realm-web\"),\n  openWindow,\n  platform: (browser === null || browser === void 0 ? void 0 : browser.name) || \"web\",\n  platformVersion: (browser === null || browser === void 0 ? void 0 : browser.version) || \"0.0.0\",\n  TextDecoder\n};\nsetEnvironment(environment$1);\n/**\n * Handle an OAuth 2.0 redirect.\n *\n * @param location An optional location to use (defaults to the windows current location).\n * @param storage Optional storage used to save any results from the location.\n */\n\nfunction handleAuthRedirect(location = globalThis.location, storage = environment$1.defaultStorage) {\n  try {\n    const queryString = location.hash.substr(1); // Strip the initial # from the hash\n\n    OAuth2Helper.handleRedirect(queryString, storage);\n  } catch (err) {\n    // Ensure calling this never throws: It should not interrupt a users flow.\n    console.warn(err);\n  }\n}\n\nexport { App, Credentials, DEFAULT_BASE_URL, LocalStorage, MongoDBRealmError, User, UserState, UserType$1 as UserType, getApp, getEnvironment, handleAuthRedirect, setEnvironment };","map":{"version":3,"sources":["/Users/dev/Documents/Projects/Schlosswochen-Inscription/node_modules/realm-web/dist/bundle.dom.es.js"],"names":["EJSON","ObjectId","bson","BSON","__spreadArray","undefined","to","from","pack","arguments","length","i","l","ar","Array","prototype","slice","call","concat","BrowserInfo","name","version","os","type","NodeInfo","process","platform","SearchBotDeviceInfo","bot","BotInfo","ReactNativeInfo","SEARCHBOX_UA_REGEX","SEARCHBOT_OS_REGEX","REQUIRED_VERSION_PARTS","userAgentRules","operatingSystemRules","detect","userAgent","parseUserAgent","document","navigator","product","getNodeVersion","matchUserAgent","ua","reduce","matched","_a","browser","regex","uaMatch","exec","matchedRule","match","versionParts","split","join","createVersionParts","detectOS","searchBotMatch","ii","count","isNode","output","push","DefaultNetworkTransport","constructor","fetch","Error","AbortController","fetchWithCallbacks","request","handler","then","response","decodedBody","text","responseHeaders","headers","forEach","value","key","statusCode","status","body","r","onSuccess","catch","e","onError","timeoutMs","url","rest","signal","cancelTimeout","createTimeoutSignal","controller","timeout","setTimeout","abort","clearTimeout","DEFAULT_HEADERS","globalThis","bind","VERSION","_hasatob","atob","_hasbtoa","btoa","_hasBuffer","Buffer","_TD","TextDecoder","_TE","TextEncoder","b64ch","b64chs","b64tab","a","tab","c","b64re","_fromCC","String","fromCharCode","_U8Afrom","Uint8Array","it","fn","x","map","_mkUriSafe","src","replace","m0","_tidyB64","s","btoaPolyfill","bin","u32","c0","c1","c2","asc","pad","charCodeAt","TypeError","substring","_btoa","toString","_fromUint8Array","u8a","maxargs","strs","apply","subarray","fromUint8Array","urlsafe","cb_utob","cc","re_utob","utob","u","_encode","encode","encodeURI","re_btou","cb_btou","cccc","cp","offset","btou","b","atobPolyfill","test","u24","r1","r2","charAt","_atob","_toUint8Array","toUint8Array","_unURI","_decode","decode","isValid","_noEnum","v","enumerable","writable","configurable","extendString","_add","Object","defineProperty","extendUint8Array","extendBuiltins","gBase64","fromBase64","toBase64","encodeURL","SERIALIZATION_OPTIONS","relaxed","serialize","obj","deserialize","isArray","doc","UserType","DataKey","DATA_MAPPING","NAME","EMAIL","PICTURE","FIRST_NAME","LAST_NAME","GENDER","BIRTHDAY","MIN_AGE","MAX_AGE","UserProfile","Normal","identities","data","identity","id","provider_type","providerType","mappedData","fromEntries","entries","PrefixedStorage","storage","keyPart","get","PART_SEPARATOR","set","remove","prefix","clear","addListener","listener","removeListener","MemoryStorage","listeners","Set","fireListeners","keys","startsWith","add","delete","ACCESS_TOKEN_STORAGE_KEY","REFRESH_TOKEN_STORAGE_KEY","PROFILE_STORAGE_KEY","PROVIDER_TYPE_STORAGE_KEY","UserStorage","userId","accessToken","refreshToken","profile","assign","JSON","parse","stringify","removeKeysWithUndefinedValues","filter","entry","generateRandomString","alphabet","result","Math","floor","random","encodeQueryString","params","prefixed","cleanedParams","k","encodeURIComponent","decodeQueryString","str","cleanStr","substr","kvp","decodeURIComponent","RESERVED_NAMES","getOwnPropertyNames","cleanArgs","args","arg","cleanArgsAndSerialize","cleaned","FunctionsFactory","fetcher","config","serviceName","argsTransformation","create","factory","Proxy","target","p","receiver","indexOf","callFunction","prop","Reflect","service","appRoute","fetchJSON","method","path","functionsCall","callFunctionStreaming","qs","fetchStream","isDevelopmentMode","setIsDevelopmentMode","state","deprecationWarning","deprecatedItem","suggestedReplacement","console","warn","handleDeprecatedPositionalArgs","methodName","argNames","hasRestArgs","restArgsText","argsObject","prev","argName","index","restArgs","__DEV__","EmailPasswordAuth","providerName","registerUser","userDetails","emailPasswordAuth","register","confirmUser","tokenDetails","confirm","resendConfirmationEmail","emailDetails","confirmSend","retryCustomConfirmation","confirmCall","resetPassword","resetDetails","reset","sendResetPasswordEmail","resetSend","callResetPasswordFunction","resetCall","api","app","appId","location","authProvider","login","authProviderRoutes","auth","apiKeys","enable","disable","session","routes","ApiKeyAuth","tokenType","keyId","fetchAll","environment","setEnvironment","getEnvironment","WatchError","message","code","WatchStreamState","WatchStream","_state","NEED_DATA","_error","_textDecoder","_buffer","_bufferOffset","_eventType","_dataBuffer","feedBuffer","buffer","assertState","stream","advanceBufferState","feedLine","line","endsWith","feedSse","eventType","colon","field","sse","firstPercentIndex","start","percentIndex","encoded","parsed","_nextEvent","HAVE_EVENT","HAVE_ERROR","error_code","errorCode","error","nextEvent","out","nextNewlineIndex","MongoDBCollection","databaseName","collectionName","functions","find","options","database","collection","query","project","projection","sort","limit","findOne","findOneAndUpdate","update","upsert","returnNewDocument","findOneAndReplace","replacement","findOneAndDelete","aggregate","pipeline","insertOne","insertMany","documents","deleteOne","deleteMany","updateOne","updateMany","watch","ids","iterator","watchStream","chunk","createCollection","createDatabase","createService","db","DEFAULT_DEVICE_ID","UserState","UserType$1","User","parameters","_accessToken","_refreshToken","_profile","clone","userContext","currentUser","token","allUsers","LoggedOut","Active","Removed","isLoggedIn","customData","decodedToken","decodeAccessToken","userData","deviceId","payload","parsedPayload","refreshProfile","logOut","linkCredentials","credentials","authenticator","authenticate","details","refreshAccessToken","access_token","refreshCustomData","toJSON","mongoClient","parts","encodedPayload","decodedPayload","exp","expires","iat","issuedAt","sub","subject","user_data","Credentials","anonymous","userApiKey","serverApiKey","apiKey","emailPassword","email","password","username","function","jwt","google","derivePayload","includes","redirectUrl","authCode","idToken","id_token","facebook","redirectUrlOrAccessToken","apple","redirectUrlOrIdToken","USER_IDS_STORAGE_KEY","DEVICE_ID_STORAGE_KEY","AppStorage","getUserIds","userIdsString","userIds","setUserIds","mergeWithExisting","existingIds","removeUserId","getDeviceId","setDeviceId","LOWERCASE_LETTERS","CLOSE_CHECK_INTERVAL","REDIRECT_HASH_TO_RESULT","_stitch_client_app_id","_baas_client_app_id","_stitch_ua","_baas_ua","_stitch_link","_baas_link","_stitch_error","_baas_error","_stitch_state","_baas_state","OAuth2Helper","openWindow","parseRedirectLocation","queryString","handleRedirect","defaultStorage","oauth2Storage","stateStorage","getStateStorage","decodeAuthInfo","authInfo","openWindowAndWaitForRedirect","Promise","resolve","reject","redirectWindow","windowClosedInterval","handleStorageUpdate","parsedResult","clearInterval","close","err","setInterval","closed","generateState","REDIRECT_LOCATION_HEADER","Authenticator","getDeviceInformation","oauth2","linkingUser","deviceInformation","isLinking","getLogInUrl","redirect","providerRedirectHeader","device","user","mode","openWindowAndWaitForAuthResponse","logInUrl","user_id","refresh_token","device_id","link","extraQueryParams","loginRoute","locationUrl","redirectResult","userAuth","MongoDBRealmError","statusText","summary","fromRequestAndResponse","json","asyncIteratorFromResponseBody","Symbol","asyncIterator","reader","getReader","next","read","return","cancel","done","Fetcher","transport","locationUrlContext","buildAuthorizationHeader","Authorization","buildBody","log","buildJsonHeader","restOfRequest","ok","serializedBody","contentTypeHeaders","Accept","contentType","responseBody","DEVICE_ID_STORAGE_KEY$1","DeviceFields","DeviceInformation","appVersion","sdkVersion","platformVersion","DEFAULT_BASE_URL","App","idOrConfiguration","users","_locationUrl","configuration","baseUrl","skipLocationRequest","localApp","baseStorage","hydrate","getApp","appCache","instance","switchUser","nextUser","findIndex","splice","unshift","logIn","fetchProfile","createOrUpdateUser","removeUser","activeUsers","hostname","deviceIdStr","existingUser","LocalStorage","localStorage","global","getItem","setItem","removeItem","addEventListener","removeEventListener","DefaultStorage","open","environment$1","handleAuthRedirect","hash"],"mappings":"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","sourcesContent":["import { EJSON, ObjectId } from 'bson';\nimport * as bson from 'bson';\nexport { bson as BSON };\n\nvar __spreadArray = (undefined && undefined.__spreadArray) || function (to, from, pack) {\n    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\n        if (ar || !(i in from)) {\n            if (!ar) ar = Array.prototype.slice.call(from, 0, i);\n            ar[i] = from[i];\n        }\n    }\n    return to.concat(ar || Array.prototype.slice.call(from));\n};\nvar BrowserInfo = /** @class */ (function () {\n    function BrowserInfo(name, version, os) {\n        this.name = name;\n        this.version = version;\n        this.os = os;\n        this.type = 'browser';\n    }\n    return BrowserInfo;\n}());\nvar NodeInfo = /** @class */ (function () {\n    function NodeInfo(version) {\n        this.version = version;\n        this.type = 'node';\n        this.name = 'node';\n        this.os = process.platform;\n    }\n    return NodeInfo;\n}());\nvar SearchBotDeviceInfo = /** @class */ (function () {\n    function SearchBotDeviceInfo(name, version, os, bot) {\n        this.name = name;\n        this.version = version;\n        this.os = os;\n        this.bot = bot;\n        this.type = 'bot-device';\n    }\n    return SearchBotDeviceInfo;\n}());\nvar BotInfo = /** @class */ (function () {\n    function BotInfo() {\n        this.type = 'bot';\n        this.bot = true; // NOTE: deprecated test name instead\n        this.name = 'bot';\n        this.version = null;\n        this.os = null;\n    }\n    return BotInfo;\n}());\nvar ReactNativeInfo = /** @class */ (function () {\n    function ReactNativeInfo() {\n        this.type = 'react-native';\n        this.name = 'react-native';\n        this.version = null;\n        this.os = null;\n    }\n    return ReactNativeInfo;\n}());\n// tslint:disable-next-line:max-line-length\nvar SEARCHBOX_UA_REGEX = /alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/;\nvar SEARCHBOT_OS_REGEX = /(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\\ Jeeves\\/Teoma|ia_archiver)/;\nvar REQUIRED_VERSION_PARTS = 3;\nvar userAgentRules = [\n    ['aol', /AOLShield\\/([0-9\\._]+)/],\n    ['edge', /Edge\\/([0-9\\._]+)/],\n    ['edge-ios', /EdgiOS\\/([0-9\\._]+)/],\n    ['yandexbrowser', /YaBrowser\\/([0-9\\._]+)/],\n    ['kakaotalk', /KAKAOTALK\\s([0-9\\.]+)/],\n    ['samsung', /SamsungBrowser\\/([0-9\\.]+)/],\n    ['silk', /\\bSilk\\/([0-9._-]+)\\b/],\n    ['miui', /MiuiBrowser\\/([0-9\\.]+)$/],\n    ['beaker', /BeakerBrowser\\/([0-9\\.]+)/],\n    ['edge-chromium', /EdgA?\\/([0-9\\.]+)/],\n    [\n        'chromium-webview',\n        /(?!Chrom.*OPR)wv\\).*Chrom(?:e|ium)\\/([0-9\\.]+)(:?\\s|$)/,\n    ],\n    ['chrome', /(?!Chrom.*OPR)Chrom(?:e|ium)\\/([0-9\\.]+)(:?\\s|$)/],\n    ['phantomjs', /PhantomJS\\/([0-9\\.]+)(:?\\s|$)/],\n    ['crios', /CriOS\\/([0-9\\.]+)(:?\\s|$)/],\n    ['firefox', /Firefox\\/([0-9\\.]+)(?:\\s|$)/],\n    ['fxios', /FxiOS\\/([0-9\\.]+)/],\n    ['opera-mini', /Opera Mini.*Version\\/([0-9\\.]+)/],\n    ['opera', /Opera\\/([0-9\\.]+)(?:\\s|$)/],\n    ['opera', /OPR\\/([0-9\\.]+)(:?\\s|$)/],\n    ['ie', /Trident\\/7\\.0.*rv\\:([0-9\\.]+).*\\).*Gecko$/],\n    ['ie', /MSIE\\s([0-9\\.]+);.*Trident\\/[4-7].0/],\n    ['ie', /MSIE\\s(7\\.0)/],\n    ['bb10', /BB10;\\sTouch.*Version\\/([0-9\\.]+)/],\n    ['android', /Android\\s([0-9\\.]+)/],\n    ['ios', /Version\\/([0-9\\._]+).*Mobile.*Safari.*/],\n    ['safari', /Version\\/([0-9\\._]+).*Safari/],\n    ['facebook', /FB[AS]V\\/([0-9\\.]+)/],\n    ['instagram', /Instagram\\s([0-9\\.]+)/],\n    ['ios-webview', /AppleWebKit\\/([0-9\\.]+).*Mobile/],\n    ['ios-webview', /AppleWebKit\\/([0-9\\.]+).*Gecko\\)$/],\n    ['curl', /^curl\\/([0-9\\.]+)$/],\n    ['searchbot', SEARCHBOX_UA_REGEX],\n];\nvar operatingSystemRules = [\n    ['iOS', /iP(hone|od|ad)/],\n    ['Android OS', /Android/],\n    ['BlackBerry OS', /BlackBerry|BB10/],\n    ['Windows Mobile', /IEMobile/],\n    ['Amazon OS', /Kindle/],\n    ['Windows 3.11', /Win16/],\n    ['Windows 95', /(Windows 95)|(Win95)|(Windows_95)/],\n    ['Windows 98', /(Windows 98)|(Win98)/],\n    ['Windows 2000', /(Windows NT 5.0)|(Windows 2000)/],\n    ['Windows XP', /(Windows NT 5.1)|(Windows XP)/],\n    ['Windows Server 2003', /(Windows NT 5.2)/],\n    ['Windows Vista', /(Windows NT 6.0)/],\n    ['Windows 7', /(Windows NT 6.1)/],\n    ['Windows 8', /(Windows NT 6.2)/],\n    ['Windows 8.1', /(Windows NT 6.3)/],\n    ['Windows 10', /(Windows NT 10.0)/],\n    ['Windows ME', /Windows ME/],\n    ['Open BSD', /OpenBSD/],\n    ['Sun OS', /SunOS/],\n    ['Chrome OS', /CrOS/],\n    ['Linux', /(Linux)|(X11)/],\n    ['Mac OS', /(Mac_PowerPC)|(Macintosh)/],\n    ['QNX', /QNX/],\n    ['BeOS', /BeOS/],\n    ['OS/2', /OS\\/2/],\n];\nfunction detect(userAgent) {\n    if (!!userAgent) {\n        return parseUserAgent(userAgent);\n    }\n    if (typeof document === 'undefined' &&\n        typeof navigator !== 'undefined' &&\n        navigator.product === 'ReactNative') {\n        return new ReactNativeInfo();\n    }\n    if (typeof navigator !== 'undefined') {\n        return parseUserAgent(navigator.userAgent);\n    }\n    return getNodeVersion();\n}\nfunction matchUserAgent(ua) {\n    // opted for using reduce here rather than Array#first with a regex.test call\n    // this is primarily because using the reduce we only perform the regex\n    // execution once rather than once for the test and for the exec again below\n    // probably something that needs to be benchmarked though\n    return (ua !== '' &&\n        userAgentRules.reduce(function (matched, _a) {\n            var browser = _a[0], regex = _a[1];\n            if (matched) {\n                return matched;\n            }\n            var uaMatch = regex.exec(ua);\n            return !!uaMatch && [browser, uaMatch];\n        }, false));\n}\nfunction parseUserAgent(ua) {\n    var matchedRule = matchUserAgent(ua);\n    if (!matchedRule) {\n        return null;\n    }\n    var name = matchedRule[0], match = matchedRule[1];\n    if (name === 'searchbot') {\n        return new BotInfo();\n    }\n    // Do not use RegExp for split operation as some browser do not support it (See: http://blog.stevenlevithan.com/archives/cross-browser-split)\n    var versionParts = match[1] && match[1].split('.').join('_').split('_').slice(0, 3);\n    if (versionParts) {\n        if (versionParts.length < REQUIRED_VERSION_PARTS) {\n            versionParts = __spreadArray(__spreadArray([], versionParts, true), createVersionParts(REQUIRED_VERSION_PARTS - versionParts.length), true);\n        }\n    }\n    else {\n        versionParts = [];\n    }\n    var version = versionParts.join('.');\n    var os = detectOS(ua);\n    var searchBotMatch = SEARCHBOT_OS_REGEX.exec(ua);\n    if (searchBotMatch && searchBotMatch[1]) {\n        return new SearchBotDeviceInfo(name, version, os, searchBotMatch[1]);\n    }\n    return new BrowserInfo(name, version, os);\n}\nfunction detectOS(ua) {\n    for (var ii = 0, count = operatingSystemRules.length; ii < count; ii++) {\n        var _a = operatingSystemRules[ii], os = _a[0], regex = _a[1];\n        var match = regex.exec(ua);\n        if (match) {\n            return os;\n        }\n    }\n    return null;\n}\nfunction getNodeVersion() {\n    var isNode = typeof process !== 'undefined' && process.version;\n    return isNode ? new NodeInfo(process.version.slice(1)) : null;\n}\nfunction createVersionParts(count) {\n    var output = [];\n    for (var ii = 0; ii < count; ii++) {\n        output.push('0');\n    }\n    return output;\n}\n\n////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\nclass DefaultNetworkTransport {\n    constructor() {\n        if (!DefaultNetworkTransport.fetch) {\n            throw new Error(\"DefaultNetworkTransport.fetch must be set before it's used\");\n        }\n        if (!DefaultNetworkTransport.AbortController) {\n            throw new Error(\"DefaultNetworkTransport.AbortController must be set before it's used\");\n        }\n    }\n    fetchWithCallbacks(request, handler) {\n        // tslint:disable-next-line: no-console\n        this.fetch(request)\n            .then(async (response) => {\n            const decodedBody = await response.text();\n            // Pull out the headers of the response\n            const responseHeaders = {};\n            response.headers.forEach((value, key) => {\n                responseHeaders[key] = value;\n            });\n            return {\n                statusCode: response.status,\n                headers: responseHeaders,\n                body: decodedBody,\n            };\n        })\n            .then((r) => handler.onSuccess(r))\n            .catch((e) => handler.onError(e));\n    }\n    async fetch(request) {\n        const { timeoutMs, url, ...rest } = request;\n        const { signal, cancelTimeout } = this.createTimeoutSignal(timeoutMs);\n        try {\n            // We'll await the response to catch throw our own error\n            return await DefaultNetworkTransport.fetch(url, {\n                signal,\n                ...rest,\n            });\n        }\n        finally {\n            // Whatever happens, cancel any timeout\n            cancelTimeout();\n        }\n    }\n    createTimeoutSignal(timeoutMs) {\n        if (typeof timeoutMs === \"number\") {\n            const controller = new DefaultNetworkTransport.AbortController();\n            // Call abort after a specific number of milliseconds\n            const timeout = setTimeout(() => {\n                controller.abort();\n            }, timeoutMs);\n            return {\n                signal: controller.signal,\n                cancelTimeout: () => {\n                    clearTimeout(timeout);\n                },\n            };\n        }\n        else {\n            return {\n                signal: undefined,\n                cancelTimeout: () => {\n                    /* No-op */\n                },\n            };\n        }\n    }\n}\nDefaultNetworkTransport.DEFAULT_HEADERS = {\n    \"Content-Type\": \"application/json\",\n};\n\n////////////////////////////////////////////////////////////////////////////\nDefaultNetworkTransport.fetch = globalThis.fetch.bind(globalThis);\nDefaultNetworkTransport.AbortController = globalThis.AbortController;\n\n/**\n *  base64.ts\n *\n *  Licensed under the BSD 3-Clause License.\n *    http://opensource.org/licenses/BSD-3-Clause\n *\n *  References:\n *    http://en.wikipedia.org/wiki/Base64\n *\n * @author Dan Kogai (https://github.com/dankogai)\n */\nconst version = '3.7.2';\n/**\n * @deprecated use lowercase `version`.\n */\nconst VERSION = version;\nconst _hasatob = typeof atob === 'function';\nconst _hasbtoa = typeof btoa === 'function';\nconst _hasBuffer = typeof Buffer === 'function';\nconst _TD = typeof TextDecoder === 'function' ? new TextDecoder() : undefined;\nconst _TE = typeof TextEncoder === 'function' ? new TextEncoder() : undefined;\nconst b64ch = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';\nconst b64chs = Array.prototype.slice.call(b64ch);\nconst b64tab = ((a) => {\n    let tab = {};\n    a.forEach((c, i) => tab[c] = i);\n    return tab;\n})(b64chs);\nconst b64re = /^(?:[A-Za-z\\d+\\/]{4})*?(?:[A-Za-z\\d+\\/]{2}(?:==)?|[A-Za-z\\d+\\/]{3}=?)?$/;\nconst _fromCC = String.fromCharCode.bind(String);\nconst _U8Afrom = typeof Uint8Array.from === 'function'\n    ? Uint8Array.from.bind(Uint8Array)\n    : (it, fn = (x) => x) => new Uint8Array(Array.prototype.slice.call(it, 0).map(fn));\nconst _mkUriSafe = (src) => src\n    .replace(/=/g, '').replace(/[+\\/]/g, (m0) => m0 == '+' ? '-' : '_');\nconst _tidyB64 = (s) => s.replace(/[^A-Za-z0-9\\+\\/]/g, '');\n/**\n * polyfill version of `btoa`\n */\nconst btoaPolyfill = (bin) => {\n    // console.log('polyfilled');\n    let u32, c0, c1, c2, asc = '';\n    const pad = bin.length % 3;\n    for (let i = 0; i < bin.length;) {\n        if ((c0 = bin.charCodeAt(i++)) > 255 ||\n            (c1 = bin.charCodeAt(i++)) > 255 ||\n            (c2 = bin.charCodeAt(i++)) > 255)\n            throw new TypeError('invalid character found');\n        u32 = (c0 << 16) | (c1 << 8) | c2;\n        asc += b64chs[u32 >> 18 & 63]\n            + b64chs[u32 >> 12 & 63]\n            + b64chs[u32 >> 6 & 63]\n            + b64chs[u32 & 63];\n    }\n    return pad ? asc.slice(0, pad - 3) + \"===\".substring(pad) : asc;\n};\n/**\n * does what `window.btoa` of web browsers do.\n * @param {String} bin binary string\n * @returns {string} Base64-encoded string\n */\nconst _btoa = _hasbtoa ? (bin) => btoa(bin)\n    : _hasBuffer ? (bin) => Buffer.from(bin, 'binary').toString('base64')\n        : btoaPolyfill;\nconst _fromUint8Array = _hasBuffer\n    ? (u8a) => Buffer.from(u8a).toString('base64')\n    : (u8a) => {\n        // cf. https://stackoverflow.com/questions/12710001/how-to-convert-uint8-array-to-base64-encoded-string/12713326#12713326\n        const maxargs = 0x1000;\n        let strs = [];\n        for (let i = 0, l = u8a.length; i < l; i += maxargs) {\n            strs.push(_fromCC.apply(null, u8a.subarray(i, i + maxargs)));\n        }\n        return _btoa(strs.join(''));\n    };\n/**\n * converts a Uint8Array to a Base64 string.\n * @param {boolean} [urlsafe] URL-and-filename-safe a la RFC4648 ยง5\n * @returns {string} Base64 string\n */\nconst fromUint8Array = (u8a, urlsafe = false) => urlsafe ? _mkUriSafe(_fromUint8Array(u8a)) : _fromUint8Array(u8a);\n// This trick is found broken https://github.com/dankogai/js-base64/issues/130\n// const utob = (src: string) => unescape(encodeURIComponent(src));\n// reverting good old fationed regexp\nconst cb_utob = (c) => {\n    if (c.length < 2) {\n        var cc = c.charCodeAt(0);\n        return cc < 0x80 ? c\n            : cc < 0x800 ? (_fromCC(0xc0 | (cc >>> 6))\n                + _fromCC(0x80 | (cc & 0x3f)))\n                : (_fromCC(0xe0 | ((cc >>> 12) & 0x0f))\n                    + _fromCC(0x80 | ((cc >>> 6) & 0x3f))\n                    + _fromCC(0x80 | (cc & 0x3f)));\n    }\n    else {\n        var cc = 0x10000\n            + (c.charCodeAt(0) - 0xD800) * 0x400\n            + (c.charCodeAt(1) - 0xDC00);\n        return (_fromCC(0xf0 | ((cc >>> 18) & 0x07))\n            + _fromCC(0x80 | ((cc >>> 12) & 0x3f))\n            + _fromCC(0x80 | ((cc >>> 6) & 0x3f))\n            + _fromCC(0x80 | (cc & 0x3f)));\n    }\n};\nconst re_utob = /[\\uD800-\\uDBFF][\\uDC00-\\uDFFFF]|[^\\x00-\\x7F]/g;\n/**\n * @deprecated should have been internal use only.\n * @param {string} src UTF-8 string\n * @returns {string} UTF-16 string\n */\nconst utob = (u) => u.replace(re_utob, cb_utob);\n//\nconst _encode = _hasBuffer\n    ? (s) => Buffer.from(s, 'utf8').toString('base64')\n    : _TE\n        ? (s) => _fromUint8Array(_TE.encode(s))\n        : (s) => _btoa(utob(s));\n/**\n * converts a UTF-8-encoded string to a Base64 string.\n * @param {boolean} [urlsafe] if `true` make the result URL-safe\n * @returns {string} Base64 string\n */\nconst encode = (src, urlsafe = false) => urlsafe\n    ? _mkUriSafe(_encode(src))\n    : _encode(src);\n/**\n * converts a UTF-8-encoded string to URL-safe Base64 RFC4648 ยง5.\n * @returns {string} Base64 string\n */\nconst encodeURI = (src) => encode(src, true);\n// This trick is found broken https://github.com/dankogai/js-base64/issues/130\n// const btou = (src: string) => decodeURIComponent(escape(src));\n// reverting good old fationed regexp\nconst re_btou = /[\\xC0-\\xDF][\\x80-\\xBF]|[\\xE0-\\xEF][\\x80-\\xBF]{2}|[\\xF0-\\xF7][\\x80-\\xBF]{3}/g;\nconst cb_btou = (cccc) => {\n    switch (cccc.length) {\n        case 4:\n            var cp = ((0x07 & cccc.charCodeAt(0)) << 18)\n                | ((0x3f & cccc.charCodeAt(1)) << 12)\n                | ((0x3f & cccc.charCodeAt(2)) << 6)\n                | (0x3f & cccc.charCodeAt(3)), offset = cp - 0x10000;\n            return (_fromCC((offset >>> 10) + 0xD800)\n                + _fromCC((offset & 0x3FF) + 0xDC00));\n        case 3:\n            return _fromCC(((0x0f & cccc.charCodeAt(0)) << 12)\n                | ((0x3f & cccc.charCodeAt(1)) << 6)\n                | (0x3f & cccc.charCodeAt(2)));\n        default:\n            return _fromCC(((0x1f & cccc.charCodeAt(0)) << 6)\n                | (0x3f & cccc.charCodeAt(1)));\n    }\n};\n/**\n * @deprecated should have been internal use only.\n * @param {string} src UTF-16 string\n * @returns {string} UTF-8 string\n */\nconst btou = (b) => b.replace(re_btou, cb_btou);\n/**\n * polyfill version of `atob`\n */\nconst atobPolyfill = (asc) => {\n    // console.log('polyfilled');\n    asc = asc.replace(/\\s+/g, '');\n    if (!b64re.test(asc))\n        throw new TypeError('malformed base64.');\n    asc += '=='.slice(2 - (asc.length & 3));\n    let u24, bin = '', r1, r2;\n    for (let i = 0; i < asc.length;) {\n        u24 = b64tab[asc.charAt(i++)] << 18\n            | b64tab[asc.charAt(i++)] << 12\n            | (r1 = b64tab[asc.charAt(i++)]) << 6\n            | (r2 = b64tab[asc.charAt(i++)]);\n        bin += r1 === 64 ? _fromCC(u24 >> 16 & 255)\n            : r2 === 64 ? _fromCC(u24 >> 16 & 255, u24 >> 8 & 255)\n                : _fromCC(u24 >> 16 & 255, u24 >> 8 & 255, u24 & 255);\n    }\n    return bin;\n};\n/**\n * does what `window.atob` of web browsers do.\n * @param {String} asc Base64-encoded string\n * @returns {string} binary string\n */\nconst _atob = _hasatob ? (asc) => atob(_tidyB64(asc))\n    : _hasBuffer ? (asc) => Buffer.from(asc, 'base64').toString('binary')\n        : atobPolyfill;\n//\nconst _toUint8Array = _hasBuffer\n    ? (a) => _U8Afrom(Buffer.from(a, 'base64'))\n    : (a) => _U8Afrom(_atob(a), c => c.charCodeAt(0));\n/**\n * converts a Base64 string to a Uint8Array.\n */\nconst toUint8Array = (a) => _toUint8Array(_unURI(a));\n//\nconst _decode = _hasBuffer\n    ? (a) => Buffer.from(a, 'base64').toString('utf8')\n    : _TD\n        ? (a) => _TD.decode(_toUint8Array(a))\n        : (a) => btou(_atob(a));\nconst _unURI = (a) => _tidyB64(a.replace(/[-_]/g, (m0) => m0 == '-' ? '+' : '/'));\n/**\n * converts a Base64 string to a UTF-8 string.\n * @param {String} src Base64 string.  Both normal and URL-safe are supported\n * @returns {string} UTF-8 string\n */\nconst decode = (src) => _decode(_unURI(src));\n/**\n * check if a value is a valid Base64 string\n * @param {String} src a value to check\n  */\nconst isValid = (src) => {\n    if (typeof src !== 'string')\n        return false;\n    const s = src.replace(/\\s+/g, '').replace(/={0,2}$/, '');\n    return !/[^\\s0-9a-zA-Z\\+/]/.test(s) || !/[^\\s0-9a-zA-Z\\-_]/.test(s);\n};\n//\nconst _noEnum = (v) => {\n    return {\n        value: v, enumerable: false, writable: true, configurable: true\n    };\n};\n/**\n * extend String.prototype with relevant methods\n */\nconst extendString = function () {\n    const _add = (name, body) => Object.defineProperty(String.prototype, name, _noEnum(body));\n    _add('fromBase64', function () { return decode(this); });\n    _add('toBase64', function (urlsafe) { return encode(this, urlsafe); });\n    _add('toBase64URI', function () { return encode(this, true); });\n    _add('toBase64URL', function () { return encode(this, true); });\n    _add('toUint8Array', function () { return toUint8Array(this); });\n};\n/**\n * extend Uint8Array.prototype with relevant methods\n */\nconst extendUint8Array = function () {\n    const _add = (name, body) => Object.defineProperty(Uint8Array.prototype, name, _noEnum(body));\n    _add('toBase64', function (urlsafe) { return fromUint8Array(this, urlsafe); });\n    _add('toBase64URI', function () { return fromUint8Array(this, true); });\n    _add('toBase64URL', function () { return fromUint8Array(this, true); });\n};\n/**\n * extend Builtin prototypes with relevant methods\n */\nconst extendBuiltins = () => {\n    extendString();\n    extendUint8Array();\n};\nconst gBase64 = {\n    version: version,\n    VERSION: VERSION,\n    atob: _atob,\n    atobPolyfill: atobPolyfill,\n    btoa: _btoa,\n    btoaPolyfill: btoaPolyfill,\n    fromBase64: decode,\n    toBase64: encode,\n    encode: encode,\n    encodeURI: encodeURI,\n    encodeURL: encodeURI,\n    utob: utob,\n    btou: btou,\n    decode: decode,\n    isValid: isValid,\n    fromUint8Array: fromUint8Array,\n    toUint8Array: toUint8Array,\n    extendString: extendString,\n    extendUint8Array: extendUint8Array,\n    extendBuiltins: extendBuiltins,\n};\n\n////////////////////////////////////////////////////////////////////////////\nconst SERIALIZATION_OPTIONS = {\n    relaxed: false, // Ensure Canonical mode\n};\n/**\n * Serialize an object containing BSON types into extended-JSON.\n *\n * @param obj The object containing BSON types.\n * @returns The document in extended-JSON format.\n */\nfunction serialize(obj) {\n    return EJSON.serialize(obj, SERIALIZATION_OPTIONS);\n}\n/**\n * De-serialize an object or an array of object from extended-JSON into an object or an array of object with BSON types.\n *\n * @param obj The object or array of objects in extended-JSON format.\n * @returns The object or array of objects with inflated BSON types.\n */\nfunction deserialize(obj) {\n    if (Array.isArray(obj)) {\n        return obj.map((doc) => EJSON.deserialize(doc));\n    }\n    else {\n        return EJSON.deserialize(obj);\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n/**\n * The type of a user.\n */\nvar UserType;\n(function (UserType) {\n    /**\n     * A normal end-user created this user.\n     */\n    UserType[\"Normal\"] = \"normal\";\n    /**\n     * The user was created by the server.\n     */\n    UserType[\"Server\"] = \"server\";\n})(UserType || (UserType = {}));\n/** @ignore */\nvar DataKey;\n(function (DataKey) {\n    /** @ignore */\n    DataKey[\"NAME\"] = \"name\";\n    /** @ignore */\n    DataKey[\"EMAIL\"] = \"email\";\n    /** @ignore */\n    DataKey[\"PICTURE\"] = \"picture\";\n    /** @ignore */\n    DataKey[\"FIRST_NAME\"] = \"first_name\";\n    /** @ignore */\n    DataKey[\"LAST_NAME\"] = \"last_name\";\n    /** @ignore */\n    DataKey[\"GENDER\"] = \"gender\";\n    /** @ignore */\n    DataKey[\"BIRTHDAY\"] = \"birthday\";\n    /** @ignore */\n    DataKey[\"MIN_AGE\"] = \"min_age\";\n    /** @ignore */\n    DataKey[\"MAX_AGE\"] = \"max_age\";\n})(DataKey || (DataKey = {}));\nconst DATA_MAPPING = {\n    [DataKey.NAME]: \"name\",\n    [DataKey.EMAIL]: \"email\",\n    [DataKey.PICTURE]: \"pictureUrl\",\n    [DataKey.FIRST_NAME]: \"firstName\",\n    [DataKey.LAST_NAME]: \"lastName\",\n    [DataKey.GENDER]: \"gender\",\n    [DataKey.BIRTHDAY]: \"birthday\",\n    [DataKey.MIN_AGE]: \"minAge\",\n    [DataKey.MAX_AGE]: \"maxAge\",\n};\n/** @inheritdoc */\nclass UserProfile {\n    /**\n     * @param response The response of a call fetching the users profile.\n     */\n    constructor(response) {\n        /** @ignore */\n        this.type = UserType.Normal;\n        /** @ignore */\n        this.identities = [];\n        if (typeof response === \"object\" && response !== null) {\n            const { type, identities, data } = response;\n            if (typeof type === \"string\") {\n                this.type = type;\n            }\n            else {\n                throw new Error(\"Expected 'type' in the response body\");\n            }\n            if (Array.isArray(identities)) {\n                this.identities = identities.map((identity) => {\n                    const { id, provider_type: providerType } = identity;\n                    return { id, providerType };\n                });\n            }\n            else {\n                throw new Error(\"Expected 'identities' in the response body\");\n            }\n            if (typeof data === \"object\" && data !== null) {\n                const mappedData = Object.fromEntries(Object.entries(data).map(([key, value]) => {\n                    if (key in DATA_MAPPING) {\n                        // Translate any known data field to its JS idiomatic alias\n                        return [DATA_MAPPING[key], value];\n                    }\n                    else {\n                        // Pass through any other values\n                        return [key, value];\n                    }\n                }));\n                // We can use `any` since we trust the user supplies the correct type\n                this.data = deserialize(mappedData);\n            }\n            else {\n                throw new Error(\"Expected 'data' in the response body\");\n            }\n        }\n        else {\n            this.data = {};\n        }\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n/**\n * A `Storage` which will prefix a key part to every operation.\n */\nclass PrefixedStorage {\n    /**\n     * Construct a `Storage` which will prefix a key part to every operation.\n     *\n     * @param storage The underlying storage to use for operations.\n     * @param keyPart The part of the key to prefix when performing operations.\n     */\n    constructor(storage, keyPart) {\n        this.storage = storage;\n        this.keyPart = keyPart;\n    }\n    /** @inheritdoc */\n    get(key) {\n        return this.storage.get(this.keyPart + PrefixedStorage.PART_SEPARATOR + key);\n    }\n    /** @inheritdoc */\n    set(key, value) {\n        return this.storage.set(this.keyPart + PrefixedStorage.PART_SEPARATOR + key, value);\n    }\n    /** @inheritdoc */\n    remove(key) {\n        return this.storage.remove(this.keyPart + PrefixedStorage.PART_SEPARATOR + key);\n    }\n    /** @inheritdoc */\n    prefix(keyPart) {\n        return new PrefixedStorage(this, keyPart);\n    }\n    /** @inheritdoc */\n    clear(prefix = \"\") {\n        return this.storage.clear(this.keyPart + PrefixedStorage.PART_SEPARATOR + prefix);\n    }\n    /** @inheritdoc */\n    addListener(listener) {\n        return this.storage.addListener(listener);\n    }\n    /** @inheritdoc */\n    removeListener(listener) {\n        return this.storage.addListener(listener);\n    }\n}\n/**\n * The string separating two parts.\n */\nPrefixedStorage.PART_SEPARATOR = \":\";\n\n////////////////////////////////////////////////////////////////////////////\n/**\n * In-memory storage that will not be persisted.\n */\nclass MemoryStorage {\n    constructor() {\n        /**\n         * Internal state of the storage.\n         */\n        this.storage = {};\n        /**\n         * A set of listners.\n         */\n        this.listeners = new Set();\n    }\n    /** @inheritdoc */\n    get(key) {\n        if (key in this.storage) {\n            return this.storage[key];\n        }\n        else {\n            return null;\n        }\n    }\n    /** @inheritdoc */\n    set(key, value) {\n        this.storage[key] = value;\n        // Fire the listeners\n        this.fireListeners();\n    }\n    /** @inheritdoc */\n    remove(key) {\n        delete this.storage[key];\n        // Fire the listeners\n        this.fireListeners();\n    }\n    /** @inheritdoc */\n    prefix(keyPart) {\n        return new PrefixedStorage(this, keyPart);\n    }\n    /** @inheritdoc */\n    clear(prefix) {\n        // Iterate all keys and delete their values if they have a matching prefix\n        for (const key of Object.keys(this.storage)) {\n            if (!prefix || key.startsWith(prefix)) {\n                delete this.storage[key];\n            }\n        }\n        // Fire the listeners\n        this.fireListeners();\n    }\n    /** @inheritdoc */\n    addListener(listener) {\n        this.listeners.add(listener);\n    }\n    /** @inheritdoc */\n    removeListener(listener) {\n        this.listeners.delete(listener);\n    }\n    /**\n     * Tell the listeners that a change occurred.\n     */\n    fireListeners() {\n        this.listeners.forEach((listener) => listener());\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\nconst ACCESS_TOKEN_STORAGE_KEY = \"accessToken\";\nconst REFRESH_TOKEN_STORAGE_KEY = \"refreshToken\";\nconst PROFILE_STORAGE_KEY = \"profile\";\nconst PROVIDER_TYPE_STORAGE_KEY = \"providerType\";\n/**\n * Storage specific to the app.\n */\nclass UserStorage extends PrefixedStorage {\n    /**\n     * Construct a storage for a `User`.\n     *\n     * @param storage The underlying storage to wrap.\n     * @param userId The id of the user.\n     */\n    constructor(storage, userId) {\n        super(storage, `user(${userId})`);\n    }\n    /**\n     * Get the access token from storage.\n     *\n     * @returns Access token (null if unknown).\n     */\n    get accessToken() {\n        return this.get(ACCESS_TOKEN_STORAGE_KEY);\n    }\n    /**\n     * Set the access token in storage.\n     *\n     * @param value Access token (null if unknown).\n     */\n    set accessToken(value) {\n        if (value === null) {\n            this.remove(ACCESS_TOKEN_STORAGE_KEY);\n        }\n        else {\n            this.set(ACCESS_TOKEN_STORAGE_KEY, value);\n        }\n    }\n    /**\n     * Get the refresh token from storage.\n     *\n     * @returns Refresh token (null if unknown and user is logged out).\n     */\n    get refreshToken() {\n        return this.get(REFRESH_TOKEN_STORAGE_KEY);\n    }\n    /**\n     * Set the refresh token in storage.\n     *\n     * @param value Refresh token (null if unknown and user is logged out).\n     */\n    set refreshToken(value) {\n        if (value === null) {\n            this.remove(REFRESH_TOKEN_STORAGE_KEY);\n        }\n        else {\n            this.set(REFRESH_TOKEN_STORAGE_KEY, value);\n        }\n    }\n    /**\n     * Get the user profile from storage.\n     *\n     * @returns User profile (undefined if its unknown).\n     */\n    get profile() {\n        const value = this.get(PROFILE_STORAGE_KEY);\n        if (value) {\n            const profile = new UserProfile();\n            // Patch in the values\n            Object.assign(profile, JSON.parse(value));\n            return profile;\n        }\n    }\n    /**\n     * Set the user profile in storage.\n     *\n     * @param value User profile (undefined if its unknown).\n     */\n    set profile(value) {\n        if (value) {\n            this.set(PROFILE_STORAGE_KEY, JSON.stringify(value));\n        }\n        else {\n            this.remove(PROFILE_STORAGE_KEY);\n        }\n    }\n    /**\n     * Get the type of authentication provider used to authenticate\n     *\n     * @returns User profile (undefined if its unknown).\n     */\n    get providerType() {\n        const value = this.get(PROVIDER_TYPE_STORAGE_KEY);\n        if (value) {\n            return value;\n        }\n    }\n    /**\n     * Set the type of authentication provider used to authenticate\n     *\n     * @param value Type of authentication provider.\n     */\n    set providerType(value) {\n        if (value) {\n            this.set(PROVIDER_TYPE_STORAGE_KEY, value);\n        }\n        else {\n            this.remove(PROVIDER_TYPE_STORAGE_KEY);\n        }\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n/**\n * @param obj The object to remove keys (and undefined values from)\n * @returns A new object without the keys where the value is undefined.\n */\nfunction removeKeysWithUndefinedValues(obj) {\n    return Object.fromEntries(Object.entries(obj).filter((entry) => typeof entry[1] !== \"undefined\"));\n}\n\n////////////////////////////////////////////////////////////////////////////\n/**\n * Generate a random sequence of characters.\n *\n * @param length The length of the string.\n * @param alphabet The alphabet of characters to pick from.\n * @returns A string of characters picked randomly from `alphabet`.\n */\nfunction generateRandomString(length, alphabet) {\n    let result = \"\";\n    for (let i = 0; i < length; i++) {\n        result += alphabet[Math.floor(Math.random() * alphabet.length)];\n    }\n    return result;\n}\n/**\n * Encode an object mapping from string to string, into a query string to be appended a URL.\n *\n * @param params The parameters to include in the string.\n * @param prefixed Should the \"?\" prefix be added if values exists?\n * @returns A URL encoded representation of the parameters (omitting a \"?\" prefix).\n */\nfunction encodeQueryString(params, prefixed = true) {\n    // Filter out undefined values\n    const cleanedParams = removeKeysWithUndefinedValues(params);\n    // Determine if a prefixed \"?\" is appropreate\n    const prefix = prefixed && Object.keys(cleanedParams).length > 0 ? \"?\" : \"\";\n    // Transform keys and values to a query string\n    return (prefix +\n        Object.entries(cleanedParams)\n            .map(([k, v]) => `${k}=${encodeURIComponent(v)}`)\n            .join(\"&\"));\n}\n/**\n * Decodes a query string into an object.\n *\n * @param str The query string to decode.\n * @returns The decoded query string.\n */\nfunction decodeQueryString(str) {\n    const cleanStr = str[0] === \"?\" ? str.substr(1) : str;\n    return Object.fromEntries(cleanStr\n        .split(\"&\")\n        .filter((s) => s.length > 0)\n        .map((kvp) => kvp.split(\"=\"))\n        .map(([k, v]) => [k, decodeURIComponent(v)]));\n}\n\n////////////////////////////////////////////////////////////////////////////\n/**\n * A list of names that functions cannot have to be callable through the functions proxy.\n */\nconst RESERVED_NAMES = [\n    \"inspect\",\n    \"callFunction\",\n    \"callFunctionStreaming\",\n    // Methods defined on the Object.prototype might be \"typeof probed\" and called by libraries and runtime environments.\n    ...Object.getOwnPropertyNames(Object.prototype),\n];\n/**\n * Remove the key for any fields with undefined values.\n *\n * @param args The arguments to clean.\n * @returns The cleaned arguments.\n */\nfunction cleanArgs(args) {\n    for (const arg of args) {\n        if (typeof arg === \"object\" && arg) {\n            for (const [key, value] of Object.entries(arg)) {\n                if (value === undefined) {\n                    delete arg[key];\n                }\n            }\n        }\n    }\n    return args;\n}\n/**\n * Remove keys for any undefined values and serialize to EJSON.\n *\n * @param args The arguments to clean and serialize.\n * @returns The cleaned and serialized arguments.\n */\nfunction cleanArgsAndSerialize(args) {\n    const cleaned = cleanArgs(args);\n    return cleaned.map((arg) => (typeof arg === \"object\" ? serialize(arg) : arg));\n}\n/**\n * Defines how functions are called.\n */\nclass FunctionsFactory {\n    /**\n     * @param fetcher The underlying fetcher to use when sending requests.\n     * @param config Additional configuration parameters.\n     */\n    constructor(fetcher, config = {}) {\n        this.fetcher = fetcher;\n        this.serviceName = config.serviceName;\n        this.argsTransformation = config.argsTransformation || cleanArgsAndSerialize;\n    }\n    /**\n     * Create a factory of functions, wrapped in a Proxy that returns bound copies of `callFunction` on any property.\n     *\n     * @param fetcher The underlying fetcher to use when requesting.\n     * @param config Additional configuration parameters.\n     * @returns The newly created factory of functions.\n     */\n    static create(fetcher, config = {}) {\n        // Create a proxy, wrapping a simple object returning methods that calls functions\n        // TODO: Lazily fetch available functions and return these from the ownKeys() trap\n        const factory = new FunctionsFactory(fetcher, config);\n        // Wrap the factory in a proxy that calls the internal call method\n        return new Proxy(factory, {\n            get(target, p, receiver) {\n                if (typeof p === \"string\" && RESERVED_NAMES.indexOf(p) === -1) {\n                    return target.callFunction.bind(target, p);\n                }\n                else {\n                    const prop = Reflect.get(target, p, receiver);\n                    return typeof prop === \"function\" ? prop.bind(target) : prop;\n                }\n            },\n        });\n    }\n    /**\n     * Call a remote function by it's name.\n     *\n     * @param name Name of the remote function.\n     * @param args Arguments to pass to the remote function.\n     * @returns A promise of the value returned when executing the remote function.\n     */\n    async callFunction(name, ...args) {\n        // See https://github.com/mongodb/stitch-js-sdk/blob/master/packages/core/sdk/src/services/internal/CoreStitchServiceClientImpl.ts\n        const body = {\n            name,\n            arguments: this.argsTransformation ? this.argsTransformation(args) : args,\n        };\n        if (this.serviceName) {\n            body.service = this.serviceName;\n        }\n        const appRoute = this.fetcher.appRoute;\n        return this.fetcher.fetchJSON({\n            method: \"POST\",\n            path: appRoute.functionsCall().path,\n            body,\n        });\n    }\n    /**\n     * Call a remote function by it's name.\n     *\n     * @param name Name of the remote function.\n     * @param args Arguments to pass to the remote function.\n     * @returns A promise of the value returned when executing the remote function.\n     */\n    callFunctionStreaming(name, ...args) {\n        const body = {\n            name,\n            arguments: this.argsTransformation ? this.argsTransformation(args) : args,\n        };\n        if (this.serviceName) {\n            body.service = this.serviceName;\n        }\n        const appRoute = this.fetcher.appRoute;\n        const qs = encodeQueryString({\n            [\"baas_request\"]: gBase64.encode(JSON.stringify(body)),\n        });\n        return this.fetcher.fetchStream({\n            method: \"GET\",\n            path: appRoute.functionsCall().path + qs,\n        });\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2021 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n/**\n * Check whether the user's app is running in \"development mode\" (e.g. `npm run dev`\n * for a React app, or `NODE_ENV=development` for a Node app). Each platform's entry\n * point should define the value of this using `setIsDevelopmentMode`.\n * The default behaviour is to always return `false`.\n *\n * @returns true if the user's app is running in development mode, false otherwise\n */\nlet isDevelopmentMode = false;\n/**\n * Set the value of `isDevelopmentMode`. This allows each entry point (node vs DOM)\n * to use its own method for determining whether we are in development mode.\n *\n * @param state A boolean indicating whether the user's app is running in\n * development mode or not.\n */\nconst setIsDevelopmentMode = (state) => {\n    isDevelopmentMode = state;\n};\n\n////////////////////////////////////////////////////////////////////////////\n/**\n * Display a deprecation warning for features being removed in the next major version\n * to users in development mode (as best as we can detect this, see `isDevelopmentMode`)\n *\n * @param deprecatedItem The method signature or name of the deprecated item\n * @param suggestedReplacement The method signature or name of the suggested replacement\n */\nconst deprecationWarning = (deprecatedItem, suggestedReplacement) => {\n    if (!isDevelopmentMode)\n        return;\n    console.warn(`Deprecation warning from Realm: ${deprecatedItem} is deprecated and will be removed in a future major release. Consider switching to ${suggestedReplacement}.`);\n};\n/**\n * Helper function for migrating from positional arguments to a single dictionary argument.\n * Check the arguments passed to a function, if the first argument is not an object (i.e. it\n * is presumed to be a deprecated positional-style call), shows a deprecation warning and\n * converts the positional arguments into an object matching the expected \"new\" shape.\n *\n * @param args Array of arguments passed to the function (captured with `...args`).\n * @param methodName The name of the method, used to show the deprecation warning.\n * @param argNames The list of positional argument names, used to covert them into\n * an object if a deprecated call is made and to show the deprecation warning.\n * @param hasRestArgs Optional flag indicating that the function's final argument is\n * `...args` (to capture any extra arguments), in which case we capture them and return\n * as the second element of the return array.\n *\n * @returns An object containing:\n *\n * argsObject: a dictionary of function arguments, either passed through from args[0] if\n * args[0] is an object, or created from `args` and `argNames` if the args are a\n * deprecated positional argument call.\n *\n * restArgs: an array of the \"...args\" passed to the function if `hasRestArgs` is true;\n * otherwise it is `undefined`.\n */\n// Allow use of `object` type\n// eslint-disable-next-line @typescript-eslint/ban-types\nconst handleDeprecatedPositionalArgs = (args, methodName, argNames, hasRestArgs) => {\n    if (typeof args[0] !== \"object\") {\n        const restArgsText = hasRestArgs ? \", ...args\" : \"\";\n        deprecationWarning(`${methodName}(${argNames.join(\", \")}${restArgsText})`, `${methodName}({ ${argNames.join(\", \")} }${restArgsText})`);\n        // Convert the array of arguments into a dictionary keyed by the relevant argName\n        const argsObject = argNames.reduce((prev, argName, index) => {\n            return { ...prev, [argName]: args[index] };\n        }, {});\n        const restArgs = hasRestArgs ? args.slice(argNames.length) : undefined;\n        return { argsObject, restArgs };\n    }\n    return { argsObject: args[0], restArgs: hasRestArgs ? args.slice(1) : undefined };\n};\n\n////////////////////////////////////////////////////////////////////////////\n// React/React Native set a global __DEV__ variable when running in dev mode\nsetIsDevelopmentMode(typeof __DEV__ !== \"undefined\" && __DEV__);\n\n////////////////////////////////////////////////////////////////////////////\n/** @inheritdoc */\nclass EmailPasswordAuth {\n    /**\n     * Construct an interface to the email / password authentication provider.\n     *\n     * @param fetcher The underlying fetcher used to request the services.\n     * @param providerName Optional custom name of the authentication provider.\n     */\n    constructor(fetcher, providerName = \"local-userpass\") {\n        this.fetcher = fetcher;\n        this.providerName = providerName;\n    }\n    async registerUser(...args) {\n        const { argsObject: userDetails } = handleDeprecatedPositionalArgs(args, \"registerUser\", [\"email\", \"password\"]);\n        const appRoute = this.fetcher.appRoute;\n        await this.fetcher.fetchJSON({\n            method: \"POST\",\n            path: appRoute.emailPasswordAuth(this.providerName).register().path,\n            body: userDetails,\n        });\n    }\n    async confirmUser(...args) {\n        const { argsObject: tokenDetails } = handleDeprecatedPositionalArgs(args, \"confirmUser\", [\"token\", \"tokenId\"]);\n        const appRoute = this.fetcher.appRoute;\n        await this.fetcher.fetchJSON({\n            method: \"POST\",\n            path: appRoute.emailPasswordAuth(this.providerName).confirm().path,\n            body: tokenDetails,\n        });\n    }\n    async resendConfirmationEmail(...args) {\n        const { argsObject: emailDetails } = handleDeprecatedPositionalArgs(args, \"resendConfirmationEmail\", [\"email\"]);\n        const appRoute = this.fetcher.appRoute;\n        await this.fetcher.fetchJSON({\n            method: \"POST\",\n            path: appRoute.emailPasswordAuth(this.providerName).confirmSend().path,\n            body: emailDetails,\n        });\n    }\n    async retryCustomConfirmation(...args) {\n        const { argsObject: emailDetails } = handleDeprecatedPositionalArgs(args, \"retryCustomConfirmation\", [\"email\"]);\n        const appRoute = this.fetcher.appRoute;\n        await this.fetcher.fetchJSON({\n            method: \"POST\",\n            path: appRoute.emailPasswordAuth(this.providerName).confirmCall().path,\n            body: emailDetails,\n        });\n    }\n    async resetPassword(...args) {\n        const { argsObject: resetDetails } = handleDeprecatedPositionalArgs(args, \"resetPassword\", [\"token\", \"tokenId\", \"password\"]);\n        const appRoute = this.fetcher.appRoute;\n        await this.fetcher.fetchJSON({\n            method: \"POST\",\n            path: appRoute.emailPasswordAuth(this.providerName).reset().path,\n            body: resetDetails,\n        });\n    }\n    async sendResetPasswordEmail(...args) {\n        const { argsObject: emailDetails } = handleDeprecatedPositionalArgs(args, \"sendResetPasswordEmail\", [\"email\"]);\n        const appRoute = this.fetcher.appRoute;\n        await this.fetcher.fetchJSON({\n            method: \"POST\",\n            path: appRoute.emailPasswordAuth(this.providerName).resetSend().path,\n            body: emailDetails,\n        });\n    }\n    async callResetPasswordFunction(...args) {\n        const { argsObject: resetDetails, restArgs, } = handleDeprecatedPositionalArgs(args, \"callResetPasswordFunction\", [\"email\", \"password\"], true);\n        const appRoute = this.fetcher.appRoute;\n        await this.fetcher.fetchJSON({\n            method: \"POST\",\n            path: appRoute.emailPasswordAuth(this.providerName).resetCall().path,\n            body: { ...resetDetails, arguments: restArgs },\n        });\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n/**\n * @returns The base api route.\n */\nfunction api() {\n    return {\n        path: \"/api/client/v2.0\",\n        /**\n         * @param appId The id of the app.\n         * @returns The URL of the app endpoint.\n         */\n        app(appId) {\n            return {\n                path: this.path + `/app/${appId}`,\n                /**\n                 * @returns The URL of the app location endpoint.\n                 */\n                location() {\n                    return {\n                        path: this.path + \"/location\",\n                    };\n                },\n                /**\n                 * @param providerName The name of the provider.\n                 * @returns The app url concatinated with the /auth/providers/{providerName}\n                 */\n                authProvider(providerName) {\n                    return {\n                        path: this.path + `/auth/providers/${providerName}`,\n                        /**\n                         * @returns Get the URL of an authentication provider.\n                         */\n                        login() {\n                            return { path: this.path + \"/login\" };\n                        },\n                    };\n                },\n                /**\n                 * @param providerName The name of the provider.\n                 * @returns The app url concatinated with the /auth/providers/{providerName}\n                 */\n                emailPasswordAuth(providerName) {\n                    const authProviderRoutes = this.authProvider(providerName);\n                    return {\n                        ...authProviderRoutes,\n                        register() {\n                            return { path: this.path + \"/register\" };\n                        },\n                        confirm() {\n                            return { path: this.path + \"/confirm\" };\n                        },\n                        confirmSend() {\n                            return { path: this.path + \"/confirm/send\" };\n                        },\n                        confirmCall() {\n                            return { path: this.path + \"/confirm/call\" };\n                        },\n                        reset() {\n                            return { path: this.path + \"/reset\" };\n                        },\n                        resetSend() {\n                            return { path: this.path + \"/reset/send\" };\n                        },\n                        resetCall() {\n                            return { path: this.path + \"/reset/call\" };\n                        },\n                    };\n                },\n                functionsCall() {\n                    return {\n                        path: this.path + \"/functions/call\",\n                    };\n                },\n            };\n        },\n        auth() {\n            return {\n                path: this.path + \"/auth\",\n                apiKeys() {\n                    return {\n                        path: this.path + \"/api_keys\",\n                        key(id) {\n                            return {\n                                path: this.path + `/${id}`,\n                                enable() {\n                                    return { path: this.path + \"/enable\" };\n                                },\n                                disable() {\n                                    return { path: this.path + \"/disable\" };\n                                },\n                            };\n                        },\n                    };\n                },\n                profile() {\n                    return { path: this.path + \"/profile\" };\n                },\n                session() {\n                    return { path: this.path + \"/session\" };\n                },\n            };\n        },\n    };\n}\nvar routes = { api };\n\n////////////////////////////////////////////////////////////////////////////\n/** @inheritdoc */\nclass ApiKeyAuth {\n    /**\n     * Construct an interface to the API-key authentication provider.\n     *\n     * @param fetcher The fetcher used to send requests to services.\n     */\n    constructor(fetcher) {\n        this.fetcher = fetcher;\n    }\n    /** @inheritdoc */\n    create(name) {\n        return this.fetcher.fetchJSON({\n            method: \"POST\",\n            body: { name },\n            path: routes.api().auth().apiKeys().path,\n            tokenType: \"refresh\",\n        });\n    }\n    /** @inheritdoc */\n    fetch(keyId) {\n        return this.fetcher.fetchJSON({\n            method: \"GET\",\n            path: routes.api().auth().apiKeys().key(keyId).path,\n            tokenType: \"refresh\",\n        });\n    }\n    /** @inheritdoc */\n    fetchAll() {\n        return this.fetcher.fetchJSON({\n            method: \"GET\",\n            tokenType: \"refresh\",\n            path: routes.api().auth().apiKeys().path,\n        });\n    }\n    /** @inheritdoc */\n    async delete(keyId) {\n        await this.fetcher.fetchJSON({\n            method: \"DELETE\",\n            path: routes.api().auth().apiKeys().key(keyId).path,\n            tokenType: \"refresh\",\n        });\n    }\n    /** @inheritdoc */\n    async enable(keyId) {\n        await this.fetcher.fetchJSON({\n            method: \"PUT\",\n            path: routes.api().auth().apiKeys().key(keyId).enable().path,\n            tokenType: \"refresh\",\n        });\n    }\n    /** @inheritdoc */\n    async disable(keyId) {\n        await this.fetcher.fetchJSON({\n            method: \"PUT\",\n            path: routes.api().auth().apiKeys().key(keyId).disable().path,\n            tokenType: \"refresh\",\n        });\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\nlet environment = null;\n/**\n * Set the environment of execution.\n * Note: This should be called as the first thing before executing any code which calls getEnvironment()\n *\n * @param e An object containing environment specific implementations.\n */\nfunction setEnvironment(e) {\n    environment = e;\n}\n/**\n * Get the environment of execution.\n *\n * @returns An object containing environment specific implementations.\n */\nfunction getEnvironment() {\n    if (environment) {\n        return environment;\n    }\n    else {\n        throw new Error(\"Cannot get environment before it's set\");\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n/**\n * An error occured during the parsing of a watch stream.\n */\nclass WatchError extends Error {\n    constructor({ message, code }) {\n        super(message);\n        /**\n         * The name of this type of error\n         */\n        this.name = \"WatchError\";\n        this.code = code;\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n// NOTE: this is a fully processed event, not a single \"data: foo\" line!\n/**\n * The state of a WatchStream.\n */\nvar WatchStreamState;\n(function (WatchStreamState) {\n    /**\n     * Need to call one of the feed functions.\n     */\n    WatchStreamState[\"NEED_DATA\"] = \"NEED_DATA\";\n    /**\n     * Call nextEvent() to consume an event.\n     */\n    WatchStreamState[\"HAVE_EVENT\"] = \"HAVE_EVENT\";\n    /**\n     * Call error().\n     */\n    WatchStreamState[\"HAVE_ERROR\"] = \"HAVE_ERROR\";\n})(WatchStreamState || (WatchStreamState = {}));\n/**\n * Represents a stream of events\n */\nclass WatchStream {\n    constructor() {\n        this._state = WatchStreamState.NEED_DATA;\n        this._error = null;\n        // Used by feedBuffer to construct lines\n        this._textDecoder = new (getEnvironment().TextDecoder)();\n        this._buffer = \"\";\n        this._bufferOffset = 0;\n        // Used by feedLine for building the next SSE\n        this._eventType = \"\";\n        this._dataBuffer = \"\";\n    }\n    // Call these when you have data, in whatever shape is easiest for your SDK to get.\n    // Pick one, mixing and matching on a single instance isn't supported.\n    // These can only be called in NEED_DATA state, which is the initial state.\n    feedBuffer(buffer) {\n        this.assertState(WatchStreamState.NEED_DATA);\n        this._buffer += this._textDecoder.decode(buffer, { stream: true });\n        this.advanceBufferState();\n    }\n    feedLine(line) {\n        this.assertState(WatchStreamState.NEED_DATA);\n        // This is an implementation of the algorithm described at\n        // https://html.spec.whatwg.org/multipage/server-sent-events.html#event-stream-interpretation.\n        // Currently the server does not use id or retry lines, so that processing isn't implemented.\n        // ignore trailing LF if not removed by SDK.\n        if (line.endsWith(\"\\n\"))\n            line = line.substr(0, line.length - 1);\n        // ignore trailing CR from CRLF\n        if (line.endsWith(\"\\r\"))\n            line = line.substr(0, line.length - 1);\n        if (line.length === 0) {\n            // This is the \"dispatch the event\" portion of the algorithm.\n            if (this._dataBuffer.length === 0) {\n                this._eventType = \"\";\n                return;\n            }\n            if (this._dataBuffer.endsWith(\"\\n\"))\n                this._dataBuffer = this._dataBuffer.substr(0, this._dataBuffer.length - 1);\n            this.feedSse({\n                data: this._dataBuffer,\n                eventType: this._eventType,\n            });\n            this._dataBuffer = \"\";\n            this._eventType = \"\";\n        }\n        if (line[0] === \":\")\n            return;\n        const colon = line.indexOf(\":\");\n        const field = line.substr(0, colon);\n        let value = colon === -1 ? \"\" : line.substr(colon + 1);\n        if (value.startsWith(\" \"))\n            value = value.substr(1);\n        if (field === \"event\") {\n            this._eventType = value;\n        }\n        else if (field === \"data\") {\n            this._dataBuffer += value;\n            this._dataBuffer += \"\\n\";\n        }\n        else ;\n    }\n    feedSse(sse) {\n        this.assertState(WatchStreamState.NEED_DATA);\n        const firstPercentIndex = sse.data.indexOf(\"%\");\n        if (firstPercentIndex !== -1) {\n            // For some reason, the stich server decided to add percent-encoding for '%', '\\n', and '\\r' to its\n            // event-stream replies. But it isn't real urlencoding, since most characters pass through, so we can't use\n            // uri_percent_decode() here.\n            let buffer = \"\";\n            let start = 0;\n            for (let percentIndex = firstPercentIndex; percentIndex !== -1; percentIndex = sse.data.indexOf(\"%\", start)) {\n                buffer += sse.data.substr(start, percentIndex - start);\n                const encoded = sse.data.substr(percentIndex, 3); // may be smaller than 3 if string ends with %\n                if (encoded === \"%25\") {\n                    buffer += \"%\";\n                }\n                else if (encoded === \"%0A\") {\n                    buffer += \"\\x0A\"; // '\\n'\n                }\n                else if (encoded === \"%0D\") {\n                    buffer += \"\\x0D\"; // '\\r'\n                }\n                else {\n                    buffer += encoded; // propagate as-is\n                }\n                start = percentIndex + encoded.length;\n            }\n            // Advance the buffer with the last part\n            buffer += sse.data.substr(start);\n            sse.data = buffer;\n        }\n        if (!sse.eventType || sse.eventType === \"message\") {\n            try {\n                const parsed = EJSON.parse(sse.data);\n                if (typeof parsed === \"object\") {\n                    // ???\n                    this._nextEvent = parsed;\n                    this._state = WatchStreamState.HAVE_EVENT;\n                    return;\n                }\n            }\n            catch {\n                // fallthrough to same handling as for non-document value.\n            }\n            this._state = WatchStreamState.HAVE_ERROR;\n            this._error = new WatchError({\n                message: \"server returned malformed event: \" + sse.data,\n                code: \"bad bson parse\",\n            });\n        }\n        else if (sse.eventType === \"error\") {\n            this._state = WatchStreamState.HAVE_ERROR;\n            // default error message if we have issues parsing the reply.\n            this._error = new WatchError({\n                message: sse.data,\n                code: \"unknown\",\n            });\n            try {\n                const { error_code: errorCode, error } = EJSON.parse(sse.data);\n                if (typeof errorCode !== \"string\")\n                    return;\n                if (typeof error !== \"string\")\n                    return;\n                // XXX in realm-js, object-store will error if the error_code is not one of the known\n                // error code enum values.\n                this._error = new WatchError({\n                    message: error,\n                    code: errorCode,\n                });\n            }\n            catch {\n                return; // Use the default state.\n            }\n        }\n        else ;\n    }\n    get state() {\n        return this._state;\n    }\n    // Consumes the returned event. If you used feedBuffer(), there may be another event or error after this one,\n    // so you need to call state() again to see what to do next.\n    nextEvent() {\n        this.assertState(WatchStreamState.HAVE_EVENT);\n        // We can use \"as ChangeEvent<T>\" since we just asserted the state.\n        const out = this._nextEvent;\n        this._state = WatchStreamState.NEED_DATA;\n        this.advanceBufferState();\n        return out;\n    }\n    // Once this enters the error state, it stays that way. You should not feed any more data.\n    get error() {\n        return this._error;\n    }\n    ////////////////////////////////////////////\n    advanceBufferState() {\n        this.assertState(WatchStreamState.NEED_DATA);\n        while (this.state === WatchStreamState.NEED_DATA) {\n            if (this._bufferOffset === this._buffer.length) {\n                this._buffer = \"\";\n                this._bufferOffset = 0;\n                return;\n            }\n            // NOTE not supporting CR-only newlines, just LF and CRLF.\n            const nextNewlineIndex = this._buffer.indexOf(\"\\n\", this._bufferOffset);\n            if (nextNewlineIndex === -1) {\n                // We have a partial line.\n                if (this._bufferOffset !== 0) {\n                    // Slide the partial line down to the front of the buffer.\n                    this._buffer = this._buffer.substr(this._bufferOffset, this._buffer.length - this._bufferOffset);\n                    this._bufferOffset = 0;\n                }\n                return;\n            }\n            this.feedLine(this._buffer.substr(this._bufferOffset, nextNewlineIndex - this._bufferOffset));\n            this._bufferOffset = nextNewlineIndex + 1; // Advance past this line, including its newline.\n        }\n    }\n    assertState(state) {\n        if (this._state !== state) {\n            throw Error(`Expected WatchStream to be in state ${state}, but in state ${this._state}`);\n        }\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n/**\n * A remote collection of documents.\n */\nclass MongoDBCollection {\n    /**\n     * Construct a remote collection of documents.\n     *\n     * @param fetcher The fetcher to use when requesting the service.\n     * @param serviceName The name of the remote service.\n     * @param databaseName The name of the database.\n     * @param collectionName The name of the remote collection.\n     */\n    constructor(fetcher, serviceName, databaseName, collectionName) {\n        this.functions = FunctionsFactory.create(fetcher, {\n            serviceName,\n        });\n        this.databaseName = databaseName;\n        this.collectionName = collectionName;\n        this.serviceName = serviceName;\n        this.fetcher = fetcher;\n    }\n    /** @inheritdoc */\n    find(filter = {}, options = {}) {\n        return this.functions.find({\n            database: this.databaseName,\n            collection: this.collectionName,\n            query: filter,\n            project: options.projection,\n            sort: options.sort,\n            limit: options.limit,\n        });\n    }\n    /** @inheritdoc */\n    findOne(filter = {}, options = {}) {\n        return this.functions.findOne({\n            database: this.databaseName,\n            collection: this.collectionName,\n            query: filter,\n            project: options.projection,\n            sort: options.sort,\n        });\n    }\n    /** @inheritdoc */\n    findOneAndUpdate(filter = {}, update, options = {}) {\n        return this.functions.findOneAndUpdate({\n            database: this.databaseName,\n            collection: this.collectionName,\n            filter,\n            update,\n            sort: options.sort,\n            projection: options.projection,\n            upsert: options.upsert,\n            returnNewDocument: options.returnNewDocument,\n        });\n    }\n    /** @inheritdoc */\n    findOneAndReplace(filter = {}, replacement, options = {}) {\n        return this.functions.findOneAndReplace({\n            database: this.databaseName,\n            collection: this.collectionName,\n            filter: filter,\n            update: replacement,\n            sort: options.sort,\n            projection: options.projection,\n            upsert: options.upsert,\n            returnNewDocument: options.returnNewDocument,\n        });\n    }\n    /** @inheritdoc */\n    findOneAndDelete(filter = {}, options = {}) {\n        return this.functions.findOneAndReplace({\n            database: this.databaseName,\n            collection: this.collectionName,\n            filter,\n            sort: options.sort,\n            projection: options.projection,\n        });\n    }\n    /** @inheritdoc */\n    aggregate(pipeline) {\n        return this.functions.aggregate({\n            database: this.databaseName,\n            collection: this.collectionName,\n            pipeline,\n        });\n    }\n    /** @inheritdoc */\n    count(filter = {}, options = {}) {\n        return this.functions.count({\n            database: this.databaseName,\n            collection: this.collectionName,\n            query: filter,\n            limit: options.limit,\n        });\n    }\n    /** @inheritdoc */\n    insertOne(document) {\n        return this.functions.insertOne({\n            database: this.databaseName,\n            collection: this.collectionName,\n            document,\n        });\n    }\n    /** @inheritdoc */\n    insertMany(documents) {\n        return this.functions.insertMany({\n            database: this.databaseName,\n            collection: this.collectionName,\n            documents,\n        });\n    }\n    /** @inheritdoc */\n    deleteOne(filter = {}) {\n        return this.functions.deleteOne({\n            database: this.databaseName,\n            collection: this.collectionName,\n            query: filter,\n        });\n    }\n    /** @inheritdoc */\n    deleteMany(filter = {}) {\n        return this.functions.deleteMany({\n            database: this.databaseName,\n            collection: this.collectionName,\n            query: filter,\n        });\n    }\n    /** @inheritdoc */\n    updateOne(filter, update, options = {}) {\n        return this.functions.updateOne({\n            database: this.databaseName,\n            collection: this.collectionName,\n            query: filter,\n            update,\n            upsert: options.upsert,\n        });\n    }\n    /** @inheritdoc */\n    updateMany(filter, update, options = {}) {\n        return this.functions.updateMany({\n            database: this.databaseName,\n            collection: this.collectionName,\n            query: filter,\n            update,\n            upsert: options.upsert,\n        });\n    }\n    async *watch({ ids, filter, } = {}) {\n        const iterator = await this.functions.callFunctionStreaming(\"watch\", {\n            database: this.databaseName,\n            collection: this.collectionName,\n            ids,\n            filter,\n        });\n        const watchStream = new WatchStream();\n        for await (const chunk of iterator) {\n            if (!chunk)\n                continue;\n            watchStream.feedBuffer(chunk);\n            while (watchStream.state == WatchStreamState.HAVE_EVENT) {\n                yield watchStream.nextEvent();\n            }\n            if (watchStream.state == WatchStreamState.HAVE_ERROR)\n                // XXX this is just throwing an error like {error_code: \"BadRequest, error: \"message\"},\n                // which matches realm-js, but is different from how errors are handled in realm-web\n                throw watchStream.error;\n        }\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n/**\n * Creates an Remote MongoDB Collection.\n * Note: This method exists to enable function binding.\n *\n * @param fetcher The underlying fetcher.\n * @param serviceName A service name.\n * @param databaseName A database name.\n * @param collectionName A collection name.\n * @returns The collection.\n */\nfunction createCollection(fetcher, serviceName, databaseName, collectionName) {\n    return new MongoDBCollection(fetcher, serviceName, databaseName, collectionName);\n}\n/**\n * Creates a Remote MongoDB Database.\n * Note: This method exists to enable function binding.\n *\n * @param fetcher The underlying fetcher\n * @param serviceName A service name\n * @param databaseName A database name\n * @returns The database.\n */\nfunction createDatabase(fetcher, serviceName, databaseName) {\n    return {\n        collection: createCollection.bind(null, fetcher, serviceName, databaseName),\n    };\n}\n/**\n * Creates a Remote MongoDB Service.\n * Note: This method exists to enable function binding.\n *\n * @param fetcher The underlying fetcher.\n * @param serviceName An optional service name.\n * @returns The service.\n */\nfunction createService(fetcher, serviceName = \"mongo-db\") {\n    return { db: createDatabase.bind(null, fetcher, serviceName) };\n}\n\n////////////////////////////////////////////////////////////////////////////\nconst DEFAULT_DEVICE_ID = \"000000000000000000000000\";\n/** The state of a user within the app */\nvar UserState;\n(function (UserState) {\n    /** Active, with both access and refresh tokens */\n    UserState[\"Active\"] = \"active\";\n    /** Logged out, but there might still be data persisted about the user, in the browser. */\n    UserState[\"LoggedOut\"] = \"logged-out\";\n    /** Logged out and all data about the user has been removed. */\n    UserState[\"Removed\"] = \"removed\";\n})(UserState || (UserState = {}));\n/** The type of a user. */\nvar UserType$1;\n(function (UserType) {\n    /** Created by the user itself. */\n    UserType[\"Normal\"] = \"normal\";\n    /** Created by an administrator of the app. */\n    UserType[\"Server\"] = \"server\";\n})(UserType$1 || (UserType$1 = {}));\n/**\n * Representation of an authenticated user of an app.\n */\nclass User {\n    /**\n     * @param parameters Parameters of the user.\n     */\n    constructor(parameters) {\n        this.app = parameters.app;\n        this.id = parameters.id;\n        this.storage = new UserStorage(this.app.storage, this.id);\n        if (\"accessToken\" in parameters && \"refreshToken\" in parameters && \"providerType\" in parameters) {\n            this._accessToken = parameters.accessToken;\n            this._refreshToken = parameters.refreshToken;\n            this.providerType = parameters.providerType;\n            // Save the parameters to storage, for future instances to be hydrated from\n            this.storage.accessToken = parameters.accessToken;\n            this.storage.refreshToken = parameters.refreshToken;\n            this.storage.providerType = parameters.providerType;\n        }\n        else {\n            // Hydrate the rest of the parameters from storage\n            this._accessToken = this.storage.accessToken;\n            this._refreshToken = this.storage.refreshToken;\n            const providerType = this.storage.providerType;\n            this._profile = this.storage.profile;\n            if (providerType) {\n                this.providerType = providerType;\n            }\n            else {\n                throw new Error(\"Storage is missing a provider type\");\n            }\n        }\n        this.fetcher = this.app.fetcher.clone({\n            userContext: { currentUser: this },\n        });\n        this.apiKeys = new ApiKeyAuth(this.fetcher);\n        this.functions = FunctionsFactory.create(this.fetcher);\n    }\n    /**\n     * @returns The access token used to authenticate the user towards MongoDB Realm.\n     */\n    get accessToken() {\n        return this._accessToken;\n    }\n    /**\n     * @param token The new access token.\n     */\n    set accessToken(token) {\n        this._accessToken = token;\n        this.storage.accessToken = token;\n    }\n    /**\n     * @returns The refresh token used to issue new access tokens.\n     */\n    get refreshToken() {\n        return this._refreshToken;\n    }\n    /**\n     * @param token The new refresh token.\n     */\n    set refreshToken(token) {\n        this._refreshToken = token;\n        this.storage.refreshToken = token;\n    }\n    /**\n     * @returns The current state of the user.\n     */\n    get state() {\n        if (this.id in this.app.allUsers) {\n            return this.refreshToken === null ? UserState.LoggedOut : UserState.Active;\n        }\n        else {\n            return UserState.Removed;\n        }\n    }\n    /**\n     * @returns The logged in state of the user.\n     */\n    get isLoggedIn() {\n        return this.state === UserState.Active;\n    }\n    get customData() {\n        if (this.accessToken) {\n            const decodedToken = this.decodeAccessToken();\n            return decodedToken.userData;\n        }\n        else {\n            throw new Error(\"Cannot read custom data without an access token\");\n        }\n    }\n    /**\n     * @returns Profile containing detailed information about the user.\n     */\n    get profile() {\n        if (this._profile) {\n            return this._profile.data;\n        }\n        else {\n            throw new Error(\"A profile was never fetched for this user\");\n        }\n    }\n    get identities() {\n        if (this._profile) {\n            return this._profile.identities;\n        }\n        else {\n            throw new Error(\"A profile was never fetched for this user\");\n        }\n    }\n    get deviceId() {\n        if (this.accessToken) {\n            const payload = this.accessToken.split(\".\")[1];\n            if (payload) {\n                const parsedPayload = JSON.parse(gBase64.decode(payload));\n                const deviceId = parsedPayload[\"baas_device_id\"];\n                if (typeof deviceId === \"string\" && deviceId !== DEFAULT_DEVICE_ID) {\n                    return deviceId;\n                }\n            }\n        }\n        return null;\n    }\n    /**\n     * Refresh the users profile data.\n     */\n    async refreshProfile() {\n        // Fetch the latest profile\n        const response = await this.fetcher.fetchJSON({\n            method: \"GET\",\n            path: routes.api().auth().profile().path,\n        });\n        // Create a profile instance\n        this._profile = new UserProfile(response);\n        // Store this for later hydration\n        this.storage.profile = this._profile;\n    }\n    /**\n     * Log out the user, invalidating the session (and its refresh token).\n     */\n    async logOut() {\n        // Invalidate the refresh token\n        try {\n            if (this._refreshToken !== null) {\n                await this.fetcher.fetchJSON({\n                    method: \"DELETE\",\n                    path: routes.api().auth().session().path,\n                    tokenType: \"refresh\",\n                });\n            }\n        }\n        finally {\n            // Forget the access and refresh token\n            this.accessToken = null;\n            this.refreshToken = null;\n        }\n    }\n    /** @inheritdoc */\n    async linkCredentials(credentials) {\n        const response = await this.app.authenticator.authenticate(credentials, this);\n        // Sanity check the response\n        if (this.id !== response.userId) {\n            const details = `got user id ${response.userId} expected ${this.id}`;\n            throw new Error(`Link response ment for another user (${details})`);\n        }\n        // Update the access token\n        this.accessToken = response.accessToken;\n        // Refresh the profile to include the new identity\n        await this.refreshProfile();\n    }\n    /**\n     * Request a new access token, using the refresh token.\n     */\n    async refreshAccessToken() {\n        const response = await this.fetcher.fetchJSON({\n            method: \"POST\",\n            path: routes.api().auth().session().path,\n            tokenType: \"refresh\",\n        });\n        const { access_token: accessToken } = response;\n        if (typeof accessToken === \"string\") {\n            this.accessToken = accessToken;\n        }\n        else {\n            throw new Error(\"Expected an 'access_token' in the response\");\n        }\n    }\n    /** @inheritdoc */\n    async refreshCustomData() {\n        await this.refreshAccessToken();\n        return this.customData;\n    }\n    /** @inheritdoc */\n    callFunction(name, ...args) {\n        return this.functions.callFunction(name, ...args);\n    }\n    /**\n     * @returns A plain ol' JavaScript object representation of the user.\n     */\n    toJSON() {\n        return {\n            id: this.id,\n            accessToken: this.accessToken,\n            refreshToken: this.refreshToken,\n            profile: this._profile,\n            state: this.state,\n            customData: this.customData,\n        };\n    }\n    /** @inheritdoc */\n    push() {\n        throw new Error(\"Not yet implemented\");\n    }\n    /** @inheritdoc */\n    mongoClient(serviceName) {\n        return createService(this.fetcher, serviceName);\n    }\n    decodeAccessToken() {\n        if (this.accessToken) {\n            // Decode and spread the token\n            const parts = this.accessToken.split(\".\");\n            if (parts.length !== 3) {\n                throw new Error(\"Expected an access token with three parts\");\n            }\n            // Decode the payload\n            const encodedPayload = parts[1];\n            const decodedPayload = gBase64.decode(encodedPayload);\n            const parsedPayload = JSON.parse(decodedPayload);\n            const { exp: expires, iat: issuedAt, sub: subject, user_data: userData = {} } = parsedPayload;\n            // Validate the types\n            if (typeof expires !== \"number\") {\n                throw new Error(\"Failed to decode access token 'exp'\");\n            }\n            else if (typeof issuedAt !== \"number\") {\n                throw new Error(\"Failed to decode access token 'iat'\");\n            }\n            return { expires, issuedAt, subject, userData };\n        }\n        else {\n            throw new Error(\"Missing an access token\");\n        }\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n// TODO: Ensure the static interface of the Credentials class implements the static interface of Realm.Credentials\n// See https://stackoverflow.com/a/43484801\n/**\n * Instances of this class can be passed to the `app.logIn` method to authenticate an end-user.\n */\nclass Credentials {\n    /**\n     * Constructs an instance of credentials.\n     *\n     * @param providerName The name of the authentication provider used when authenticating.\n     * @param providerType The type of the authentication provider used when authenticating.\n     * @param payload The data being sent to the service when authenticating.\n     */\n    constructor(providerName, providerType, payload) {\n        this.providerName = providerName;\n        this.providerType = providerType;\n        this.payload = payload;\n    }\n    /**\n     * Creates credentials that logs in using the [Anonymous Provider](https://docs.mongodb.com/realm/authentication/anonymous/).\n     *\n     * @returns The credentials instance, which can be passed to `app.logIn`.\n     */\n    static anonymous() {\n        return new Credentials(\"anon-user\", \"anon-user\", {});\n    }\n    /**\n     * Creates credentials that logs in using the [API Key Provider](https://docs.mongodb.com/realm/authentication/api-key/).\n     *\n     * @deprecated Use `Credentials.apiKey`.\n     * @param key The secret content of the API key.\n     * @returns The credentials instance, which can be passed to `app.logIn`.\n     */\n    static userApiKey(key) {\n        return new Credentials(\"api-key\", \"api-key\", { key });\n    }\n    /**\n     * Creates credentials that logs in using the [API Key Provider](https://docs.mongodb.com/realm/authentication/api-key/).\n     *\n     * @deprecated Use `Credentials.apiKey`.\n     * @param key The secret content of the API key.\n     * @returns The credentials instance, which can be passed to `app.logIn`.\n     */\n    static serverApiKey(key) {\n        return new Credentials(\"api-key\", \"api-key\", { key });\n    }\n    /**\n     * Creates credentials that logs in using the [API Key Provider](https://docs.mongodb.com/realm/authentication/api-key/).\n     *\n     * @param key The secret content of the API key.\n     * @returns The credentials instance, which can be passed to `app.logIn`.\n     */\n    static apiKey(key) {\n        return new Credentials(\"api-key\", \"api-key\", { key });\n    }\n    /**\n     * Creates credentials that logs in using the [Email/Password Provider](https://docs.mongodb.com/realm/authentication/email-password/).\n     * Note: This was formerly known as the \"Username/Password\" provider.\n     *\n     * @param email The end-users email address.\n     * @param password The end-users password.\n     * @returns The credentials instance, which can be passed to `app.logIn`.\n     */\n    static emailPassword(email, password) {\n        return new Credentials(\"local-userpass\", \"local-userpass\", {\n            username: email,\n            password,\n        });\n    }\n    /**\n     * Creates credentials that logs in using the [Custom Function Provider](https://docs.mongodb.com/realm/authentication/custom-function/).\n     *\n     * @param payload The custom payload as expected by the server.\n     * @returns The credentials instance, which can be passed to `app.logIn`.\n     */\n    static function(payload) {\n        return new Credentials(\"custom-function\", \"custom-function\", payload);\n    }\n    /**\n     * Creates credentials that logs in using the [Custom JWT Provider](https://docs.mongodb.com/realm/authentication/custom-jwt/).\n     *\n     * @param token The JSON Web Token (JWT).\n     * @returns The credentials instance, which can be passed to `app.logIn`.\n     */\n    static jwt(token) {\n        return new Credentials(\"custom-token\", \"custom-token\", {\n            token,\n        });\n    }\n    /**\n     * Creates credentials that logs in using the [Google Provider](https://docs.mongodb.com/realm/authentication/google/).\n     *\n     * @param payload The URL that users should be redirected to, the auth code or id token from Google.\n     * @returns The credentials instance, which can be passed to `app.logIn`.\n     */\n    static google(payload) {\n        return new Credentials(\"oauth2-google\", \"oauth2-google\", Credentials.derivePayload(payload));\n    }\n    /**\n     * @param payload The payload string.\n     * @returns A payload object based on the string.\n     */\n    static derivePayload(payload) {\n        if (typeof payload === \"string\") {\n            if (payload.includes(\"://\")) {\n                return this.derivePayload({ redirectUrl: payload });\n            }\n            else if (payload.startsWith(\"4/\")) {\n                return this.derivePayload({ authCode: payload });\n            }\n            else if (payload.startsWith(\"ey\")) {\n                return this.derivePayload({ idToken: payload });\n            }\n            else {\n                throw new Error(`Unexpected payload: ${payload}`);\n            }\n        }\n        else if (Object.keys(payload).length === 1) {\n            if (\"authCode\" in payload || \"redirectUrl\" in payload) {\n                return payload;\n            }\n            else if (\"idToken\" in payload) {\n                return { id_token: payload.idToken };\n            }\n            else {\n                throw new Error(\"Unexpected payload: \" + JSON.stringify(payload));\n            }\n        }\n        else {\n            throw new Error(\"Expected only one property in payload, got \" + JSON.stringify(payload));\n        }\n    }\n    /**\n     * Creates credentials that logs in using the [Facebook Provider](https://docs.mongodb.com/realm/authentication/facebook/).\n     *\n     * @param redirectUrlOrAccessToken The URL that users should be redirected to or the auth code returned from Facebook.\n     * @returns The credentials instance, which can be passed to `app.logIn`.\n     */\n    static facebook(redirectUrlOrAccessToken) {\n        return new Credentials(\"oauth2-facebook\", \"oauth2-facebook\", redirectUrlOrAccessToken.includes(\"://\")\n            ? { redirectUrl: redirectUrlOrAccessToken }\n            : { accessToken: redirectUrlOrAccessToken });\n    }\n    /**\n     * Creates credentials that logs in using the [Apple ID Provider](https://docs.mongodb.com/realm/authentication/apple/).\n     *\n     * @param redirectUrlOrIdToken The URL that users should be redirected to or the id_token returned from Apple.\n     * @returns The credentials instance, which can be passed to `app.logIn`.\n     */\n    static apple(redirectUrlOrIdToken) {\n        return new Credentials(\"oauth2-apple\", \"oauth2-apple\", redirectUrlOrIdToken.includes(\"://\") ? { redirectUrl: redirectUrlOrIdToken } : { id_token: redirectUrlOrIdToken });\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\nconst USER_IDS_STORAGE_KEY = \"userIds\";\nconst DEVICE_ID_STORAGE_KEY = \"deviceId\";\n/**\n * Storage specific to the app.\n */\nclass AppStorage extends PrefixedStorage {\n    /**\n     * @param storage The underlying storage to wrap.\n     * @param appId The id of the app.\n     */\n    constructor(storage, appId) {\n        super(storage, `app(${appId})`);\n    }\n    /**\n     * Reads out the list of user ids from storage.\n     *\n     * @returns A list of user ids.\n     */\n    getUserIds() {\n        const userIdsString = this.get(USER_IDS_STORAGE_KEY);\n        const userIds = userIdsString ? JSON.parse(userIdsString) : [];\n        if (Array.isArray(userIds)) {\n            // Remove any duplicates that might have been added\n            // The Set preserves insertion order\n            return [...new Set(userIds)];\n        }\n        else {\n            throw new Error(\"Expected the user ids to be an array\");\n        }\n    }\n    /**\n     * Sets the list of ids in storage.\n     * Optionally merging with existing ids stored in the storage, by prepending these while voiding duplicates.\n     *\n     * @param userIds The list of ids to store.\n     * @param mergeWithExisting Prepend existing ids to avoid data-races with other apps using this storage.\n     */\n    setUserIds(userIds, mergeWithExisting) {\n        if (mergeWithExisting) {\n            // Add any existing user id to the end of this list, avoiding duplicates\n            const existingIds = this.getUserIds();\n            for (const id of existingIds) {\n                if (userIds.indexOf(id) === -1) {\n                    userIds.push(id);\n                }\n            }\n        }\n        // Store the list of ids\n        this.set(USER_IDS_STORAGE_KEY, JSON.stringify(userIds));\n    }\n    /**\n     * Remove an id from the list of ids.\n     *\n     * @param userId The id of a User to be removed.\n     */\n    removeUserId(userId) {\n        const existingIds = this.getUserIds();\n        const userIds = existingIds.filter((id) => id !== userId);\n        // Store the list of ids\n        this.setUserIds(userIds, false);\n    }\n    /**\n     * @returns id of this device (if any exists)\n     */\n    getDeviceId() {\n        return this.get(DEVICE_ID_STORAGE_KEY);\n    }\n    /**\n     * @param deviceId The id of this device, to send on subsequent authentication requests.\n     */\n    setDeviceId(deviceId) {\n        this.set(DEVICE_ID_STORAGE_KEY, deviceId);\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\nconst LOWERCASE_LETTERS = \"abcdefghijklmnopqrstuvwxyz\";\nconst CLOSE_CHECK_INTERVAL = 100; // 10 times per second\nconst REDIRECT_HASH_TO_RESULT = {\n    _stitch_client_app_id: \"appId\",\n    _baas_client_app_id: \"appId\",\n    _stitch_ua: \"userAuth\",\n    _baas_ua: \"userAuth\",\n    _stitch_link: \"link\",\n    _baas_link: \"link\",\n    _stitch_error: \"error\",\n    _baas_error: \"error\",\n    _stitch_state: \"state\",\n    _baas_state: \"state\",\n};\n/**\n * A collection of methods helping implement the OAuth2 flow.\n */\nclass OAuth2Helper {\n    /**\n     * @param storage The underlying storage to use when storing and retriving secrets.\n     * @param openWindow An optional function called when a browser window needs to open.\n     */\n    constructor(storage, openWindow = getEnvironment().openWindow) {\n        this.storage = storage.prefix(\"oauth2\");\n        this.openWindow = openWindow;\n    }\n    /**\n     * Parses the query string from the final step of the OAuth flow.\n     *\n     * @param queryString The query string passed through in location.hash.\n     * @returns The result of the OAuth flow.\n     */\n    static parseRedirectLocation(queryString) {\n        const params = decodeQueryString(queryString);\n        const result = {};\n        for (const [p, r] of Object.entries(REDIRECT_HASH_TO_RESULT)) {\n            const value = params[p];\n            if (value) {\n                result[r] = value;\n            }\n        }\n        return result;\n    }\n    /**\n     * Handle the redirect querystring by parsing it and storing it for others to consume.\n     *\n     * @param queryString The query string containing the encoded result from the OAuth provider.\n     * @param storage The underlying storage used to persist the result.\n     */\n    static handleRedirect(queryString, storage = getEnvironment().defaultStorage) {\n        const result = OAuth2Helper.parseRedirectLocation(queryString);\n        const { state, error } = result;\n        if (typeof state === \"string\") {\n            const oauth2Storage = storage.prefix(\"oauth2\");\n            const stateStorage = OAuth2Helper.getStateStorage(oauth2Storage, state);\n            stateStorage.set(\"result\", JSON.stringify(result));\n        }\n        else if (error) {\n            throw new Error(`Failed to handle OAuth 2.0 redirect: ${error}`);\n        }\n        else {\n            throw new Error(\"Failed to handle OAuth 2.0 redirect.\");\n        }\n    }\n    /**\n     * Decodes the authInfo string into its seperate parts.\n     *\n     * @param authInfo An authInfo string returned from the server.\n     * @returns An object containing the separate parts of the authInfo string.\n     */\n    static decodeAuthInfo(authInfo) {\n        const parts = (authInfo || \"\").split(\"$\");\n        if (parts.length === 4) {\n            const [accessToken, refreshToken, userId, deviceId] = parts;\n            return { accessToken, refreshToken, userId, deviceId };\n        }\n        else {\n            throw new Error(\"Failed to decode 'authInfo' into ids and tokens\");\n        }\n    }\n    /**\n     * Get the storage key associated of an secret associated with a state.\n     *\n     * @param storage The root storage used to derive a \"state namespaced\" storage.\n     * @param state The random state.\n     * @returns The storage associated with a particular state.\n     */\n    static getStateStorage(storage, state) {\n        return storage.prefix(`state(${state})`);\n    }\n    /**\n     * Open a window and wait for the redirect to be handled.\n     *\n     * @param url The URL to open.\n     * @param state The state which will be used to listen for storage updates.\n     * @returns The result passed through the redirect.\n     */\n    openWindowAndWaitForRedirect(url, state) {\n        const stateStorage = OAuth2Helper.getStateStorage(this.storage, state);\n        // Return a promise that resolves when the  gets known\n        return new Promise((resolve, reject) => {\n            let redirectWindow = null;\n            // We're declaring the interval now to enable referencing before its initialized\n            let windowClosedInterval; // eslint-disable-line prefer-const\n            const handleStorageUpdate = () => {\n                // Trying to get the secret from storage\n                const result = stateStorage.get(\"result\");\n                if (result) {\n                    const parsedResult = JSON.parse(result);\n                    // The secret got updated!\n                    stateStorage.removeListener(handleStorageUpdate);\n                    // Clear the storage to prevent others from reading this\n                    stateStorage.clear();\n                    // Try closing the newly created window\n                    try {\n                        if (redirectWindow) {\n                            // Stop checking if the window closed\n                            clearInterval(windowClosedInterval);\n                            redirectWindow.close();\n                        }\n                    }\n                    catch (err) {\n                        console.warn(`Failed closing redirect window: ${err}`);\n                    }\n                    finally {\n                        resolve(parsedResult);\n                    }\n                }\n            };\n            // Add a listener to the state storage, awaiting an update to the secret\n            stateStorage.addListener(handleStorageUpdate);\n            // Open up a window\n            redirectWindow = this.openWindow(url);\n            // Not using a const, because we need the two listeners to reference each other when removing the other.\n            windowClosedInterval = setInterval(() => {\n                // Polling \"closed\" because registering listeners on the window violates cross-origin policies\n                if (!redirectWindow) {\n                    // No need to keep polling for a window that we can't check\n                    clearInterval(windowClosedInterval);\n                }\n                else if (redirectWindow.closed) {\n                    // Stop polling the window state\n                    clearInterval(windowClosedInterval);\n                    // Stop listening for changes to the storage\n                    stateStorage.removeListener(handleStorageUpdate);\n                    // Reject the promise\n                    const err = new Error(\"Window closed\");\n                    reject(err);\n                }\n            }, CLOSE_CHECK_INTERVAL);\n        });\n    }\n    /**\n     * Generate a random state string.\n     *\n     * @returns The random state string.\n     */\n    generateState() {\n        return generateRandomString(12, LOWERCASE_LETTERS);\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\nconst REDIRECT_LOCATION_HEADER = \"x-baas-location\";\n/**\n * Handles authentication and linking of users.\n */\nclass Authenticator {\n    /**\n     * @param fetcher The fetcher used to fetch responses from the server.\n     * @param storage The storage used when completing OAuth 2.0 flows (should not be scoped to a specific app).\n     * @param getDeviceInformation Called to get device information to be sent to the server.\n     */\n    constructor(fetcher, storage, getDeviceInformation) {\n        this.fetcher = fetcher;\n        this.oauth2 = new OAuth2Helper(storage);\n        this.getDeviceInformation = getDeviceInformation;\n    }\n    /**\n     * @param credentials Credentials to use when logging in.\n     * @param linkingUser A user requesting to link.\n     * @returns A promise resolving to the response from the server.\n     */\n    async authenticate(credentials, linkingUser) {\n        const deviceInformation = this.getDeviceInformation();\n        const isLinking = typeof linkingUser === \"object\";\n        if (credentials.providerType.startsWith(\"oauth2\") && typeof credentials.payload.redirectUrl === \"string\") {\n            // Initiate the OAuth2 flow by generating a state and fetch a redirect URL\n            const state = this.oauth2.generateState();\n            const url = await this.getLogInUrl(credentials, isLinking, {\n                state,\n                redirect: credentials.payload.redirectUrl,\n                // Ensure redirects are communicated in a header different from \"Location\" and status remains 200 OK\n                providerRedirectHeader: isLinking ? true : undefined,\n                // Add the device information, only if we're not linking - since that request won't have a body of its own.\n                device: !isLinking ? deviceInformation.encode() : undefined,\n            });\n            // If we're linking, we need to send the users access token in the request\n            if (isLinking) {\n                const response = await this.fetcher.fetch({\n                    method: \"GET\",\n                    url,\n                    tokenType: isLinking ? \"access\" : \"none\",\n                    user: linkingUser,\n                    // The response will set a cookie that we need to tell the browser to store\n                    mode: \"cors\",\n                    credentials: \"include\",\n                });\n                // If a response header contains a redirect URL: Open a window and wait for the redirect to be handled\n                const redirectUrl = response.headers.get(REDIRECT_LOCATION_HEADER);\n                if (redirectUrl) {\n                    return this.openWindowAndWaitForAuthResponse(redirectUrl, state);\n                }\n                else {\n                    throw new Error(`Missing ${REDIRECT_LOCATION_HEADER} header`);\n                }\n            }\n            else {\n                // Otherwise we can open a window and let the server redirect the user right away\n                // This gives lower latency (as we don't need the client to receive and execute the redirect in code)\n                // This also has less dependency on cookies and doesn't sent any tokens.\n                return this.openWindowAndWaitForAuthResponse(url, state);\n            }\n        }\n        else {\n            const logInUrl = await this.getLogInUrl(credentials, isLinking);\n            const response = await this.fetcher.fetchJSON({\n                method: \"POST\",\n                url: logInUrl,\n                body: {\n                    ...credentials.payload,\n                    options: {\n                        device: deviceInformation.toJSON(),\n                    },\n                },\n                tokenType: isLinking ? \"access\" : \"none\",\n                user: linkingUser,\n            });\n            // Spread out values from the response and ensure they're valid\n            const { user_id: userId, access_token: accessToken, refresh_token: refreshToken = null, device_id: deviceId, } = response;\n            if (typeof userId !== \"string\") {\n                throw new Error(\"Expected a user id in the response\");\n            }\n            if (typeof accessToken !== \"string\") {\n                throw new Error(\"Expected an access token in the response\");\n            }\n            if (typeof refreshToken !== \"string\" && refreshToken !== null) {\n                throw new Error(\"Expected refresh token to be a string or null\");\n            }\n            if (typeof deviceId !== \"string\") {\n                throw new Error(\"Expected device id to be a string\");\n            }\n            return { userId, accessToken, refreshToken, deviceId };\n        }\n    }\n    /**\n     * @param credentials Credentials to use when logging in.\n     * @param link Should the request link with the current user?\n     * @param extraQueryParams Any extra parameters to include in the query string\n     * @returns A promise resolving to the url to be used when logging in.\n     */\n    async getLogInUrl(credentials, link = false, extraQueryParams = {}) {\n        // See https://github.com/mongodb/stitch-js-sdk/blob/310f0bd5af80f818cdfbc3caf1ae29ffa8e9c7cf/packages/core/sdk/src/auth/internal/CoreStitchAuth.ts#L746-L780\n        const appRoute = this.fetcher.appRoute;\n        const loginRoute = appRoute.authProvider(credentials.providerName).login();\n        const qs = encodeQueryString({\n            link: link ? \"true\" : undefined,\n            ...extraQueryParams,\n        });\n        const locationUrl = await this.fetcher.locationUrl;\n        return locationUrl + loginRoute.path + qs;\n    }\n    async openWindowAndWaitForAuthResponse(redirectUrl, state) {\n        const redirectResult = await this.oauth2.openWindowAndWaitForRedirect(redirectUrl, state);\n        // Decode the auth info (id, tokens, etc.) from the result of the redirect\n        return OAuth2Helper.decodeAuthInfo(redirectResult.userAuth);\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n//\n// Copyright 2020 Realm Inc.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n////////////////////////////////////////////////////////////////////////////\n// TODO: Determine if the shape of an error response is specific to each service or widely used.\n/**\n * An error produced while communicating with the MongoDB Realm server.\n */\nclass MongoDBRealmError extends Error {\n    constructor(method, url, statusCode, statusText, error, errorCode, link) {\n        const summary = statusText ? `status ${statusCode} ${statusText}` : `status ${statusCode}`;\n        if (typeof error === \"string\") {\n            super(`Request failed (${method} ${url}): ${error} (${summary})`);\n        }\n        else {\n            super(`Request failed (${method} ${url}): (${summary})`);\n        }\n        this.method = method;\n        this.url = url;\n        this.statusText = statusText;\n        this.statusCode = statusCode;\n        this.error = error;\n        this.errorCode = errorCode;\n        this.link = link;\n    }\n    /**\n     * Constructs and returns an error from a request and a response.\n     * Note: The caller must throw this error themselves.\n     *\n     * @param request The request sent to the server.\n     * @param response A raw response, as returned from the server.\n     * @returns An error from a request and a response.\n     */\n    static async fromRequestAndResponse(request, response) {\n        var _a;\n        const { url, method } = request;\n        const { status, statusText } = response;\n        if ((_a = response.headers.get(\"content-type\")) === null || _a === void 0 ? void 0 : _a.startsWith(\"application/json\")) {\n            const body = await response.json();\n            if (typeof body === \"object\" && body) {\n                const { error, error_code: errorCode, link } = body;\n                return new MongoDBRealmError(method, url, status, statusText, typeof error === \"string\" ? error : undefined, typeof errorCode === \"string\" ? errorCode : undefined, typeof link === \"string\" ? link : undefined);\n            }\n        }\n        return new MongoDBRealmError(method, url, status, statusText);\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n/**\n * @param body A possible resonse body.\n * @returns An async iterator.\n */\nfunction asyncIteratorFromResponseBody(body) {\n    if (typeof body !== \"object\" || body === null) {\n        throw new Error(\"Expected a non-null object\");\n    }\n    else if (Symbol.asyncIterator in body) {\n        return body;\n    }\n    else if (\"getReader\" in body) {\n        const stream = body;\n        return {\n            [Symbol.asyncIterator]() {\n                const reader = stream.getReader();\n                return {\n                    next() {\n                        return reader.read();\n                    },\n                    async return() {\n                        await reader.cancel();\n                        return { done: true, value: null };\n                    },\n                };\n            },\n        };\n    }\n    else {\n        throw new Error(\"Expected an AsyncIterable or a ReadableStream\");\n    }\n}\n/**\n * Wraps a NetworkTransport from the \"realm-network-transport\" package.\n * Extracts error messages and throws `MongoDBRealmError` objects upon failures.\n * Injects access or refresh tokens for a current or specific user.\n * Refreshes access tokens if requests fails due to a 401 error.\n * Optionally parses response as JSON before returning it.\n * Fetches and exposes an app's location url.\n */\nclass Fetcher {\n    /**\n     * @param config A configuration of the fetcher.\n     * @param config.appId The application id.\n     * @param config.transport The transport used when fetching.\n     * @param config.userContext An object used to determine the requesting user.\n     * @param config.locationUrlContext An object used to determine the location / base URL.\n     */\n    constructor({ appId, transport, userContext, locationUrlContext }) {\n        this.appId = appId;\n        this.transport = transport;\n        this.userContext = userContext;\n        this.locationUrlContext = locationUrlContext;\n    }\n    /**\n     * @param user An optional user to generate the header for.\n     * @param tokenType The type of token (access or refresh).\n     * @returns An object containing the user's token as \"Authorization\" header or undefined if no user is given.\n     */\n    static buildAuthorizationHeader(user, tokenType) {\n        if (!user || tokenType === \"none\") {\n            return {};\n        }\n        else if (tokenType === \"access\") {\n            return { Authorization: `Bearer ${user.accessToken}` };\n        }\n        else if (tokenType === \"refresh\") {\n            return { Authorization: `Bearer ${user.refreshToken}` };\n        }\n        else {\n            throw new Error(`Unexpected token type (${tokenType})`);\n        }\n    }\n    /**\n     * @param body The body string or object passed from a request.\n     * @returns An object optionally specifying the \"Content-Type\" header.\n     */\n    static buildBody(body) {\n        if (!body) {\n            return;\n        }\n        else if (typeof body === \"object\" && body !== null) {\n            return JSON.stringify(serialize(body));\n        }\n        else if (typeof body === \"string\") {\n            return body;\n        }\n        else {\n            console.log(\"body is\", body);\n            throw new Error(\"Unexpected type of body\");\n        }\n    }\n    /**\n     * @param body The body string or object passed from a request.\n     * @returns An object optionally specifying the \"Content-Type\" header.\n     */\n    static buildJsonHeader(body) {\n        if (body && body.length > 0) {\n            return { \"Content-Type\": \"application/json\" };\n        }\n        else {\n            return {};\n        }\n    }\n    clone(config) {\n        return new Fetcher({\n            appId: this.appId,\n            transport: this.transport,\n            userContext: this.userContext,\n            locationUrlContext: this.locationUrlContext,\n            ...config,\n        });\n    }\n    /**\n     * Fetch a network resource as an authenticated user.\n     *\n     * @param request The request which should be sent to the server.\n     * @returns The response from the server.\n     */\n    async fetch(request) {\n        const { path, url, tokenType = \"access\", user = this.userContext.currentUser, ...restOfRequest } = request;\n        if (typeof path === \"string\" && typeof url === \"string\") {\n            throw new Error(\"Use of 'url' and 'path' mutually exclusive\");\n        }\n        else if (typeof path === \"string\") {\n            // Derive the URL\n            const url = (await this.locationUrlContext.locationUrl) + path;\n            return this.fetch({ ...request, path: undefined, url });\n        }\n        else if (typeof url === \"string\") {\n            const response = await this.transport.fetch({\n                ...restOfRequest,\n                url,\n                headers: {\n                    ...Fetcher.buildAuthorizationHeader(user, tokenType),\n                    ...request.headers,\n                },\n            });\n            if (response.ok) {\n                return response;\n            }\n            else if (user && response.status === 401 && tokenType === \"access\") {\n                // If the access token has expired, it would help refreshing it\n                await user.refreshAccessToken();\n                // Retry with the specific user, since the currentUser might have changed.\n                return this.fetch({ ...request, user });\n            }\n            else {\n                if (user && response.status === 401 && tokenType === \"refresh\") {\n                    // A 401 error while using the refresh token indicates the token has an issue.\n                    // Reset the tokens to prevent a lock.\n                    user.accessToken = null;\n                    user.refreshToken = null;\n                }\n                // Throw an error with a message extracted from the body\n                throw await MongoDBRealmError.fromRequestAndResponse(request, response);\n            }\n        }\n        else {\n            throw new Error(\"Expected either 'url' or 'path'\");\n        }\n    }\n    /**\n     * Fetch a network resource as an authenticated user and parse the result as extended JSON.\n     *\n     * @param request The request which should be sent to the server.\n     * @returns The response from the server, parsed as extended JSON.\n     */\n    async fetchJSON(request) {\n        const { body } = request;\n        const serializedBody = Fetcher.buildBody(body);\n        const contentTypeHeaders = Fetcher.buildJsonHeader(serializedBody);\n        const response = await this.fetch({\n            ...request,\n            body: serializedBody,\n            headers: {\n                Accept: \"application/json\",\n                ...contentTypeHeaders,\n                ...request.headers,\n            },\n        });\n        const contentType = response.headers.get(\"content-type\");\n        if (contentType === null || contentType === void 0 ? void 0 : contentType.startsWith(\"application/json\")) {\n            const responseBody = await response.json();\n            return deserialize(responseBody);\n        }\n        else if (contentType === null) {\n            return null;\n        }\n        else {\n            throw new Error(`Expected JSON response, got \"${contentType}\"`);\n        }\n    }\n    /**\n     * Fetch an \"event-stream\" resource as an authenticated user.\n     *\n     * @param request The request which should be sent to the server.\n     * @returns An async iterator over the response body.\n     */\n    async fetchStream(request) {\n        const { body } = await this.fetch({\n            ...request,\n            headers: {\n                Accept: \"text/event-stream\",\n                ...request.headers,\n            },\n        });\n        return asyncIteratorFromResponseBody(body);\n    }\n    /**\n     * @returns The path of the app route.\n     */\n    get appRoute() {\n        return routes.api().app(this.appId);\n    }\n    /**\n     * @returns A promise of the location URL of the app.\n     */\n    get locationUrl() {\n        return this.locationUrlContext.locationUrl;\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n/**\n * The key in a storage on which the device id is stored.\n */\nconst DEVICE_ID_STORAGE_KEY$1 = \"deviceId\";\nvar DeviceFields;\n(function (DeviceFields) {\n    DeviceFields[\"DEVICE_ID\"] = \"deviceId\";\n    DeviceFields[\"APP_ID\"] = \"appId\";\n    DeviceFields[\"APP_VERSION\"] = \"appVersion\";\n    DeviceFields[\"PLATFORM\"] = \"platform\";\n    DeviceFields[\"PLATFORM_VERSION\"] = \"platformVersion\";\n    DeviceFields[\"SDK_VERSION\"] = \"sdkVersion\";\n})(DeviceFields || (DeviceFields = {}));\n/**\n * Information describing the device, app and SDK.\n */\nclass DeviceInformation {\n    /**\n     * @param params Construct the device information from these parameters.\n     * @param params.appId A user-defined application id.\n     * @param params.appVersion A user-defined application version.\n     * @param params.deviceId An unique id for the end-users device.\n     */\n    constructor({ appId, appVersion, deviceId }) {\n        /**\n         * The version of the Realm Web SDK (constant provided by Rollup).\n         */\n        this.sdkVersion = \"1.5.1\";\n        const environment = getEnvironment();\n        this.platform = environment.platform;\n        this.platformVersion = environment.platformVersion;\n        this.appId = appId;\n        this.appVersion = appVersion;\n        this.deviceId = deviceId;\n    }\n    /**\n     * @returns An base64 URI encoded representation of the device information.\n     */\n    encode() {\n        const obj = removeKeysWithUndefinedValues(this);\n        return gBase64.encode(JSON.stringify(obj));\n    }\n    /**\n     * @returns The defaults\n     */\n    toJSON() {\n        return removeKeysWithUndefinedValues(this);\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\n/**\n * Default base url to prefix all requests if no baseUrl is specified in the configuration.\n */\nconst DEFAULT_BASE_URL = \"https://stitch.mongodb.com\";\n/**\n * MongoDB Realm App\n */\nclass App {\n    /**\n     * Construct a Realm App, either from the Realm App id visible from the MongoDB Realm UI or a configuration.\n     *\n     * @param idOrConfiguration The Realm App id or a configuration to use for this app.\n     */\n    constructor(idOrConfiguration) {\n        /**\n         * An array of active and logged-out users.\n         * Elements in the beginning of the array is considered more recent than the later elements.\n         */\n        this.users = [];\n        /**\n         * A promise resolving to the App's location url.\n         */\n        this._locationUrl = null;\n        // If the argument is a string, convert it to a simple configuration object.\n        const configuration = typeof idOrConfiguration === \"string\" ? { id: idOrConfiguration } : idOrConfiguration;\n        // Initialize properties from the configuration\n        if (typeof configuration === \"object\" && typeof configuration.id === \"string\") {\n            this.id = configuration.id;\n        }\n        else {\n            throw new Error(\"Missing a MongoDB Realm app-id\");\n        }\n        this.baseUrl = configuration.baseUrl || DEFAULT_BASE_URL;\n        if (configuration.skipLocationRequest) {\n            // Use the base url directly, instead of requesting a location URL from the server\n            this._locationUrl = Promise.resolve(this.baseUrl);\n        }\n        this.localApp = configuration.app;\n        const { storage, transport = new DefaultNetworkTransport() } = configuration;\n        // Construct a fetcher wrapping the network transport\n        this.fetcher = new Fetcher({\n            appId: this.id,\n            userContext: this,\n            locationUrlContext: this,\n            transport,\n        });\n        // Construct the auth providers\n        this.emailPasswordAuth = new EmailPasswordAuth(this.fetcher);\n        // Construct the storage\n        const baseStorage = storage || getEnvironment().defaultStorage;\n        this.storage = new AppStorage(baseStorage, this.id);\n        this.authenticator = new Authenticator(this.fetcher, baseStorage, () => this.deviceInformation);\n        // Hydrate the app state from storage\n        try {\n            this.hydrate();\n        }\n        catch (err) {\n            // The storage was corrupted\n            this.storage.clear();\n            // A failed hydration shouldn't throw and break the app experience\n            // Since this is \"just\" persisted state that unfortunately got corrupted or partially lost\n            console.warn(\"Realm app hydration failed:\", err.message);\n        }\n    }\n    /**\n     * Get or create a singleton Realm App from an id.\n     * Calling this function multiple times with the same id will return the same instance.\n     *\n     * @param id The Realm App id visible from the MongoDB Realm UI or a configuration.\n     * @returns The Realm App instance.\n     */\n    static getApp(id) {\n        if (id in App.appCache) {\n            return App.appCache[id];\n        }\n        else {\n            const instance = new App(id);\n            App.appCache[id] = instance;\n            return instance;\n        }\n    }\n    /**\n     * Switch user.\n     *\n     * @param nextUser The user or id of the user to switch to.\n     */\n    switchUser(nextUser) {\n        const index = this.users.findIndex((u) => u === nextUser);\n        if (index === -1) {\n            throw new Error(\"The user was never logged into this app\");\n        }\n        // Remove the user from the stack\n        const [user] = this.users.splice(index, 1);\n        // Insert the user in the beginning of the stack\n        this.users.unshift(user);\n    }\n    /**\n     * Log in a user.\n     *\n     * @param credentials Credentials to use when logging in.\n     * @param fetchProfile Should the users profile be fetched? (default: true)\n     * @returns A promise resolving to the newly logged in user.\n     */\n    async logIn(credentials, fetchProfile = true) {\n        const response = await this.authenticator.authenticate(credentials);\n        const user = this.createOrUpdateUser(response, credentials.providerType);\n        // Let's ensure this will be the current user, in case the user object was reused.\n        this.switchUser(user);\n        // If neeeded, fetch and set the profile on the user\n        if (fetchProfile) {\n            await user.refreshProfile();\n        }\n        // Persist the user id in the storage,\n        // merging to avoid overriding logins from other apps using the same underlying storage\n        this.storage.setUserIds(this.users.map((u) => u.id), true);\n        // Read out and store the device id from the server\n        const deviceId = response.deviceId;\n        if (deviceId && deviceId !== \"000000000000000000000000\") {\n            this.storage.set(DEVICE_ID_STORAGE_KEY$1, deviceId);\n        }\n        // Return the user\n        return user;\n    }\n    /**\n     * @inheritdoc\n     */\n    async removeUser(user) {\n        // Remove the user from the list of users\n        const index = this.users.findIndex((u) => u === user);\n        if (index === -1) {\n            throw new Error(\"The user was never logged into this app\");\n        }\n        this.users.splice(index, 1);\n        // Log out the user - this removes access and refresh tokens from storage\n        await user.logOut();\n        // Remove the users profile from storage\n        this.storage.remove(`user(${user.id}):profile`);\n        // Remove the user from the storage\n        this.storage.removeUserId(user.id);\n    }\n    /**\n     * The currently active user (or null if no active users exists).\n     *\n     * @returns the currently active user or null.\n     */\n    get currentUser() {\n        const activeUsers = this.users.filter((user) => user.state === UserState.Active);\n        if (activeUsers.length === 0) {\n            return null;\n        }\n        else {\n            // Current user is the top of the stack\n            return activeUsers[0];\n        }\n    }\n    /**\n     * All active and logged-out users:\n     *  - First in the list are active users (ordered by most recent call to switchUser or login)\n     *  - Followed by logged out users (also ordered by most recent call to switchUser or login).\n     *\n     * @returns An array of users active or loggedout users (current user being the first).\n     */\n    get allUsers() {\n        // Returning a freezed copy of the list of users to prevent outside changes\n        return Object.fromEntries(this.users.map((user) => [user.id, user]));\n    }\n    /**\n     * @returns A promise of the app URL, with the app location resolved.\n     */\n    get locationUrl() {\n        if (!this._locationUrl) {\n            const path = routes.api().app(this.id).location().path;\n            this._locationUrl = this.fetcher\n                .fetchJSON({\n                method: \"GET\",\n                url: this.baseUrl + path,\n                tokenType: \"none\",\n            })\n                .then((body) => {\n                if (typeof body !== \"object\") {\n                    throw new Error(\"Expected response body be an object\");\n                }\n                else {\n                    return body;\n                }\n            })\n                .then(({ hostname }) => {\n                if (typeof hostname !== \"string\") {\n                    throw new Error(\"Expected response to contain a 'hostname'\");\n                }\n                else {\n                    return hostname;\n                }\n            })\n                .catch((err) => {\n                // Reset the location to allow another request to fetch again.\n                this._locationUrl = null;\n                throw err;\n            });\n        }\n        return this._locationUrl;\n    }\n    /**\n     * @returns Information about the current device, sent to the server when authenticating.\n     */\n    get deviceInformation() {\n        const deviceIdStr = this.storage.getDeviceId();\n        const deviceId = typeof deviceIdStr === \"string\" && deviceIdStr !== \"000000000000000000000000\"\n            ? new ObjectId(deviceIdStr)\n            : undefined;\n        return new DeviceInformation({\n            appId: this.localApp ? this.localApp.name : undefined,\n            appVersion: this.localApp ? this.localApp.version : undefined,\n            deviceId,\n        });\n    }\n    /**\n     * Create (and store) a new user or update an existing user's access and refresh tokens.\n     * This helps de-duplicating users in the list of users known to the app.\n     *\n     * @param response A response from the Authenticator.\n     * @param providerType The type of the authentication provider used.\n     * @returns A new or an existing user.\n     */\n    createOrUpdateUser(response, providerType) {\n        const existingUser = this.users.find((u) => u.id === response.userId);\n        if (existingUser) {\n            // Update the users access and refresh tokens\n            existingUser.accessToken = response.accessToken;\n            existingUser.refreshToken = response.refreshToken;\n            return existingUser;\n        }\n        else {\n            // Create and store a new user\n            if (!response.refreshToken) {\n                throw new Error(\"No refresh token in response from server\");\n            }\n            const user = new User({\n                app: this,\n                id: response.userId,\n                accessToken: response.accessToken,\n                refreshToken: response.refreshToken,\n                providerType,\n            });\n            this.users.unshift(user);\n            return user;\n        }\n    }\n    /**\n     * Restores the state of the app (active and logged-out users) from the storage\n     */\n    hydrate() {\n        const userIds = this.storage.getUserIds();\n        this.users = userIds.map((id) => new User({ app: this, id }));\n    }\n}\n/**\n * A map of app instances returned from calling getApp.\n */\nApp.appCache = {};\n/**\n * Instances of this class can be passed to the `app.logIn` method to authenticate an end-user.\n */\nApp.Credentials = Credentials;\n\n////////////////////////////////////////////////////////////////////////////\n/**\n * Get or create a singleton Realm App from an id.\n * Calling this function multiple times with the same id will return the same instance.\n *\n * @param id The Realm App id visible from the MongoDB Realm UI or a configuration.\n * @returns The Realm App instance.\n */\nfunction getApp(id) {\n    return App.getApp(id);\n}\n\n////////////////////////////////////////////////////////////////////////////\n/**\n * In-memory storage that will not be persisted.\n */\nclass LocalStorage {\n    /**\n     * Constructs a LocalStorage using the global window.\n     */\n    constructor() {\n        if (typeof globalThis.localStorage === \"object\") {\n            this.global = globalThis;\n        }\n        else {\n            throw new Error(\"Cannot use LocalStorage without a global localStorage object\");\n        }\n    }\n    /** @inheritdoc */\n    get(key) {\n        return this.global.localStorage.getItem(key);\n    }\n    /** @inheritdoc */\n    set(key, value) {\n        return this.global.localStorage.setItem(key, value);\n    }\n    /** @inheritdoc */\n    remove(key) {\n        return this.global.localStorage.removeItem(key);\n    }\n    /** @inheritdoc */\n    prefix(keyPart) {\n        return new PrefixedStorage(this, keyPart);\n    }\n    /** @inheritdoc */\n    clear(prefix) {\n        const keys = [];\n        // Iterate all keys to find the once have a matching prefix.\n        for (let i = 0; i < this.global.localStorage.length; i++) {\n            const key = this.global.localStorage.key(i);\n            if (key && (!prefix || key.startsWith(prefix))) {\n                keys.push(key);\n            }\n        }\n        // Remove the items in a seperate loop to avoid updating while iterating.\n        for (const key of keys) {\n            this.global.localStorage.removeItem(key);\n        }\n    }\n    /** @inheritdoc */\n    addListener(listener) {\n        return this.global.addEventListener(\"storage\", listener);\n    }\n    /** @inheritdoc */\n    removeListener(listener) {\n        return this.global.removeEventListener(\"storage\", listener);\n    }\n}\n\n////////////////////////////////////////////////////////////////////////////\nconst browser = detect();\nconst DefaultStorage = \"localStorage\" in globalThis ? LocalStorage : MemoryStorage;\n/**\n * Attempt to use the browser to open a window\n *\n * @param url The url to open a window to.\n * @returns Then newly create window.\n */\nfunction openWindow(url) {\n    if (typeof globalThis.open === \"function\") {\n        return globalThis.open(url);\n    }\n    else {\n        console.log(`Please open ${url}`);\n        return null;\n    }\n}\nconst environment$1 = {\n    defaultStorage: new DefaultStorage().prefix(\"realm-web\"),\n    openWindow,\n    platform: (browser === null || browser === void 0 ? void 0 : browser.name) || \"web\",\n    platformVersion: (browser === null || browser === void 0 ? void 0 : browser.version) || \"0.0.0\",\n    TextDecoder,\n};\nsetEnvironment(environment$1);\n/**\n * Handle an OAuth 2.0 redirect.\n *\n * @param location An optional location to use (defaults to the windows current location).\n * @param storage Optional storage used to save any results from the location.\n */\nfunction handleAuthRedirect(location = globalThis.location, storage = environment$1.defaultStorage) {\n    try {\n        const queryString = location.hash.substr(1); // Strip the initial # from the hash\n        OAuth2Helper.handleRedirect(queryString, storage);\n    }\n    catch (err) {\n        // Ensure calling this never throws: It should not interrupt a users flow.\n        console.warn(err);\n    }\n}\n\nexport { App, Credentials, DEFAULT_BASE_URL, LocalStorage, MongoDBRealmError, User, UserState, UserType$1 as UserType, getApp, getEnvironment, handleAuthRedirect, setEnvironment };\n"]},"metadata":{},"sourceType":"module"}